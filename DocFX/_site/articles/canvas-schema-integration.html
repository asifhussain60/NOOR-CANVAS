<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Canvas Schema Data Flows and Integration </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Canvas Schema Data Flows and Integration ">
    
    
      <link rel="shortcut icon" href="../favicon.ico">
      <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../styles/docfx.css">
      <link rel="stylesheet" href="../styles/main.css">
      <meta property="docfx:navrel" content="../toc.html">
      <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="canvas-schema-data-flows-and-integration">Canvas Schema Data Flows and Integration</h1>

<h2 id="data-flow-architecture">Data Flow Architecture</h2>
<p>The canvas schema operates within a <strong>dual-schema architecture</strong> where application data flows through the <code>canvas</code> schema while integrating with Islamic content from the <code>dbo</code> schema.</p>
<h3 id="core-data-flow-patterns">Core Data Flow Patterns</h3>
<h4 id="-session-lifecycle-flow">ðŸŽ¯ Session Lifecycle Flow</h4>
<pre><code class="lang-mermaid">graph TD
    A[Host Creates Session] --&gt; B[Generate SecureTokens]
    B --&gt; C[Session in 'Pending' Status]
    C --&gt; D[Users Register via UserToken]  
    D --&gt; E[Session Starts - Status 'Active']
    E --&gt; F[Real-time Activities]
    F --&gt; G[Session Ends - Status 'Completed']
    G --&gt; H[Data Retention &amp; Analytics]
</code></pre>
<h4 id="-user-registration-flow">ðŸ‘¥ User Registration Flow</h4>
<pre><code class="lang-mermaid">graph TD
    A[User Accesses UserToken URL] --&gt; B[Token Validation]
    B --&gt; C{Valid Token?}
    C --&gt;|Yes| D[Load User Registration Form]
    C --&gt;|No| E[Access Denied]
    D --&gt; F[User Submits Registration]
    F --&gt; G[Create/Update User Record]
    G --&gt; H[Create Registration Record]
    H --&gt; I[Add to SessionParticipants]
    I --&gt; J[SignalR Group Join]
</code></pre>
<h2 id="cross-schema-integration">Cross-Schema Integration</h2>
<h3 id="session-content-linking">Session Content Linking</h3>
<p>The integration between canvas sessions and Islamic content follows a <strong>bridge pattern</strong>:</p>
<pre><code class="lang-sql">-- Primary relationship
canvas.Sessions.SessionId = canvas.SecureTokens.SessionId

-- Cross-schema bridge  
canvas.Sessions.SessionId = dbo.Sessions.SessionID
canvas.Sessions.KSessionsId = dbo.Sessions.SessionID  -- Optional explicit link
</code></pre>
<h3 id="content-access-pattern">Content Access Pattern</h3>
<pre><code class="lang-sql">-- Typical content access query
SELECT 
    cs.Title as SessionTitle,
    cs.Status,
    ds.SessionName as IslamicContentTitle,
    st.Transcript as ContentText,
    cs.ParticipantCount
FROM canvas.Sessions cs
INNER JOIN dbo.Sessions ds ON cs.SessionId = ds.SessionID
LEFT JOIN dbo.SessionTranscripts st ON ds.SessionID = st.SessionID  
WHERE cs.Status = 'Active'
</code></pre>
<h2 id="real-time-data-flows">Real-time Data Flows</h2>
<h3 id="signalr-hub-integration">SignalR Hub Integration</h3>
<h4 id="sessionhub-data-flow">SessionHub Data Flow</h4>
<pre><code class="lang-csharp">// Participant join flow
1. User validates token â†’ canvas.SecureTokens
2. Create participant record â†’ canvas.SessionParticipants  
3. Join SignalR group â†’ Group name: &quot;Session_{sessionId}&quot;
4. Broadcast update â†’ All group members
5. Update participant count â†’ canvas.Sessions.ParticipantCount
</code></pre>
<h4 id="annotationhub-data-flow">AnnotationHub Data Flow</h4>
<pre><code class="lang-csharp">// Real-time annotation flow
1. User creates annotation â†’ canvas.Annotations
2. Broadcast to session group â†’ SignalR
3. Update annotation data â†’ JSON in AnnotationData field
4. Audit log entry â†’ canvas.AuditLog
</code></pre>
<h4 id="qahub-data-flow">QAHub Data Flow</h4>
<pre><code class="lang-csharp">// Question &amp; Answer flow
1. Submit question â†’ canvas.Questions (Status: 'Pending')
2. Community voting â†’ canvas.QuestionVotes
3. Update vote count â†’ canvas.Questions.VoteCount  
4. Host answers â†’ canvas.QuestionAnswers
5. Mark answered â†’ canvas.Questions.AnsweredAt
6. Broadcast updates â†’ SignalR to all participants
</code></pre>
<h2 id="data-persistence-patterns">Data Persistence Patterns</h2>
<h3 id="entity-framework-integration">Entity Framework Integration</h3>
<p>The canvas schema integrates with Entity Framework Core through:</p>
<h4 id="dbcontext-configuration">DbContext Configuration</h4>
<pre><code class="lang-csharp">public class CanvasDbContext : DbContext
{
    // Canvas schema entities
    public DbSet&lt;Session&gt; Sessions { get; set; }
    public DbSet&lt;User&gt; Users { get; set; }
    public DbSet&lt;SecureToken&gt; SecureTokens { get; set; }
    public DbSet&lt;Question&gt; Questions { get; set; }
    public DbSet&lt;Annotation&gt; Annotations { get; set; }
    public DbSet&lt;SharedAsset&gt; SharedAssets { get; set; }
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Canvas schema specification
        modelBuilder.HasDefaultSchema(&quot;canvas&quot;);
        
        // Cross-schema relationships
        modelBuilder.Entity&lt;Session&gt;()
            .HasOne&lt;DboSession&gt;()
            .WithOne()
            .HasForeignKey&lt;Session&gt;(s =&gt; s.SessionId);
    }
}
</code></pre>
<h3 id="migration-strategy">Migration Strategy</h3>
<pre><code class="lang-csharp">// Entity Framework migrations respect schema boundaries
public partial class InitialCanvasSchema : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.EnsureSchema(&quot;canvas&quot;);
        
        // Create canvas tables with dbo references
        migrationBuilder.CreateTable(
            name: &quot;Sessions&quot;,
            schema: &quot;canvas&quot;,
            columns: table =&gt; new
            {
                SessionId = table.Column&lt;long&gt;(nullable: false),
                // ... other columns
            });
            
        // Foreign key to dbo schema
        migrationBuilder.AddForeignKey(
            name: &quot;FK_Sessions_dbo_Sessions&quot;,
            schema: &quot;canvas&quot;,
            table: &quot;Sessions&quot;, 
            column: &quot;SessionId&quot;,
            principalSchema: &quot;dbo&quot;,
            principalTable: &quot;Sessions&quot;,
            principalColumn: &quot;SessionID&quot;);
    }
}
</code></pre>
<h2 id="data-flow-security">Data Flow Security</h2>
<h3 id="token-based-access-control">Token-Based Access Control</h3>
<pre><code class="lang-sql">-- Token validation flow
DECLARE @Token NVARCHAR(8) = 'USER123A'
DECLARE @SessionId BIGINT

-- Validate and extract session
SELECT @SessionId = SessionId 
FROM canvas.SecureTokens
WHERE (HostToken = @Token OR UserToken = @Token)
AND IsActive = 1 
AND ExpiresAt &gt; GETUTCDATE()

-- Update access tracking
UPDATE canvas.SecureTokens 
SET AccessCount = AccessCount + 1,
    LastAccessedAt = GETUTCDATE()
WHERE (HostToken = @Token OR UserToken = @Token)
</code></pre>
<h3 id="audit-trail-flow">Audit Trail Flow</h3>
<pre><code class="lang-sql">-- Comprehensive audit logging
INSERT INTO canvas.AuditLog (At, Actor, SessionId, UserId, Action, Details)
VALUES (
    GETUTCDATE(),
    'User:' + @UserGuid,
    @SessionId, 
    @UserId,
    'QUESTION_SUBMITTED',
    JSON_OBJECT(
        'questionText', @QuestionText,
        'ipAddress', @UserIP,
        'userAgent', @UserAgent
    )
)
</code></pre>
<h2 id="asset-management-flow">Asset Management Flow</h2>
<h3 id="sharedassets-selector-system">SharedAssets Selector System</h3>
<p>The revolutionary <strong>selector-based asset detection</strong> system:</p>
<pre><code class="lang-javascript">// Frontend: Asset detection via selectors
const assetContainers = [
    '.noor-share-container[data-share-id=&quot;1&quot;]',
    '.noor-share-container[data-share-id=&quot;2&quot;]',  
    // ... 14 total selectors
];

// Detect shareable content
assetContainers.forEach((selector, index) =&gt; {
    const element = document.querySelector(selector);
    if (element &amp;&amp; element.hasContent()) {
        registerSharedAsset(sessionId, selector, index, element.getMetadata());
    }
});
</code></pre>
<pre><code class="lang-sql">-- Backend: Store asset references (not content)
INSERT INTO canvas.SharedAssets (
    SessionId, 
    SharedAt, 
    AssetType, 
    AssetSelector,        -- CSS selector instead of HTML blob
    AssetPosition, 
    AssetMetadata         -- JSON metadata
) VALUES (
    @SessionId,
    GETUTCDATE(),
    'SHARE',
    '.noor-share-container[data-share-id=&quot;3&quot;]',  -- 90% storage reduction
    3,
    JSON_OBJECT('title', @Title, 'description', @Description)
)
</code></pre>
<h2 id="performance-data-flows">Performance Data Flows</h2>
<h3 id="participant-count-updates">Participant Count Updates</h3>
<pre><code class="lang-sql">-- Real-time participant counting
WITH ActiveParticipants AS (
    SELECT SessionId, COUNT(*) as ActiveCount
    FROM canvas.SessionParticipants  
    WHERE LeftAt IS NULL
    GROUP BY SessionId
)
UPDATE s SET ParticipantCount = ap.ActiveCount
FROM canvas.Sessions s
INNER JOIN ActiveParticipants ap ON s.SessionId = ap.SessionId
</code></pre>
<h3 id="question-priority-calculation">Question Priority Calculation</h3>
<pre><code class="lang-sql">-- Dynamic question prioritization 
UPDATE q SET VoteCount = v.TotalVotes
FROM canvas.Questions q
INNER JOIN (
    SELECT QuestionId, SUM(VoteValue) as TotalVotes
    FROM canvas.QuestionVotes
    GROUP BY QuestionId  
) v ON q.QuestionId = v.QuestionId
</code></pre>
<h2 id="backup-and-recovery-flows">Backup and Recovery Flows</h2>
<h3 id="schema-isolated-backups">Schema-Isolated Backups</h3>
<pre><code class="lang-sql">-- Canvas schema backup (application data only)
BACKUP DATABASE KSESSIONS_DEV 
TO DISK = 'C:\Backups\CanvasSchema_20250920.bak'
WITH 
    PARTIAL,
    FILEGROUP = 'PRIMARY',
    NAME = 'Canvas Schema Application Data Backup'
</code></pre>
<h3 id="selective-restore-scenarios">Selective Restore Scenarios</h3>
<pre><code class="lang-sql">-- Restore strategy preserves Islamic content
-- 1. Restore dbo schema (Islamic content) 
-- 2. Apply canvas schema migrations
-- 3. Restore canvas application data
-- 4. Validate cross-schema relationships
</code></pre>
<h2 id="integration-testing-flows">Integration Testing Flows</h2>
<h3 id="database-state-management">Database State Management</h3>
<pre><code class="lang-sql">-- Test setup: Clean canvas, preserve dbo
EXEC canvas.StartFresh 
    @ConfirmationToken = 'NOOR_CANVAS_START_FRESH',
    @DryRun = 0

-- Verify isolation
SELECT 
    (SELECT COUNT(*) FROM canvas.Sessions) as CanvasSessions,
    (SELECT COUNT(*) FROM dbo.Sessions) as IslamicSessions,
    (SELECT COUNT(*) FROM dbo.Categories) as IslamicCategories
-- Expected: 0, &gt;0, &gt;0
</code></pre>
<h3 id="end-to-end-test-flow">End-to-End Test Flow</h3>
<pre><code class="lang-csharp">[Test]
public async Task SessionLifecycle_EndToEnd()
{
    // 1. Create session â†’ canvas.Sessions
    var sessionId = await CreateTestSession();
    
    // 2. Generate tokens â†’ canvas.SecureTokens  
    var tokens = await GenerateSessionTokens(sessionId);
    
    // 3. User registration â†’ canvas.Users, canvas.Registrations
    var userId = await RegisterTestUser(tokens.UserToken);
    
    // 4. Submit questions â†’ canvas.Questions
    await SubmitTestQuestions(sessionId, userId);
    
    // 5. Create annotations â†’ canvas.Annotations
    await CreateTestAnnotations(sessionId);
    
    // 6. Share assets â†’ canvas.SharedAssets
    await ShareTestAssets(sessionId);
    
    // 7. Verify data integrity
    await VerifySessionState(sessionId);
    
    // 8. Cleanup â†’ canvas.StartFresh
    await CleanupTestData();
}
</code></pre>
<hr>
<h2 id="data-flow-monitoring">Data Flow Monitoring</h2>
<h3 id="real-time-metrics">Real-time Metrics</h3>
<pre><code class="lang-sql">-- Session activity dashboard
SELECT 
    s.SessionId,
    s.Title,
    s.Status,
    s.ParticipantCount,
    COUNT(q.QuestionId) as QuestionCount,
    COUNT(a.AnnotationId) as AnnotationCount,
    COUNT(sa.AssetId) as SharedAssetCount,
    MAX(sp.JoinedAt) as LastJoinTime
FROM canvas.Sessions s
LEFT JOIN canvas.Questions q ON s.SessionId = q.SessionId
LEFT JOIN canvas.Annotations a ON s.SessionId = a.SessionId  
LEFT JOIN canvas.SharedAssets sa ON s.SessionId = sa.SessionId
LEFT JOIN canvas.SessionParticipants sp ON s.SessionId = sp.SessionId
WHERE s.Status = 'Active'
GROUP BY s.SessionId, s.Title, s.Status, s.ParticipantCount
</code></pre>
<h3 id="performance-tracking">Performance Tracking</h3>
<pre><code class="lang-sql">-- Query performance monitoring
SELECT 
    qt.query_text_id,
    qt.query_sql_text,
    rs.count_executions,
    rs.avg_duration,
    rs.avg_cpu_time,
    rs.avg_logical_io_reads
FROM sys.query_store_query_text qt
INNER JOIN sys.query_store_query q ON qt.query_text_id = q.query_text_id
INNER JOIN sys.query_store_runtime_stats rs ON q.query_id = rs.query_id
WHERE qt.query_sql_text LIKE '%canvas%'
ORDER BY rs.avg_duration DESC
</code></pre>
<hr>
<p><strong>Integration Summary</strong>: The canvas schema's data flows are optimized for real-time Islamic learning experiences while maintaining clear separation from historical Islamic content. The <strong>selector-based asset system</strong> and <strong>SignalR integration</strong> enable sub-3-second participant updates and efficient content sharing at scale.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/asifhussain60/NOOR-CANVAS/blob/master/DocFX/articles/canvas-schema-integration.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
