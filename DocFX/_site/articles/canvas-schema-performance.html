<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Canvas Schema Indexes and Performance </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Canvas Schema Indexes and Performance ">
    
    
      <link rel="shortcut icon" href="../favicon.ico">
      <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../styles/docfx.css">
      <link rel="stylesheet" href="../styles/main.css">
      <meta property="docfx:navrel" content="../toc.html">
      <meta property="docfx:tocrel" content="toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="canvas-schema-indexes-and-performance">Canvas Schema Indexes and Performance</h1>

<h2 id="index-strategy">Index Strategy</h2>
<p>The canvas schema employs a <strong>performance-first indexing strategy</strong> designed to support the real-time, high-concurrency nature of Islamic learning sessions.</p>
<h3 id="core-indexing-principles">Core Indexing Principles</h3>
<h4 id="-query-pattern-optimization">ðŸ“Š Query Pattern Optimization</h4>
<ul>
<li><strong>Session-Centric Queries</strong>: Most operations filter by <code>SessionId</code></li>
<li><strong>Temporal Access</strong>: Heavy use of datetime filtering for active sessions</li>
<li><strong>User Activity</strong>: Frequent user-based queries for participation tracking</li>
<li><strong>Real-time Updates</strong>: Support for high-frequency INSERT/UPDATE operations</li>
</ul>
<h4 id="-signalr-hub-performance">ðŸŽ¯ SignalR Hub Performance</h4>
<ul>
<li><strong>Group Membership</strong>: Fast participant lookups for SignalR groups</li>
<li><strong>Message Broadcasting</strong>: Efficient session participant enumeration</li>
<li><strong>Connection Management</strong>: Quick online/offline status updates</li>
</ul>
<h2 id="primary-indexes-clustered">Primary Indexes (Clustered)</h2>
<h3 id="sessions-table">Sessions Table</h3>
<pre><code class="lang-sql">-- Clustered on SessionId for optimal range queries
CREATE CLUSTERED INDEX [PK_Sessions] ON [canvas].[Sessions] ([SessionId])
</code></pre>
<p><strong>Rationale</strong>: Sessions are accessed by ID for most operations, providing optimal seek performance for session-specific queries.</p>
<h3 id="users-table">Users Table</h3>
<pre><code class="lang-sql">-- Clustered on UserId (GUID) for user-specific operations
CREATE CLUSTERED INDEX [PK_Users] ON [canvas].[Users] ([UserId])
</code></pre>
<p><strong>Rationale</strong>: User operations require fast GUID-based lookups for authentication and profile management.</p>
<h3 id="securetokens-table">SecureTokens Table</h3>
<pre><code class="lang-sql">-- Clustered on auto-increment Id for insertion performance
CREATE CLUSTERED INDEX [PK_SecureTokens] ON [canvas].[SecureTokens] ([Id])
</code></pre>
<p><strong>Rationale</strong>: Token validation requires sequential access patterns; auto-increment clustering optimizes INSERT performance.</p>
<h2 id="secondary-indexes-nonclustered">Secondary Indexes (Nonclustered)</h2>
<h3 id="performance-critical-indexes">Performance-Critical Indexes</h3>
<h4 id="sharedassets-performance-index">SharedAssets Performance Index</h4>
<pre><code class="lang-sql">-- CONFIRMED: IX_SharedAssets_TypeSelector exists in production
CREATE NONCLUSTERED INDEX [IX_SharedAssets_TypeSelector] 
ON [canvas].[SharedAssets] ([AssetType], [AssetSelector])
</code></pre>
<p><strong>Performance Impact</strong>:</p>
<ul>
<li><strong>90% Storage Reduction</strong>: Enables selector-based asset detection vs HTML blob storage</li>
<li><strong>Sub-Second Queries</strong>: Asset type filtering with CSS selector matching</li>
<li><strong>Cache Efficiency</strong>: Reduces memory footprint for asset lookups</li>
</ul>
<h4 id="session-activity-indexes">Session Activity Indexes</h4>
<pre><code class="lang-sql">-- Session participant lookups
CREATE NONCLUSTERED INDEX [IX_SessionParticipants_SessionId] 
ON [canvas].[SessionParticipants] ([SessionId])
INCLUDE ([UserId], [DisplayName], [JoinedAt])

-- Active session filtering  
CREATE NONCLUSTERED INDEX [IX_Sessions_Status_CreatedAt] 
ON [canvas].[Sessions] ([Status], [CreatedAt])
INCLUDE ([Title], [ParticipantCount])

-- Token validation (critical path)
CREATE NONCLUSTERED INDEX [IX_SecureTokens_Tokens_Active] 
ON [canvas].[SecureTokens] ([HostToken], [UserToken], [IsActive])
INCLUDE ([SessionId], [ExpiresAt])
</code></pre>
<h4 id="qa-system-indexes">Q&amp;A System Indexes</h4>
<pre><code class="lang-sql">-- Question prioritization by votes
CREATE NONCLUSTERED INDEX [IX_Questions_SessionId_VoteCount] 
ON [canvas].[Questions] ([SessionId], [VoteCount] DESC)
INCLUDE ([QuestionText], [QueuedAt], [Status])

-- Prevent duplicate voting
CREATE UNIQUE NONCLUSTERED INDEX [IX_QuestionVotes_Unique] 
ON [canvas].[QuestionVotes] ([QuestionId], [UserId])

-- Question answers by recency
CREATE NONCLUSTERED INDEX [IX_QuestionAnswers_QuestionId_PostedAt] 
ON [canvas].[QuestionAnswers] ([QuestionId], [PostedAt] DESC)
</code></pre>
<h2 id="query-performance-analysis">Query Performance Analysis</h2>
<h3 id="session-management-queries">Session Management Queries</h3>
<h4 id="active-sessions-lookup">Active Sessions Lookup</h4>
<pre><code class="lang-sql">-- Optimized by IX_Sessions_Status_CreatedAt
SELECT SessionId, Title, ParticipantCount, CreatedAt
FROM canvas.Sessions 
WHERE Status = 'Active' 
ORDER BY CreatedAt DESC
</code></pre>
<p><strong>Performance</strong>: Index seek on Status, sort on CreatedAt (covered query)</p>
<h4 id="token-validation-critical-path">Token Validation (Critical Path)</h4>
<pre><code class="lang-sql">-- Optimized by IX_SecureTokens_Tokens_Active  
SELECT SessionId, ExpiresAt
FROM canvas.SecureTokens
WHERE (HostToken = @token OR UserToken = @token) 
AND IsActive = 1 
AND ExpiresAt &gt; GETUTCDATE()
</code></pre>
<p><strong>Performance</strong>: Index seek with included columns, &lt;1ms typical response time</p>
<h3 id="real-time-features">Real-time Features</h3>
<h4 id="participant-count-updates">Participant Count Updates</h4>
<pre><code class="lang-sql">-- Real-time participant counting via IX_SessionParticipants_SessionId
SELECT COUNT(*) as ActiveParticipants
FROM canvas.SessionParticipants 
WHERE SessionId = @sessionId 
AND LeftAt IS NULL
</code></pre>
<p><strong>Performance</strong>: Index scan with COUNT aggregation, optimized for SignalR updates</p>
<h4 id="question-queue-by-priority">Question Queue by Priority</h4>
<pre><code class="lang-sql">-- Ordered Q&amp;A queue via IX_Questions_SessionId_VoteCount
SELECT QuestionId, QuestionText, VoteCount, QueuedAt
FROM canvas.Questions
WHERE SessionId = @sessionId 
AND Status = 'Pending'
ORDER BY VoteCount DESC, QueuedAt ASC
</code></pre>
<p><strong>Performance</strong>: Index seek + sort, supports real-time Q&amp;A prioritization</p>
<h2 id="memory-and-storage-optimization">Memory and Storage Optimization</h2>
<h3 id="included-column-strategy">Included Column Strategy</h3>
<p>Most secondary indexes use <strong>INCLUDE</strong> clauses to create <strong>covering indexes</strong>:</p>
<ul>
<li><strong>Reduced Key Size</strong>: Only filter columns in key</li>
<li><strong>Eliminated Lookups</strong>: Frequently accessed columns included</li>
<li><strong>Better Cache Utilization</strong>: Smaller index pages fit more in memory</li>
</ul>
<h3 id="selective-indexing">Selective Indexing</h3>
<pre><code class="lang-sql">-- Filtered index for active tokens only
CREATE NONCLUSTERED INDEX [IX_SecureTokens_Active_Only]
ON [canvas].[SecureTokens] ([ExpiresAt])
WHERE [IsActive] = 1
</code></pre>
<p><strong>Benefits</strong>:</p>
<ul>
<li><strong>Smaller Index Size</strong>: Only indexes active tokens</li>
<li><strong>Faster Maintenance</strong>: Fewer index entries to update</li>
<li><strong>Targeted Performance</strong>: Optimizes most common query patterns</li>
</ul>
<h2 id="maintenance-strategy">Maintenance Strategy</h2>
<h3 id="index-maintenance-schedule">Index Maintenance Schedule</h3>
<ul>
<li><strong>Weekly Reorganization</strong>: Indexes with 10-30% fragmentation</li>
<li><strong>Monthly Rebuild</strong>: Indexes with &gt;30% fragmentation</li>
<li><strong>Statistics Updates</strong>: Auto-update enabled for query plan optimization</li>
</ul>
<h3 id="monitoring-queries">Monitoring Queries</h3>
<pre><code class="lang-sql">-- Index usage statistics
SELECT 
    i.name as IndexName,
    s.user_seeks,
    s.user_scans,
    s.user_lookups,
    s.user_updates
FROM sys.indexes i
JOIN sys.dm_db_index_usage_stats s ON i.object_id = s.object_id AND i.index_id = s.index_id
JOIN sys.tables t ON i.object_id = t.object_id
JOIN sys.schemas sc ON t.schema_id = sc.schema_id
WHERE sc.name = 'canvas'
ORDER BY s.user_seeks DESC
</code></pre>
<h3 id="fragmentation-monitoring">Fragmentation Monitoring</h3>
<pre><code class="lang-sql">-- Index fragmentation analysis
SELECT 
    t.name as TableName,
    i.name as IndexName,
    ps.avg_fragmentation_in_percent,
    ps.page_count
FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, 'DETAILED') ps
JOIN sys.indexes i ON ps.object_id = i.object_id AND ps.index_id = i.index_id
JOIN sys.tables t ON ps.object_id = t.object_id
JOIN sys.schemas s ON t.schema_id = s.schema_id
WHERE s.name = 'canvas' AND ps.avg_fragmentation_in_percent &gt; 10
ORDER BY ps.avg_fragmentation_in_percent DESC
</code></pre>
<h2 id="performance-benchmarks">Performance Benchmarks</h2>
<h3 id="target-performance-metrics">Target Performance Metrics</h3>
<ul>
<li><strong>Token Validation</strong>: &lt;1ms response time</li>
<li><strong>Session Participant Count</strong>: &lt;5ms for up to 1000 participants</li>
<li><strong>Question Queue Updates</strong>: &lt;10ms for real-time prioritization</li>
<li><strong>Asset Detection</strong>: &lt;50ms for complex selector queries</li>
<li><strong>SignalR Group Operations</strong>: &lt;3ms for join/leave events</li>
</ul>
<h3 id="scaling-considerations">Scaling Considerations</h3>
<ul>
<li><strong>Session Concurrency</strong>: Supports 100+ simultaneous sessions</li>
<li><strong>Participant Scale</strong>: 1000+ participants per session</li>
<li><strong>Q&amp;A Volume</strong>: 100+ questions per session with real-time voting</li>
<li><strong>Asset Sharing</strong>: Hundreds of shared assets per session</li>
<li><strong>Annotation Density</strong>: Thousands of annotations per Islamic content page</li>
</ul>
<hr>
<h2 id="index-creation-scripts">Index Creation Scripts</h2>
<h3 id="complete-index-setup">Complete Index Setup</h3>
<pre><code class="lang-sql">-- Core performance indexes for canvas schema
-- Execute after fresh database setup or schema reset

-- SharedAssets selector-based performance  
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_SharedAssets_TypeSelector')
CREATE NONCLUSTERED INDEX [IX_SharedAssets_TypeSelector] 
ON [canvas].[SharedAssets] ([AssetType], [AssetSelector])

-- Session management
CREATE NONCLUSTERED INDEX [IX_Sessions_Status_CreatedAt] 
ON [canvas].[Sessions] ([Status], [CreatedAt])
INCLUDE ([Title], [ParticipantCount], [MaxParticipants])

-- Real-time participants
CREATE NONCLUSTERED INDEX [IX_SessionParticipants_SessionId_Active] 
ON [canvas].[SessionParticipants] ([SessionId])
INCLUDE ([UserId], [DisplayName], [JoinedAt], [LeftAt])

-- Token validation (critical path)
CREATE NONCLUSTERED INDEX [IX_SecureTokens_Validation] 
ON [canvas].[SecureTokens] ([IsActive], [ExpiresAt])
INCLUDE ([HostToken], [UserToken], [SessionId])

-- Q&amp;A system performance
CREATE NONCLUSTERED INDEX [IX_Questions_Priority] 
ON [canvas].[Questions] ([SessionId], [Status], [VoteCount] DESC)
INCLUDE ([QuestionText], [QueuedAt], [UserId])

-- Audit and analytics
CREATE NONCLUSTERED INDEX [IX_AuditLog_Session_Time] 
ON [canvas].[AuditLog] ([SessionId], [At] DESC)
INCLUDE ([Actor], [Action], [Details])

PRINT 'Canvas schema indexes created successfully'
</code></pre>
<hr>
<p><strong>Performance Note</strong>: These indexes are specifically tuned for NOOR Canvas usage patterns. The <strong>SharedAssets selector-based approach</strong> represents a major architectural optimization, reducing storage by ~90% while maintaining sub-second query performance for asset detection and positioning.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/asifhussain60/NOOR-CANVAS/blob/master/DocFX/articles/canvas-schema-performance.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
