@page "/session/waiting/{sessionToken?}"
@layout EmptyLayout
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.HtmlRendering
@using Microsoft.AspNetCore.SignalR.Client
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using System.Text.Json
@using NoorCanvas.Components.Development
@using NoorCanvas.Components
@using System.Timers
@using System.Globalization
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<SessionWaiting> Logger

<PageTitle>NoorCanvas</PageTitle>

@* All fonts and CDNs are centralized in Pages/_Host.cshtml *@
<style>
    .session-waiting-root {
        background-color: #F8F5F1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1.5rem;
        font-family: 'Inter', sans-serif;
    }

    .session-waiting-container {
        width: 85%;
        max-width: 80rem;
        background-color: #FFFFFF;
        border-radius: 1.5rem;
        padding: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        border: 1px solid #E5E7EB;
        text-align: center;
    }

    .loading-state, .error-state, .network-error-state {
        width: 100%;
        padding: 2rem;
        text-align: center;
    }

    .error-state {
        border: 1px solid #fecaca;
        border-radius: 1rem;
        background-color: #fef2f2;
    }

    .network-error-state {
        border: 1px solid #fed7aa;
        border-radius: 1rem;
        background-color: #fff7ed;
    }

    .logo-container {
        display: flex;
        justify-content: center;
    }

    .logo-img {
        max-width: 300px;
        height: auto;
        margin: 0 auto;
    }

    .logo-img-small {
        max-width: 150px;
        height: auto;
        margin: 0 auto;
    }

    .loading-header, .error-header, .network-error-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .loading-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.875rem;
        color: #006400;
        margin: 0;
    }

    .error-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 1.875rem;
            color: #ef4444;
            margin: 0;
        }

        .network-error-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.875rem;
            color: #f97316;
            margin: 0;
        }

        .loading-spinner {
            font-size: 2.25rem;
            color: #006400;
        }

        .error-icon {
            font-size: 2.25rem;
            color: #ef4444;
        }

        .network-error-icon {
            font-size: 2.25rem;
            color: #f97316;
        }

        .description-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            color: #706357;
            margin: 0;
        }

        .error-message {
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            color: #706357;
            margin: 0 0 1.5rem 0;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .retry-button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background-color: #006400;
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .home-button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background-color: #6b7280;
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .main-content {
            width: 100%;
        }

        .session-header {
            text-align: center;
        }

        .session-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: #006400;
            margin: 0 0 0.5rem 0;
        }

        .session-info-panel {
background-color: #effff9;
    border-radius: 1.5rem;
    border: 2px solid #006400;
    padding: 2rem 3rem;
    margin: 1.5rem auto 3rem auto;
    max-width: 50rem;
    box-shadow: 0 10px 25px -12px rgba(0, 0, 0, 0.15);
    text-align: center;
        }

        .session-info-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 2.25rem;
            color: #006400;
            margin: 0 0 1rem 0;
            line-height: 1.2;
        }

        .session-info-description {
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            color: #4B3C2B;
            line-height: 1.6;
            margin: 0;
            text-align: center;
        }

        .panels-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .waiting-room-panel {
            background-color: white;
            border-radius: 1rem;
            border: 2px solid #D4AF37;
            padding: 1rem 1.5rem;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
        }

        .waiting-room-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: #4B3C2B;
            margin: 0 0 0.5rem 0;
        }

        .session-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            background-color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            flex: 1;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-icon-container {
            padding: 0.5rem;
            background-color: #E5D7A9;
            border-radius: 0.5rem;
        }

        .detail-icon {
            color: #B8960C;
            font-size: 1rem;
        }

        .detail-content {
            text-align: left;
        }

        .detail-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.625rem;
            color: #706357;
            margin: 0;
        }

        .detail-value {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #4B3C2B;
            font-size: 1rem;
            margin: 0;
        }

        .timer-panel {
            text-align: center;
            border-radius: 1rem;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 2px solid #D4AF37;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timer-status {
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: #4B3C2B;
            margin: 0 0 0.5rem 0;
        }

        .countdown-display {
            font-size: 3rem;
            font-weight: 700;
            color: #006400;
            margin: 0.5rem 0 1rem 0;
            font-family: 'Inter', sans-serif;
        }

        .progress-bar-container {
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #006400;
            transition: width 0.5s ease-in-out;
        }

        .progress-bar-full {
            height: 100%;
            background-color: #006400;
            width: 100%;
        }

        .timer-description {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            color: #706357;
            margin: 0;
        }

        .participants-panel {
            background-color: white;
            padding: 3rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
            border: 2px solid #D4AF37;
        }

        .participants-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .participants-title-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

.participants-title {
    font-family: 'Inter', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #006400;
    margin: 0 0 2rem 0;
}

        .participants-icon {
            font-size: 1.5rem;
            color: #006400;
            margin-right: 0.5rem;
        }

        .sort-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .sort-button {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background-color: #F8F5F1;
            color: #4B3C2B;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .sort-button:hover {
            background-color: #e5e7eb;
        }

        .participants-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-height: 12rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            align-items: start;
        }

        /* Responsive grid columns */
        @@media (min-width: 1200px) {
            .participants-list {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.25rem;
            }
        }

        @@media (max-width: 768px) {
            .participants-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }

        .participant-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            color: #706357;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(112, 99, 87, 0.1);
            transition: background-color 0.2s ease;
            text-align: left;
        }

        .participant-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: rgba(112, 99, 87, 0.2);
        }

        .participant-flag {
            height: 1.5rem;
            width: auto;
            border-radius: 0.125rem;
            border: 1px solid #d1d5db;
        }

        .participant-name {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25;
            word-break: break-word;
            flex: 1;
            min-width: 0;
            text-align: left;
            justify-self: start;
        }

        .no-participants {
            grid-column: 1 / -1;
            text-align: center;
            color: #706357;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            padding: 1rem 0;
        }

        .connection-alert {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #f59e0b;
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 10px 20px rgba(245,158,11,0.2);
        }

        .connection-alert-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
        }

        .connection-alert-icon {
            padding: 0.75rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 50%;
            color: white;
        }

        .connection-alert-icon i {
            font-size: 1.5rem;
        }

        .connection-alert-text {
            flex: 1;
        }

        .connection-alert-message {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #92400e;
            margin: 0;
            font-weight: 600;
        }

        .connection-retry-button {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(245,158,11,0.3);
        }

        @@keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
</style>

<!-- Root container matching HostLanding.razor structure -->
<div class="session-waiting-root">
    
    <!-- Main content container -->
    <div class="session-waiting-container">

        @if (Model?.CurrentState == SessionWaitingState.Loading)
        {
            <!-- Loading State -->
            <div class="loading-state">
                <div class="loading-header">
                    <i class="fa-solid fa-spinner fa-spin loading-spinner"></i>
                    <h1 class="loading-title">Loading Session...</h1>
                </div>
                <p class="description-text">Please wait while we prepare your session.</p>
            </div>
        }
        else if (Model?.CurrentState == SessionWaitingState.SessionNotFound || Model?.CurrentState == SessionWaitingState.InvalidToken)
        {
            <!-- Error State -->
            <div class="error-state">
            <div class="error-header">
                <i class="fa-solid fa-exclamation-triangle error-icon"></i>
                <h1 class="error-title">Session Error</h1>
            </div>
            <p data-testid="error-message" class="error-message">@(Model?.ErrorMessage ?? "Session could not be loaded. Please check your session token.")</p>
            <div class="button-container">
                <button @onclick="RetryLoadSession" class="retry-button">
                    <i class="fa-solid fa-refresh" style="margin-right:0.5rem;"></i>
                    Try Again
                </button>
                <button @onclick="NavigateHome" class="home-button">
                    <i class="fa-solid fa-home" style="margin-right:0.5rem;"></i>
                    Return Home
                </button>
            </div>
        </div>
        }
        else if (Model?.CurrentState == SessionWaitingState.NetworkError)
        {
            <!-- Network Error State -->
            <div class="network-error-state">
            <div class="network-error-header">
                <i class="fa-solid fa-wifi network-error-icon"></i>
                <h1 class="network-error-title">Connection Error</h1>
            </div>
            <p class="error-message">Unable to connect to the server. Please check your internet connection.</p>
            <button @onclick="RetryLoadSession" class="retry-button">
                <i class="fa-solid fa-refresh" style="margin-right:0.5rem;"></i>
                Retry Connection
            </button>
        </div>
        }
        else if (Model?.CurrentState == SessionWaitingState.Loaded)
        {
            <!-- Main Waiting Room Content - Side by Side Layout -->
            <div class="main-content">
            
            <!-- Logo -->
            <div class="session-header">
                <div class="noor-canvas-logo" style="display:flex;align-items:center;justify-content:center;text-align:center;margin-bottom:1.5rem;">
                    <img src="/images/NoorCanvas.png?v=20250924" 
                         alt="@(Model?.LogoText ?? "NOOR Canvas")" />
                </div>
            </div>

            <!-- Centered Session Info Panel -->
            <div class="session-info-panel">
                <h1 class="session-info-title">@(Model?.SessionName ?? "Loading...")</h1>
                @if (!string.IsNullOrEmpty(Model?.SessionDescription))
                {
                    <p class="session-info-description">@Model.SessionDescription</p>
                }
            </div>

            <!-- Welcome Message Panel -->
            <div style="background-color:#ffffff;border-radius:1.5rem;padding:1.5rem 2rem;margin:1rem auto;max-width:50rem;text-align:center;">
                <div style="display:flex;align-items:center;justify-content:center;">
                    <span style="font-family:'Poppins',sans-serif;font-size:1.25rem;font-weight:600;color:#006400;">
                        @if (!string.IsNullOrEmpty(Model?.CurrentParticipantName))
                        {
                            @($"{Model.CurrentParticipantName}, Welcome To The Waiting Room")
                        }
                        else
                        {
                            @("Welcome To The Waiting Room")
                        }
                    </span>
                </div>
            </div>

            <!-- Side-by-Side Panels Container: Waiting Room & Session Timer -->
            <div class="panels-container">
                
                <!-- Left Panel: Waiting Room Details -->
                <div class="waiting-room-panel">
                    <!-- Session Details Grid -->
                    <div class="session-details-grid">
                        <!-- Date -->
                        <div class="detail-item">
                            <div class="detail-icon-container">
                                <i class="fa-solid fa-calendar-days detail-icon"></i>
                            </div>
                            <div class="detail-content">
                                <p class="detail-label">Date</p>
                                <p class="detail-value">@(Model?.SessionDate ?? "Today")</p>
                            </div>
                        </div>
                        
                        <!-- Start Time -->
                        <div class="detail-item">
                            <div class="detail-icon-container">
                                <i class="fa-solid fa-clock detail-icon"></i>
                            </div>
                            <div class="detail-content">
                                <p class="detail-label">Start Time</p>
                                <p class="detail-value">@(Model?.StartTime ?? "2:00 PM EST")</p>
                            </div>
                        </div>
                        
                        <!-- Duration -->
                        <div class="detail-item">
                            <div class="detail-icon-container">
                                <i class="fa-solid fa-hourglass-half detail-icon"></i>
                            </div>
                            <div class="detail-content">
                                <p class="detail-label">Duration</p>
                                <p class="detail-value">@(Model?.SessionDuration ?? "Loading...")</p>
                            </div>
                        </div>
                        
                        <!-- Instructor -->
                        <div class="detail-item">
                            <div class="detail-icon-container">
                                <i class="fa-solid fa-user-tie detail-icon"></i>
                            </div>
                            <div class="detail-content">
                                <p class="detail-label">Instructor</p>
                                <p class="detail-value">@(Model?.InstructorName ?? "Loading...")</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Session Timer -->
                <div class="timer-panel">
                @if (Model?.SessionStarted == true)
                {
                    <p class="timer-status">Waiting For Host...</p>
                    <div class="countdown-display">
                        <i class="fa-solid fa-clock" style="color: #006400;"></i>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-full"></div>
                    </div>
                    <p class="timer-description">Waiting for host to begin the session.</p>
                }
                else
                {
                    <p class="timer-status">Session begins in:</p>
                    <div data-testid="countdown-display" class="countdown-display">@(Model?.FormattedTime ?? "00:00")</div>
                    <div data-testid="progress-bar" class="progress-bar-container">
                        <div class="progress-bar-fill" style="width:@(Model?.Progress ?? 0)%;"></div>
                    </div>
                    <p class="timer-description">@(Model?.StatusMessage ?? "Waiting for host to begin the session.")</p>
                }

                @* Start Session Button removed - Issue-129: Should not be visible in participant waiting room *@
                </div>
            </div>

            <!-- Participants Panel -->
            <div class="participants-panel">
                <div class="participants-header">
                    <div class="participants-title-container">
                        <h2 class="participants-title">Participants (@(Model?.Participants?.Count ?? 0))</h2>
                    </div>
                    <div class="sort-buttons">
                        <button @onclick="SortByName" class="sort-button">Sort by Name</button>
                        <button @onclick="SortByCountry" class="sort-button">Sort by Country</button>
                    </div>
                </div>
                <div data-testid="participants-list" class="participants-list">
                    @if (Model?.Participants?.Any() == true)
                    {
                        @foreach (var p in Model.Participants)
                        {
                            <div class="participant-item">
                                <FlagIcon CountryIso2="@p.Flag" 
                                         CountryName="@p.Country" 
                                         DataTestId="participant-flag"
                                         Style="height:1.5rem;width:auto;border-radius:0.125rem;border:1px solid #d1d5db;" />
                                <span class="participant-name">@p.Name</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-participants">
                            No participants yet. You're the first!
                        </div>
                    }
                </div>
            </div>



            <!-- Connection Status Alert -->
            @if (Model?.CurrentState == SessionWaitingState.ConnectionIssue)
            {
                <div class="connection-alert">
                    <div class="connection-alert-content">
                        <div class="connection-alert-icon">
                            <i class="fa-solid fa-exclamation-triangle"></i>
                        </div>
                        <div class="connection-alert-text">
                            <p class="connection-alert-message">Connection unstable. Updates may be delayed.</p>
                        </div>
                        <button @onclick="RetryConnection" class="connection-retry-button">
                            <i class="fa-solid fa-refresh" style="margin-right:0.5rem;"></i>Retry
                        </button>
                    </div>
                </div>
            }


        </div>
        }
    </div>
</div>

@* Debug Panel - Development Only *@
<DebugPanel CurrentViewName="SessionWaiting" OnEnterTestData="HandleEnterTestData" />

@implements IAsyncDisposable

@code {
    [Parameter] public string? SessionToken { get; set; }
    
    private SessionWaitingViewModel? Model { get; set; }
    private System.Timers.Timer? _countdownTimer;
    private System.Timers.Timer? _participantUpdateTimer;
    private HubConnection? _hubConnection;
    private DateTime _sessionStartTime;
    private int _countdownDurationMs = 300000; // 5 minutes default
    private int _retryAttempts = 0;
    private const int MaxRetryAttempts = 3;
    private long? _sessionId;
    private string CurrentUserGuid { get; set; } = string.Empty;
    


    protected override async Task OnInitializedAsync()
    {
        var requestId = Guid.NewGuid().ToString("N")[..8];
        // Session initialization started

        Model = new SessionWaitingViewModel
        {
            LogoText = "NOOR Canvas",
            CurrentState = SessionWaitingState.Loading,
            SessionName = "Loading Session...",
            SessionDate = "Today",
            StartTime = "Loading...",
            SessionDuration = "Loading...",
            InstructorName = "Loading...",
            FormattedTime = "00:00",
            Progress = 0,
            StatusMessage = "Preparing session...",
            Participants = new List<ParticipantData>(),
            SessionStarted = false
        };

        await InitializeSessionAsync(requestId);
    }

    private async Task InitializeSessionAsync(string requestId)
    {
        try
        {
            if (string.IsNullOrEmpty(SessionToken))
            {
                // No session token provided
                Model!.CurrentState = SessionWaitingState.InvalidToken;
                Model.ErrorMessage = "No session token provided. Please use a valid session link.";
                StateHasChanged();
                return;
            }

            // Loading session data

            // Only handle real session tokens - no mock/demo data
            if (!string.IsNullOrEmpty(SessionToken))
            {
                await LoadSessionDataAsync(SessionToken, requestId);
                if (Model?.CurrentState == SessionWaitingState.Loaded)
                {
                    InitializeTimers();
                    // Load current participant info first
                    await LoadCurrentParticipantFromApiAsync(requestId);
                    // Load participants list
                    await LoadParticipantsAsync(requestId);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[{RequestId}] Fatal error during session initialization", requestId);
            Model!.CurrentState = SessionWaitingState.CriticalError;
            Model.ErrorMessage = "A critical error occurred while loading the session.";
            StateHasChanged();
        }
    }

    private async Task LoadSessionDataAsync(string token, string requestId)
    {
        try
        {
            Model!.CurrentState = SessionWaitingState.Loading;
            StateHasChanged();

            using var httpClient = HttpClientFactory.CreateClient();
            httpClient.BaseAddress = new Uri("https://localhost:9091/");
            var response = await httpClient.GetAsync($"api/participant/session/{token}/validate");
            
            // Session validation completed

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var validationResult = System.Text.Json.JsonSerializer.Deserialize<SessionValidationResponse>(content, 
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (validationResult?.Valid == true && validationResult.Session != null)
                {
                    // Session validation successful

                    UpdateSessionData(validationResult.Session);
                    Model.CurrentState = SessionWaitingState.Loaded;
                    _retryAttempts = 0; // Reset retry counter on success
                    
                    // Store session ID for SignalR integration
                    _sessionId = validationResult.Session.SessionId;
                    
                    // Initialize SignalR connection for real-time participant updates
                    await InitializeSignalRConnection(requestId);
                }
                else
                {
                    // Session validation failed
                    Model.CurrentState = SessionWaitingState.InvalidToken;
                    Model.ErrorMessage = "Invalid session token. Please check your session link.";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                Model.CurrentState = SessionWaitingState.SessionNotFound;
                Model.ErrorMessage = "Session not found. The session may have been canceled or expired.";
            }
            else
            {
                Logger.LogError("[{RequestId}] Session validation failed with status: {StatusCode}", 
                    requestId, response.StatusCode);
                Model.CurrentState = SessionWaitingState.ApiError;
                Model.ErrorMessage = $"Server error ({response.StatusCode}). Please try again later.";
            }
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "[{RequestId}] Network error during session validation", requestId);
            Model!.CurrentState = SessionWaitingState.NetworkError;
            Model.ErrorMessage = "Network error. Please check your internet connection.";
        }
        catch (TaskCanceledException ex)
        {
            Logger.LogError(ex, "[{RequestId}] Request timeout during session validation", requestId);
            Model!.CurrentState = SessionWaitingState.Timeout;
            Model.ErrorMessage = "Request timed out. Please try again.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[{RequestId}] Unexpected error during session validation", requestId);
            Model!.CurrentState = SessionWaitingState.CriticalError;
            Model.ErrorMessage = "An unexpected error occurred. Please try again.";
        }
        
        StateHasChanged();
    }

    private void UpdateSessionData(SessionWaitingData session)
    {
        if (Model == null) return;

        var requestId = Guid.NewGuid().ToString("N")[..8];

        // WORKITEM-WAITINGROOM: Use actual scheduled session data instead of hardcoded countdown
        DateTime calculatedStartTime;
        
        // Check if session has actually started (status check)
        bool sessionAlreadyStarted = session.Status?.Equals("Started", StringComparison.OrdinalIgnoreCase) == true ||
                                   session.Status?.Equals("Live", StringComparison.OrdinalIgnoreCase) == true;
        
        if (sessionAlreadyStarted)
        {
            // Session has started - show immediate start
            calculatedStartTime = DateTime.Now;
            // Session already started - using immediate start
        }
        else
        {
            // WORKITEM-WAITINGROOM: Parse actual scheduled date/time from database
            calculatedStartTime = ParseScheduledDateTime(session, requestId);
            // Using parsed scheduled time
        }
        
        // Update model with actual session data - Fix data flow from Host-SessionOpener
        Model.SessionName = session.Title ?? "Unknown Session";
        Model.SessionDescription = session.Description ?? "";
        
        // WORKITEM-WAITINGROOM-PHASE1: Properly reflect Host-SessionOpener values
        // Use custom scheduling fields from Host-SessionOpener form if available, otherwise fallback to defaults
        Model.SessionDate = FormatDatabaseDate(session.ScheduledDate) ?? FormatDate(DateTime.Now);
        Model.StartTime = session.ScheduledTime ?? FormatTime(calculatedStartTime);
        Model.SessionDuration = FormatDurationFromString(session.ScheduledDuration) ?? FormatDuration(session.Duration);
        Model.InstructorName = session.InstructorName ?? "Loading...";
        
        // Session data updated successfully
        
        // WORKITEM-WAITINGROOM-PHASE2: Fix countdown timer to count to actual start time
        _sessionStartTime = calculatedStartTime;
        var currentTime = DateTime.Now;
        _countdownDurationMs = (int)(_sessionStartTime - currentTime).TotalMilliseconds;
        
        // Countdown timer initialized
        
        if (_countdownDurationMs <= 0)
        {
            Model.SessionStarted = true;
            Model.StatusMessage = "Session is ready to begin!";
        }
    }

    private DateTime ParseScheduledDateTime(SessionWaitingData session, string requestId)
    {
        // WORKITEM-WAITINGROOM: Parse actual scheduled date and time from database
        try
        {
            // If scheduled date and time are provided, parse them
            if (!string.IsNullOrEmpty(session.ScheduledDate) && !string.IsNullOrEmpty(session.ScheduledTime))
            {
                // Parse the scheduled date (expecting format like "09/28/2025")
                if (DateTime.TryParse(session.ScheduledDate, out DateTime scheduleDate))
                {
                    // Parse the scheduled time (expecting format like "6:00 AM")
                    if (DateTime.TryParse(session.ScheduledTime, out DateTime scheduleTime))
                    {
                        // Combine date and time
                        var combinedDateTime = new DateTime(
                            scheduleDate.Year, 
                            scheduleDate.Month, 
                            scheduleDate.Day,
                            scheduleTime.Hour,
                            scheduleTime.Minute,
                            scheduleTime.Second
                        );
                        
                        // Parsed scheduled datetime successfully
                        
                        return combinedDateTime;
                    }
                    else
                    {
                        // Failed to parse scheduled time, using fallback
                    }
                }
                else
                {
                    // Failed to parse scheduled date, using fallback
                }
            }
            else
            {
                // ScheduledDate or ScheduledTime is null/empty, using fallback
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error parsing scheduled datetime, using fallback");
        }
        
        // Fallback: Use current time + 5 minutes for demonstration
        var fallbackTime = DateTime.Now.AddMinutes(5);
        // Using fallback time
        return fallbackTime;
    }

    private async Task LoadParticipantsAsync(string requestId)
    {
        try
        {
            // Loading participants
            
            using var httpClient = HttpClientFactory.CreateClient("default");
            httpClient.BaseAddress = new Uri("https://localhost:9091/");
            
            var apiUrl = $"api/participant/session/{SessionToken}/participants";
            // Making participants API call
            
            var response = await httpClient.GetAsync(apiUrl);
            
            // Participants API call completed
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                // Participants API response received
                
                var participantsResponse = System.Text.Json.JsonSerializer.Deserialize<ParticipantsResponse>(content, 
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (participantsResponse?.Participants != null)
                {
                    // Processing participants list
                    
                    // Initialize participants list if null
                    if (Model!.Participants == null)
                    {
                        Model!.Participants = new List<ParticipantData>();
                    }

                    // Convert API participants to display participants (with database-driven flag codes)
                    var newParticipants = participantsResponse.Participants.Select(p => new ParticipantData
                    {
                        Name = p.DisplayName,
                        Country = p.Country ?? "Unknown",
                        Flag = p.CountryFlag ?? "un" // Database-driven flag code from API
                    }).ToList();

                    // Processing participant data

                    // Add only new participants that don't already exist
                    var existingNames = Model.Participants.Select(p => p.Name).ToHashSet();
                    var participantsToAdd = newParticipants.Where(p => !existingNames.Contains(p.Name)).ToList();
                    
                    // Add new participants to existing list
                    Model.Participants.AddRange(participantsToAdd);
                    
                    // Participant list updated
                }
                else
                {
                    Model!.Participants = new List<ParticipantData>();
                    // No participants returned from API
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("[{RequestId}] Failed to load participants: {StatusCode} - {ErrorContent}", 
                    requestId, response.StatusCode, errorContent);
                
                // Only use real data - no fallback to demo data
                Model!.Participants = new List<ParticipantData>();
                Logger.LogWarning("[{RequestId}] Participants API call failed - Token: {Token}, URL: {Url}, Status: {Status}", 
                    requestId, SessionToken, $"api/participant/session/{SessionToken}/participants", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[{RequestId}] Error loading participants", requestId);
            // Only use real data - no fallback to demo data
            Model!.Participants = new List<ParticipantData>();
        }
        
        await InvokeAsync(() => StateHasChanged());
    }

    /// <summary>
    /// Loads current participant info directly from API using token and UserGuid.
    /// Similar to SessionCanvas.razor approach for consistent participant identification.
    /// </summary>
    private async Task LoadCurrentParticipantFromApiAsync(string requestId)
    {
        try
        {
            using var httpClient = HttpClientFactory.CreateClient("default");
            httpClient.BaseAddress = new Uri("https://localhost:9091/");
            
            // First, try to get UserGuid from browser storage
            var storageKey = $"noor_user_guid_{SessionToken}";
            try
            {
                CurrentUserGuid = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey) ?? string.Empty;
            }
            catch
            {
                CurrentUserGuid = string.Empty;
            }
            
            // Build API URL with optional UserGuid parameter
            var apiUrl = $"api/participant/session/{SessionToken}/me";
            if (!string.IsNullOrEmpty(CurrentUserGuid))
            {
                apiUrl += $"?userGuid={Uri.EscapeDataString(CurrentUserGuid)}";
            }
            
            var response = await httpClient.GetAsync(apiUrl);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var participantResponse = JsonSerializer.Deserialize<ParticipantMeResponse>(content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
                
                if (participantResponse != null && !string.IsNullOrEmpty(participantResponse.Name))
                {
                    if (Model != null)
                    {
                        Model.CurrentParticipantName = participantResponse.Name;
                    }
                    
                    // Update UserGuid if provided in response
                    if (!string.IsNullOrEmpty(participantResponse.UserGuid))
                    {
                        CurrentUserGuid = participantResponse.UserGuid;
                        
                        // Store UserGuid for session persistence
                        try
                        {
                            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, CurrentUserGuid);
                        }
                        catch
                        {
                            // Storage failed, continue without persistence
                        }
                    }
                }
            }
        }
        catch (Exception)
        {
            // Log error but don't fail the entire loading process
            // Current participant name will remain null, showing generic welcome message
        }
    }

    // GetCountryFlag method removed - now using database-driven flag codes from KSESSIONS.Countries table

    private async Task InitializeSignalRConnection(string requestId)
    {
        try
        {
            if (_sessionId == null)
            {
                // Cannot initialize SignalR - session ID is null
                return;
            }

            // Initializing SignalR connection

            // Create SignalR connection to SessionHub
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hub/session"))
                .WithAutomaticReconnect()
                .Build();

            // Handle real-time participant events
            _hubConnection.On<object>("UserJoined", async (eventData) =>
            {
                var logRequestId = Guid.NewGuid().ToString("N")[..8];
                // UserJoined event received
                
                // Refresh participants immediately when someone joins
                await InvokeAsync(async () =>
                {
                    await LoadParticipantsAsync(logRequestId);
                    StateHasChanged();
                });
            });

            _hubConnection.On<object>("UserLeft", async (eventData) =>
            {
                var logRequestId = Guid.NewGuid().ToString("N")[..8];
                // UserLeft event received
                
                // Refresh participants immediately when someone leaves
                await InvokeAsync(async () =>
                {
                    await LoadParticipantsAsync(logRequestId);
                    StateHasChanged();
                });
            });

            _hubConnection.On<object>("ParticipantJoined", async (participantData) =>
            {
                var logRequestId = Guid.NewGuid().ToString("N")[..8];
                // ParticipantJoined event received
                
                // Refresh participants immediately when someone registers
                await InvokeAsync(async () =>
                {
                    await LoadParticipantsAsync(logRequestId);
                    StateHasChanged();
                });
            });

            // Listen for session start events to automatically navigate to canvas
            _hubConnection.On<object>("SessionBegan", async (sessionData) =>
            {
                var logRequestId = Guid.NewGuid().ToString("N")[..8];
                // SessionBegan event received - navigating to canvas
                
                // Navigate all waiting users to session canvas
                await InvokeAsync(() =>
                {
                    if (!string.IsNullOrEmpty(SessionToken))
                    {
                        Navigation.NavigateTo($"/session/canvas/{SessionToken}");
                    }
                });
            });



            // Start the connection
            await _hubConnection.StartAsync();
            // SignalR connection started successfully

            // Join token-based group for real-time participant sync
            var tokenGroup = $"usertoken_{SessionToken}";
            await _hubConnection.SendAsync("JoinGroup", tokenGroup);
            
            // Also join session group for backward compatibility with other events
            await _hubConnection.SendAsync("JoinSession", _sessionId, "participant");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize SignalR connection");
            // SignalR failure shouldn't break the component - we'll fallback to polling
        }
    }

    private void InitializeTimers()
    {
        // Countdown timer
        _countdownTimer = new System.Timers.Timer(1000); // Update every second
        _countdownTimer.Elapsed += UpdateCountdown;
        _countdownTimer.Enabled = true;

        // Participant update timer - now fallback only (5 minutes) since we have real-time SignalR updates
        _participantUpdateTimer = new System.Timers.Timer(300000); // Update every 5 minutes as fallback
        _participantUpdateTimer.Elapsed += async (s, e) => await UpdateParticipants();
        _participantUpdateTimer.Enabled = true;
    }

    private void UpdateCountdown(object? source, ElapsedEventArgs e)
    {
        if (Model == null || Model.SessionStarted) return;

        try
        {
            var currentTime = DateTime.Now;
            var timeLeft = _sessionStartTime - currentTime;
            var requestId = Guid.NewGuid().ToString("N")[..8];
            

            
            if (timeLeft.TotalMilliseconds <= 0)
            {
                Model.SessionStarted = true;
                Model.FormattedTime = "00:00";
                Model.Progress = 100;
                Model.StatusMessage = "Session is ready to begin!";
                _countdownTimer?.Stop();
            }
            else
            {
                var totalMinutes = Math.Floor(timeLeft.TotalMinutes);
                var seconds = timeLeft.Seconds;
                Model.FormattedTime = $"{totalMinutes:00}:{seconds:00}";
                
                var progress = ((_countdownDurationMs - timeLeft.TotalMilliseconds) / _countdownDurationMs) * 100;
                Model.Progress = Math.Max(0, Math.Min(100, (int)progress));
                
                if (timeLeft.TotalMinutes < 1)
                {
                    Model.StatusMessage = "Starting very soon...";
                }
                else if (timeLeft.TotalMinutes < 5)
                {
                    Model.StatusMessage = "Starting soon...";
                }
                else
                {
                    Model.StatusMessage = "Waiting for session to begin.";
                }
            }

            InvokeAsync(() => StateHasChanged());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating countdown timer");
        }
    }

    private async Task UpdateParticipants()
    {
        if (Model?.CurrentState != SessionWaitingState.Loaded) return;
        
        var requestId = Guid.NewGuid().ToString("N")[..8];
        await LoadParticipantsAsync(requestId);
    }

    private async Task RetryLoadSession()
    {
        if (_retryAttempts >= MaxRetryAttempts)
        {
            Model!.ErrorMessage = "Maximum retry attempts exceeded. Please refresh the page or contact support.";
            return;
        }
        
        _retryAttempts++;
        var requestId = Guid.NewGuid().ToString("N")[..8];
        // Retrying session load
            
        await InitializeSessionAsync(requestId);
    }

    private async Task RetryConnection()
    {
        Model!.CurrentState = SessionWaitingState.Loaded;
        var requestId = Guid.NewGuid().ToString("N")[..8];
        await UpdateParticipants();
    }



    private void NavigateHome()
    {
        Navigation.NavigateTo("/");
    }

    /// <summary>
    /// Handles test data entry for debug panel - Development only
    /// WORKITEM-WAITINGROOM: Phase 2 - Broadcast test participants via SignalR to all users with same token
    /// </summary>
    private async Task HandleEnterTestData()
    {
        if (Model == null) return;

        var requestId = Guid.NewGuid().ToString("N")[..8];
        try
        {
            // Broadcasting test data via SignalR
            
            // WORKITEM-WAITINGROOM: Instead of local FloodParticipantList, broadcast via SignalR
            await BroadcastTestParticipants(requestId);
            
            // Test participants broadcasted successfully
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to broadcast test data via SignalR");
            throw;
        }
    }

    /// <summary>
    /// WORKITEM-WAITINGROOM: Phase 2 - Broadcast test participants via SignalR to all users sharing the same token
    /// This replaces the local-only FloodParticipantList approach
    /// </summary>
    private async Task BroadcastTestParticipants(string requestId)
    {
        if (_hubConnection?.State != HubConnectionState.Connected)
        {
            // SignalR not connected, cannot broadcast test participants
            return;
        }

        if (string.IsNullOrEmpty(SessionToken) || _sessionId == null)
        {
            // SessionToken or SessionId missing, cannot broadcast
            return;
        }

        var random = new Random();
        var firstNames = new[] { "Mohammed", "Ahmed", "Ali", "Omar", "Khalid", "Hassan", "Ibrahim", "Yusuf", "Abdullah", "Ameer", 
                                "Sarah", "Fatima", "Aisha", "Khadija", "Maryam", "Zeinab", "Layla", "Noor", "Amina", "Yasmin",
                                "John", "David", "Michael", "James", "Robert", "William", "Richard", "Joseph", "Thomas", "Christopher",
                                "Maria", "Elizabeth", "Jennifer", "Linda", "Patricia", "Susan", "Jessica", "Ashley", "Emily", "Samantha",
                                "Chen", "Wang", "Li", "Zhang", "Liu", "Yang", "Huang", "Zhao", "Wu", "Zhou" };
        
        var lastNames = new[] { "Al-Rashid", "Al-Mahmoud", "Al-Zahra", "Al-Nouri", "Al-Sabah", "Al-Hashemi", "Al-Farisi", "Al-Tamimi",
                               "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez",
                               "Lee", "Kim", "Kim", "Park", "Choi", "Jung", "Kang", "Cho", "Yoon", "Jang", "Lim",
                               "Singh", "Kumar", "Sharma", "Gupta", "Verma", "Agarwal", "Mishra", "Tiwari", "Yadav", "Jain" };

        var countries = new[] { "US", "CA", "GB", "DE", "FR", "IT", "ES", "AU", "NZ", "JP", "KR", "CN", "IN", "PK", "BD", 
                               "EG", "SA", "AE", "TR", "MA", "NG", "ZA", "BR", "MX", "AR", "RU", "SE", "NO", "DK", "NL" };

        var countryFlags = new[] { "us", "ca", "gb", "de", "fr", "it", "es", "au", "nz", "jp", "kr", "cn", "in", "pk", "bd",
                                  "eg", "sa", "ae", "tr", "ma", "ng", "za", "br", "mx", "ar", "ru", "se", "no", "dk", "nl" };

        // WORKITEM-WAITINGROOM: Broadcast 50 test participants via SignalR ParticipantJoined events
        var successCount = 0;
        var errorCount = 0;
        
        for (int i = 0; i < 50; i++)
        {
            var firstName = firstNames[random.Next(firstNames.Length)];
            var lastName = lastNames[random.Next(lastNames.Length)];
            var countryIndex = random.Next(countries.Length);
            var testParticipantId = $"test-{Guid.NewGuid().ToString("N")[..8]}";
            
            // Create participant data matching ParticipantJoined event structure
            var participantData = new
            {
                sessionId = _sessionId,
                participantId = testParticipantId,
                displayName = $"{firstName} {lastName}",
                country = countries[countryIndex],
                joinedAt = DateTime.UtcNow,
                timestamp = DateTime.UtcNow,
                userToken = SessionToken // Include token for validation
            };

            try
            {
                // WORKITEM-WAITINGROOM: Broadcast test participant via new SessionHub method
                // This sends to all users in the token group (usertoken_{token})
                await _hubConnection.SendAsync("BroadcastTestParticipant", SessionToken, participantData);
                successCount++;
            }
            catch (Exception)
            {
                // Failed to broadcast test participant
                errorCount++;
            }

            // Small delay to avoid overwhelming SignalR
            await Task.Delay(50);
        }
        
        // Broadcast complete - {successCount}/50 participants sent
    }

    /// <summary>
    /// DEPRECATED: Legacy local-only participant flooding (replaced by SignalR in Phase 2)
    /// WORKITEM-WAITINGROOM: This method is superseded by BroadcastTestParticipants() for proper SignalR propagation
    /// </summary>
    private void FloodParticipantList()
    {
        if (Model?.Participants == null) return;

        var random = new Random();
        var firstNames = new[] { "Mohammed", "Ahmed", "Ali", "Omar", "Khalid", "Hassan", "Ibrahim", "Yusuf", "Abdullah", "Ameer", 
                                "Sarah", "Fatima", "Aisha", "Khadija", "Maryam", "Zeinab", "Layla", "Noor", "Amina", "Yasmin",
                                "John", "David", "Michael", "James", "Robert", "William", "Richard", "Joseph", "Thomas", "Christopher",
                                "Maria", "Elizabeth", "Jennifer", "Linda", "Patricia", "Susan", "Jessica", "Ashley", "Emily", "Samantha",
                                "Chen", "Wang", "Li", "Zhang", "Liu", "Yang", "Huang", "Zhao", "Wu", "Zhou" };
        
        var lastNames = new[] { "Al-Rashid", "Al-Mahmoud", "Al-Zahra", "Al-Nouri", "Al-Sabah", "Al-Hashemi", "Al-Farisi", "Al-Tamimi",
                               "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez",
                               "Lee", "Kim", "Kim", "Park", "Choi", "Jung", "Kang", "Cho", "Yoon", "Jang", "Lim",
                               "Singh", "Kumar", "Sharma", "Gupta", "Verma", "Agarwal", "Mishra", "Tiwari", "Yadav", "Jain" };

        var countries = new[] { "US", "CA", "GB", "DE", "FR", "IT", "ES", "AU", "NZ", "JP", "KR", "CN", "IN", "PK", "BD", 
                               "EG", "SA", "AE", "TR", "MA", "NG", "ZA", "BR", "MX", "AR", "RU", "SE", "NO", "DK", "NL" };

        var countryFlags = new[] { "us", "ca", "gb", "de", "fr", "it", "es", "au", "nz", "jp", "kr", "cn", "in", "pk", "bd",
                                  "eg", "sa", "ae", "tr", "ma", "ng", "za", "br", "mx", "ar", "ru", "se", "no", "dk", "nl" };

        // Add 50 random participants
        for (int i = 0; i < 50; i++)
        {
            var firstName = firstNames[random.Next(firstNames.Length)];
            var lastName = lastNames[random.Next(lastNames.Length)];
            var countryIndex = random.Next(countries.Length);
            
            Model.Participants.Add(new ParticipantData
            {
                Name = $"{firstName} {lastName}",
                Country = countries[countryIndex],
                Flag = countryFlags[countryIndex]
            });
        }

        var requestId = Guid.NewGuid().ToString("N")[..8];
        // Added 50 random participants for volume testing
        
        StateHasChanged();
    }

    // COPILOT-DEBUG: Issue-129 - StartSession method removed as button should not be in participant waiting room

    private void SortByName()
    {
        if (Model?.Participants != null)
        {
            Model.Participants = Model.Participants.OrderBy(p => p.Name).ToList();
            StateHasChanged();
        }
    }
    


    private void SortByCountry()
    {
        if (Model?.Participants != null)
        {
            Model.Participants = Model.Participants.OrderBy(p => p.Country).ToList();
            StateHasChanged();
        }
    }

    private static string? FormatDatabaseDate(string? scheduledDate)
    {
        // WORKITEM-WAITINGROOM: Parse database date string and format as "Sept 9, 2025"
        if (string.IsNullOrEmpty(scheduledDate)) return null;
        
        // Try to parse the date string from database (expecting formats like "09/28/2025" or "2025-09-28")
        if (DateTime.TryParse(scheduledDate, out DateTime parsedDate))
        {
            var today = DateTime.Today;
            
            if (parsedDate.Date == today) return "Today";
            if (parsedDate.Date == today.AddDays(1)) return "Tomorrow";
            
            // Format as "Sept 9, 2025"
            return parsedDate.ToString("MMM d, yyyy");
        }
        
        // If parsing fails, return the original string as fallback
        return scheduledDate;
    }

    private static string FormatDate(DateTime? dateTime)
    {
        if (!dateTime.HasValue) return "Today";
        
        var date = dateTime.Value.Date;
        var today = DateTime.Today;
        
        if (date == today) return "Today";
        if (date == today.AddDays(1)) return "Tomorrow";
        
        // WORKITEM-WAITINGROOM: Format date as "Sept 9, 2025" based on database value
        return date.ToString("MMM d, yyyy");
    }

    private static string FormatTime(DateTime? dateTime)
    {
        return dateTime?.ToString("h:mm tt") ?? "TBD";
    }

    private static string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue) return "Duration not available";
        
        var hours = duration.Value.Hours;
        var minutes = duration.Value.Minutes;
        
        if (hours > 0 && minutes > 0)
            return $"{hours}h {minutes}m";
        if (hours > 0)
            return $"{hours} hour{(hours > 1 ? "s" : "")}";
        if (minutes > 0)
            return $"{minutes} minute{(minutes > 1 ? "s" : "")}";
            
        return "30 minutes";
    }

    /// <summary>
    /// WORKITEM-WAITINGROOM-PHASE3: Format duration from Host-SessionOpener string value (e.g., "45") to display format (e.g., "45 minutes")
    /// </summary>
    private static string? FormatDurationFromString(string? durationString)
    {
        if (string.IsNullOrEmpty(durationString)) return null;
        
        if (int.TryParse(durationString, out int minutes))
        {
            if (minutes >= 60)
            {
                var hours = minutes / 60;
                var remainingMinutes = minutes % 60;
                
                if (remainingMinutes > 0)
                    return $"{hours} hour{(hours > 1 ? "s" : "")} {remainingMinutes} minute{(remainingMinutes > 1 ? "s" : "")}";
                else
                    return $"{hours} hour{(hours > 1 ? "s" : "")}";
            }
            else
            {
                return $"{minutes} minute{(minutes > 1 ? "s" : "")}";
            }
        }
        
        return durationString; // Return as-is if not parseable
    }

    public void Dispose()
    {
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
        _participantUpdateTimer?.Stop();
        _participantUpdateTimer?.Dispose();
    }

    public async ValueTask DisposeAsync()
    {
        // Dispose timers
        Dispose();
        
        // Cleanup SignalR connection asynchronously
        if (_hubConnection != null)
        {
            try
            {
                if (_hubConnection.State == HubConnectionState.Connected)
                {
                    // COPILOT-DEBUG: ISSUE FIX - Leave token-based group on cleanup
                    if (!string.IsNullOrEmpty(SessionToken))
                    {
                        var tokenGroup = $"usertoken_{SessionToken}";
                        await _hubConnection.SendAsync("LeaveGroup", tokenGroup);
                        // Left token-based group
                    }
                    
                    if (_sessionId != null)
                    {
                        await _hubConnection.SendAsync("LeaveSession", _sessionId);
                        // Left session group
                    }
                }
                await _hubConnection.DisposeAsync();
                // SignalR connection disposed successfully
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error during SignalR cleanup");
            }
        }
    }

    // ViewModel and Data Classes
    public class SessionWaitingViewModel
    {
        public string? LogoText { get; set; }
        public SessionWaitingState CurrentState { get; set; }
        public string? SessionName { get; set; }
        public string? SessionDescription { get; set; }
        public string? SessionDate { get; set; }
        public string? StartTime { get; set; }
        public string? SessionDuration { get; set; }
        public string? InstructorName { get; set; }
        public string? FormattedTime { get; set; }
        public int Progress { get; set; }
        public string? StatusMessage { get; set; }
        public List<ParticipantData>? Participants { get; set; }
        public bool SessionStarted { get; set; }
        public string? ErrorMessage { get; set; }
        public string? CurrentParticipantName { get; set; }
    }

    public enum SessionWaitingState
    {
        Loading,
        Loaded,
        SessionNotFound,
        InvalidToken,
        NetworkError,
        ApiError,
        Timeout,
        ConnectionIssue,
        CriticalError
    }

    public class ParticipantData
    {
        public string Name { get; set; } = "";
        public string Country { get; set; } = "";
        public string Flag { get; set; } = "";
    }

    public class SessionValidationResponse
    {
        public bool Valid { get; set; }
        public int SessionId { get; set; }
        public string? Token { get; set; }
        public DateTime? ExpiresAt { get; set; }
        public SessionWaitingData? Session { get; set; }
        public ParticipantInfo? Participant { get; set; }
        public string? RequestId { get; set; }
    }

    public class SessionWaitingData
    {
        public int SessionId { get; set; }
        public string? Title { get; set; }
        public string? Description { get; set; }
        public string? Status { get; set; }
        public int ParticipantCount { get; set; }
        public int? MaxParticipants { get; set; }
        public DateTime? StartedAt { get; set; }
        public DateTime? CreatedAt { get; set; }
        public string? InstructorName { get; set; } // Database-driven instructor name
        
        // PHASE 2 FIX: Real API properties for KSESSIONS data
        public DateTime? StartTime { get; set; } // Real SessionDate from KSESSIONS database
        public TimeSpan? Duration { get; set; } // Real duration from API (not hard-coded "1 hour")

        // Host Session Opener custom scheduling fields - Issue sessionopener
        public string? ScheduledDate { get; set; }    // Date: 09/28/2025 (custom from host form)
        public string? ScheduledTime { get; set; }    // Time: 6:00 AM (custom from host form)  
        public string? ScheduledDuration { get; set; } // Duration: 60 minutes (custom from host form)
    }

    public class ParticipantInfo
    {
        public string? JoinUrl { get; set; }
        public int AccessCount { get; set; }
        public DateTime? LastAccessedAt { get; set; }
    }

    public class ParticipantsResponse
    {
        public int SessionId { get; set; }
        public string? Token { get; set; }
        public int ParticipantCount { get; set; }
        public List<ParticipantApiData>? Participants { get; set; }
        public string? RequestId { get; set; }
    }

    public class ParticipantApiData
    {
        public string UserId { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public DateTime JoinedAt { get; set; }
        public string Role { get; set; } = "";
        public string? City { get; set; }
        public string? Country { get; set; }
        public string? CountryFlag { get; set; } // Database-driven flag code
    }

    public class ParticipantMeResponse
    {
        public string? Name { get; set; }
        public string? UserGuid { get; set; }
        public string? Email { get; set; }
        public string? City { get; set; }
        public string? Country { get; set; }
        public DateTime JoinedAt { get; set; }
        public DateTime LastSeenAt { get; set; }
    }
}