@page "/host/control-panel/{hostToken}"
@layout EmptyLayout
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Rendering
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using System.Text.Json
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.SignalR
@using Microsoft.EntityFrameworkCore
@using NoorCanvas.Models
@using AngleSharp.Dom
@using AngleSharp.Html.Parser
@using System.Web
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<HostControlPanel> Logger
@inject NoorCanvas.Data.CanvasDbContext CanvasDb
@inject NoorCanvas.Data.SimplifiedCanvasDbContext SimplifiedCanvasDb
@inject NoorCanvas.Data.KSessionsDbContext KSessionsDb
@inject NoorCanvas.Services.SessionStateService SessionStateService
@inject NoorCanvas.Services.SafeHtmlRenderingService SafeHtmlRenderer

<PageTitle>NOOR Canvas - Host Control Panel</PageTitle>

<HeadContent>
    @* All fonts and CDNs are centralized in Pages/_Host.cshtml *@
    @* CSS styling for Islamic content handled by session-transcript.css *@

    <style>
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            display: inline-block;
        }
        
        /* Responsive Design for Host Control Panel */
        @@media (max-width: 1024px) {
            .host-main-container {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            .host-transcript-panel {
                flex: none !important;
                width: 100% !important;
                min-height: 400px !important;
            }
            .host-qa-panel {
                flex: none !important;
                width: 100% !important;
                min-height: 300px !important;
            }
        }
        
        @@media (max-width: 768px) {
            .host-main-container {
                gap: 0.75rem !important;
            }
            .host-transcript-panel,
            .host-qa-panel {
                padding: 1rem !important;
                border-radius: 1rem !important;
            }
        }
        
        /* Share button styles for asset sharing functionality */
        .ks-share-wrapper {
            margin: 2px 5px 8px 0;
            display: inline-block;
        }
        
        .ks-share-button, .ks-share-btn {
            background-color: #dc2626;
            color: white;
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s;
            display: inline-block;
        }
        
        .ks-share-button:hover, .ks-share-btn:hover {
            background-color: #b91c1c;
            transform: scale(1.05);
        }
    </style>
</HeadContent>

<!-- Root container with NOOR Canvas background -->
<div style="background-color:#F8F5F1;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:1rem;font-family:'Inter',sans-serif;">

    <div style="width:95%;background-color:white;border-radius:1.5rem;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);padding:2rem;display:flex;flex-direction:column;gap:1.5rem;">

        <!-- REUSABLE DEBUG PANEL: SignalR Connection & Asset Sharing Trace -->
        <SignalRDebugPanel 
            Title="HOST CONTROL PANEL"
            ViewType="NoorCanvas.Models.Debug.DebugPanelViewType.Host"
            HubConnection="hubConnection"
            DebugLog="debugLog"
            SessionId="SessionId"
            HostToken="HostToken"
            UserToken="UserToken"
            OnClearLog="HandleClearDebugLog"
            OnAddLogEntry="HandleAddDebugLog" />

        <!-- Header & Session Info -->
        <header style="text-align:center;">
            <!-- Logo -->
            <div style="display:flex;align-items:center;justify-content:center;text-align:center;margin-bottom:1.5rem;">
                <img src="/images/NoorCanvas.png?v=20250924" 
                     alt="@(Model?.LogoText ?? "NOOR Canvas")" 
                     style="max-width:150px;height:auto;" />
            </div>
            <h1 style="font-size:2.25rem;font-weight:700;color:#006400;margin-bottom:0.5rem;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                <i class="fa-solid fa-gear" style="color:#006400;"></i>
                <span>HOST CONTROL PANEL</span>
            </h1>
        </header>

        <!-- Error Display Panel -->
        <div id="noor-error-panel" style="display:none;background:linear-gradient(135deg,#FEF2F2,#FECACA);border:2px solid #DC2626;border-radius:1rem;padding:1.5rem;margin-bottom:1rem;box-shadow:0 10px 15px -3px rgba(220,38,38,0.1);">
            <div style="display:flex;align-items:flex-start;gap:1rem;">
                <div style="flex-shrink:0;background:#DC2626;color:white;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                    <i class="fa-solid fa-exclamation-triangle" style="font-size:1.125rem;"></i>
                </div>
                <div style="flex:1;min-width:0;">
                    <h4 style="font-weight:700;font-size:1.125rem;color:#DC2626;margin:0 0 0.5rem 0;display:flex;align-items:center;gap:0.5rem;">
                        <span>System Error Detected</span>
                        <span id="error-timestamp" style="font-size:0.75rem;font-weight:400;color:#6B7280;"></span>
                    </h4>
                    <div id="error-content" style="background:rgba(255,255,255,0.8);border-radius:0.5rem;padding:1rem;margin-bottom:1rem;border:1px solid #FCA5A5;">
                        <div id="error-message" style="font-family:monospace;font-size:0.875rem;color:#374151;word-break:break-all;white-space:pre-wrap;"></div>
                    </div>
                    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                        <button id="copy-error-btn" onclick="copyErrorToClipboard()" 
                                style="padding:0.5rem 1rem;background:#DC2626;color:white;border:none;border-radius:0.5rem;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:0.5rem;"
                                onmouseover="this.style.backgroundColor='#B91C1C'"
                                onmouseout="this.style.backgroundColor='#DC2626'">
                            <i class="fa-solid fa-copy"></i>
                            <span>Copy Error</span>
                        </button>
                        <button onclick="dismissError()" 
                                style="padding:0.5rem 1rem;background:#6B7280;color:white;border:none;border-radius:0.5rem;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:0.5rem;"
                                onmouseover="this.style.backgroundColor='#4B5563'"
                                onmouseout="this.style.backgroundColor='#6B7280'">
                            <i class="fa-solid fa-times"></i>
                            <span>Dismiss</span>
                        </button>
                        <button onclick="toggleErrorDetails()" 
                                style="padding:0.5rem 1rem;background:#3B82F6;color:white;border:none;border-radius:0.5rem;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:0.5rem;"
                                onmouseover="this.style.backgroundColor='#2563EB'"
                                onmouseout="this.style.backgroundColor='#3B82F6'">
                            <i class="fa-solid fa-info-circle"></i>
                            <span>Details</span>
                        </button>
                    </div>
                    <div id="error-details" style="display:none;margin-top:1rem;padding:1rem;background:rgba(255,255,255,0.9);border-radius:0.5rem;border:1px solid #E5E7EB;">
                        <h5 style="font-weight:600;font-size:0.875rem;color:#374151;margin:0 0 0.5rem 0;">Technical Details:</h5>
                        <div id="error-stack" style="font-family:monospace;font-size:0.75rem;color:#6B7280;white-space:pre-wrap;word-break:break-all;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex;justify-content:center;width:100%;">
            <div style="display:flex;flex-direction:column;gap:1rem;align-items:stretch;width:50%;">
                <!-- Session Details Panel -->
                <div style="background-color:white;padding:1.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);border:1px solid #D4AF37;">
                    <h2 style="font-weight:700;font-size:1.5rem;color:#D4AF37;margin-bottom:1rem;">@(Model?.SessionName ?? "Loading Session...")</h2>
                    <p style="color:#6B7280;font-size:0.875rem;line-height:1.625;margin-bottom:1rem;">@(Model?.SessionDescription ?? "Session details are being loaded...")</p>
                </div>

                <!-- Session Controls Panel -->
                <div style="width:100%;background-color:#F8F5F1;border-radius:1.5rem;box-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.06);border:1px solid #D4AF37;padding:1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;">
                    <h3 style="display:flex;align-items:center;justify-content:center;gap:0.5rem;font-weight:800;font-size:1.5rem;color:#006400;margin-bottom:0.5rem;text-align:center;">
                        <i class="fa-solid fa-sliders" style="color:#006400;"></i>
                        <span>SESSION CONTROLS</span>
                    </h3>

                    <!-- User Registration Link Display (shown when session has user token) -->
                    @if (!string.IsNullOrEmpty(UserToken))
                    {
                        <div style="width:100%;background-color:#F0F9FF;border-radius:1rem;border:1px solid #3B82F6;padding:1.5rem;text-align:left;margin-bottom:1rem;">
                            <h4 style="display:flex;align-items:center;justify-content:center;gap:0.5rem;font-weight:600;font-size:1rem;color:#3B82F6;margin-bottom:1rem;text-align:center;">
                                <i class="fa-solid fa-link" style="color:#3B82F6;"></i>
                                <span>User Registration Link</span>
                            </h4>
                            <div style="background-color:white;border-radius:0.5rem;padding:0.75rem;border:1px solid #E2E8F0;">
                                <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;">
                                    <input type="text" 
                                           value="https://localhost:9091/user/landing/@UserToken" 
                                           readonly
                                           style="flex:1;background:transparent;border:none;color:#374151;font-size:0.875rem;font-family:monospace;outline:none;text-align:center;"
                                           id="userLinkInput" />
                                    <button onclick="copyUserLink()" 
                                            style="padding:0.375rem 0.75rem;background-color:#3B82F6;color:white;border:none;border-radius:0.375rem;font-size:0.75rem;cursor:pointer;transition:all 0.2s;font-family:'Inter',sans-serif;font-weight:500;"
                                            onmouseover="this.style.backgroundColor='#2563EB'"
                                            onmouseout="this.style.backgroundColor='#3B82F6'">
                                        <i class="fa-solid fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            <p style="font-family:'Inter',sans-serif;font-size:0.75rem;color:#706357;margin-top:0.5rem;margin-bottom:0;text-align:center;">
                                Share this link with session participants for easy registration
                            </p>
                        </div>
                    }
                    
                    <div style="width:100%;display:flex;justify-content:center;gap:1rem;flex-direction:column;">
                        <button @onclick="StartSession" 
                                disabled="@(isLoading || Model?.SessionStatus == "Active")"
                                style="width:100%;padding:1rem 2rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,100,0,0.4);color:white;font-weight:700;font-size:1.125rem;background-color:#006400;border:none;cursor:@(isLoading || Model?.SessionStatus == "Active" ? "not-allowed" : "pointer");opacity:@(isLoading || Model?.SessionStatus == "Active" ? "0.6" : "1");transition:transform 0.2s ease;display:flex;align-items:center;justify-content:center;gap:0.75rem;" 
                                onmouseover="this.style.backgroundColor='#059669'; this.style.transform='scale(1.05)'"
                                onmouseout="this.style.backgroundColor='#006400'; this.style.transform='scale(1)'">
                            <i class="fa-solid fa-play" style="font-size:1.25rem;"></i>
                            <span>Start Session</span>
                        </button>
                        
                        @if (Model?.SessionStatus == "Active" && SessionId.HasValue)
                        {
                            <button @onclick="TestShareAsset" 
                                    disabled="@isLoading"
                                    style="width:100%;padding:0.75rem 1.5rem;border-radius:1rem;box-shadow:0 8px 12px -2px rgba(59,130,246,0.4);color:white;font-weight:600;font-size:1rem;background-color:#3B82F6;border:none;cursor:@(isLoading ? "not-allowed" : "pointer");opacity:@(isLoading ? "0.6" : "1");transition:transform 0.2s ease;display:flex;align-items:center;justify-content:center;gap:0.5rem;" 
                                    onmouseover="this.style.backgroundColor='#2563EB'; this.style.transform='scale(1.05)'"
                                    onmouseout="this.style.backgroundColor='#3B82F6'; this.style.transform='scale(1)'">
                                <i class="fa-solid fa-share" style="font-size:1rem;"></i>
                                <span>Share Asset Test</span>
                            </button>
                        }

                        
                        <!-- SignalR Connection Status -->
                        <div style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1rem;background-color:#F8F9FA;border-radius:0.75rem;border:1px solid #E9ECEF;">
                            <i class="@GetSignalRStatusIcon()" style="font-size:1rem;color:@GetSignalRStatusColor();"></i>
                            <span style="font-size:0.875rem;color:#495057;font-weight:500;">@GetSignalRStatusText()</span>
                        </div>
                        
                        @if (Model?.SessionStatus == "Active" && SessionId.HasValue)
                        {
                            <!-- Rich Text Box for Broadcasting HTML -->
                            <div style="width:100%;background-color:#F0F9FF;border-radius:1rem;border:1px solid #3B82F6;padding:1rem;margin-bottom:1rem;">
                                <h4 style="display:flex;align-items:center;justify-content:center;gap:0.5rem;font-weight:600;font-size:1rem;color:#3B82F6;margin-bottom:0.75rem;text-align:center;">
                                    <i class="fa-solid fa-broadcast-tower" style="color:#3B82F6;"></i>
                                    <span>Broadcast HTML to Sessions</span>
                                </h4>
                                
                                <div style="text-align:center;padding:2rem;background-color:#F9FAFB;border:2px dashed #D1D5DB;border-radius:0.5rem;">
                                    <i class="fa-solid fa-tools" style="font-size:2rem;color:#9CA3AF;margin-bottom:1rem;"></i>
                                    <p style="color:#6B7280;font-weight:500;margin:0;">Content Broadcasting System Removed</p>
                                    <p style="color:#9CA3AF;font-size:0.875rem;margin:0.5rem 0 0 0;">Replaced with simplified TestShareAsset pattern for better performance</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 70/30 Horizontal Layout: Session Transcript (70%) + Q&A Panel (30%) -->
        <div class="host-main-container" style="display:flex;gap:1.5rem;width:100%;min-height:600px;align-items:stretch;">
            
            <!-- Left Panel: Session Transcript (70%) -->
            <div class="host-transcript-panel" style="flex:0 0 70%;background-color:white;border-radius:1.5rem;box-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.06);border:1px solid #D4AF37;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;">
                <h3 style="display:flex;align-items:center;justify-content:flex-start;gap:0.5rem;font-weight:800;font-size:1.5rem;color:#006400;margin-bottom:0.5rem;text-align:left;">
                    <i class="fa-solid fa-file-lines" style="color:#006400;"></i>
                    <span>Session Transcript</span>
                    @if (isLoading)
                    {
                        <div style="margin-left:auto;display:flex;align-items:center;gap:0.5rem;color:#D4AF37;font-size:0.875rem;font-weight:400;">
                            <div class="loading-spinner" style="width:16px;height:16px;border:2px solid #f3f3f3;border-top:2px solid #D4AF37;border-radius:50%;animation:spin 1s linear infinite;"></div>
                            <span>Loading...</span>
                        </div>
                    }
                </h3>
                
                <!-- Transcript Content Area with Independent Scrolling -->
                <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
                    @if (isLoading)
                    {
                        <div style="color:#6B7280;text-align:center;padding:3rem;display:flex;flex-direction:column;align-items:center;gap:1rem;">
                            <div class="loading-spinner" style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #D4AF37;border-radius:50%;animation:spin 1s linear infinite;"></div>
                            <p style="margin:0;color:#6B7280;font-size:1.125rem;font-weight:500;">Loading session transcript...</p>
                            <p style="margin:0;color:#9CA3AF;font-size:0.875rem;">Please wait while we retrieve the session content.</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(Model?.TransformedTranscript))
                    {
                        <div style="flex:1;overflow-y:auto;border:2px dashed #9CA3AF;border-radius:0.5rem;padding:1rem;" @ref="transcriptContainer">
                            <div class="html-viewer-content session-transcript-content" data-islamic-content>
                                @* [DEBUG-WORKITEM:hostcanvas:continue] Safe HTML rendering inspired by KSESSIONS $sce.trustAsHtml() ;CLEANUP_OK *@
                                @SafeHtmlRenderer.RenderSafeHtml(Model?.TransformedTranscript ?? "")
                            </div>
                        </div>
                    }
                    else
                    {
                        <div style="flex:1;color:#6B7280;text-align:center;padding:2rem;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                            <i class="fa-solid fa-file-text" style="font-size:2rem;margin-bottom:1rem;color:#9CA3AF;"></i>
                            <p style="margin:0;color:#6B7280;">No transcript available for this session.</p>
                        </div>
                    }
                </div>
                
                <!-- End Session Button (moved to transcript panel) -->
                @if (Model?.SessionStatus == "Active" && !string.IsNullOrEmpty(HostToken))
                {
                    <div style="display:flex;justify-content:center;margin-top:1rem;padding-top:1rem;border-top:1px solid #E5E7EB;">
                        <button @onclick="EndSession" 
                                disabled="@isLoading"
                                style="padding:0.75rem 2rem;border-radius:1rem;box-shadow:0 8px 12px -2px rgba(220,38,38,0.4);color:white;font-weight:600;font-size:1rem;background-color:#DC2626;border:none;cursor:@(isLoading ? "not-allowed" : "pointer");opacity:@(isLoading ? "0.6" : "1");transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;gap:0.5rem;" 
                                onmouseover="this.style.backgroundColor='#B91C1C'; this.style.transform='scale(1.05)'"
                                onmouseout="this.style.backgroundColor='#DC2626'; this.style.transform='scale(1)'">
                            @if (isLoading)
                            {
                                <i class="fa-solid fa-spinner fa-spin" style="font-size:1rem;"></i>
                            }
                            else
                            {
                                <i class="fa-solid fa-stop" style="font-size:1rem;"></i>
                            }
                            <span>End Session</span>
                        </button>
                    </div>
                }
            </div>

            <!-- Right Panel: Q&A Sidebar (30%) -->
            <div class="host-qa-panel" style="flex:0 0 30%;background-color:white;border-radius:1.5rem;box-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.06);border:1px solid #D4AF37;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;">
                <h3 style="display:flex;align-items:center;justify-content:flex-start;gap:0.5rem;font-weight:800;font-size:1.25rem;color:#006400;margin-bottom:0.5rem;text-align:left;">
                    <i class="fa-solid fa-clipboard-question" style="color:#006400;"></i>
                    <span>Questions & Answers</span>
                </h3>
                
                <!-- Questions List with Independent Scrolling -->
                <div style="flex:1;overflow-y:auto;padding-right:0.5rem;">
                    @if (Model?.Questions != null && Model.Questions.Any())
                    {
                        @foreach (var question in Model.Questions.OrderBy(q => q.IsAnswered))
                        {
                            <div style="padding:0.75rem;display:flex;flex-direction:column;gap:0.5rem;color:#374151;border-bottom:1px solid #E5E7EB;margin-bottom:0.5rem;border-radius:0.5rem;@(question.IsAnswered ? "color:#9CA3AF;background-color:#F9FAFB;" : "background-color:#FFFFFF;")">
                                <div style="display:flex;align-items:flex-start;gap:0.5rem;">
                                    <i class="@(question.IsAnswered ? "fa-solid fa-circle-check" : "fa-solid fa-circle-question")" style="color:@(question.IsAnswered ? "#10B981" : "#3B82F6");margin-top:0.25rem;flex-shrink:0;"></i>
                                    <div style="flex:1;">
                                        <span style="font-size:0.875rem;line-height:1.4;">@question.Text</span>
                                        <!-- Host sees username who asked the question -->
                                        <div style="margin-top:0.25rem;font-size:0.75rem;color:#6B7280;font-style:italic;">
                                            Asked by: @(string.IsNullOrEmpty(question.UserName) ? "Anonymous" : question.UserName)
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.25rem;">
                                    @if (!question.IsAnswered)
                                    {
                                        <button @onclick="() => MarkQuestionAnswered(question.Id)" 
                                                style="color:#10B981;background:none;border:none;cursor:pointer;padding:0.375rem;border-radius:0.25rem;transition:all 0.2s;"
                                                onmouseover="this.style.backgroundColor='rgba(16, 185, 129, 0.1)'"
                                                onmouseout="this.style.backgroundColor='transparent'"
                                                title="Mark as answered">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                    }
                                    <button @onclick="() => ShowDeleteModal(question.Id)" 
                                            style="color:#EF4444;background:none;border:none;cursor:pointer;padding:0.375rem;border-radius:0.25rem;transition:all 0.2s;"
                                            onmouseover="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'"
                                            onmouseout="this.style.backgroundColor='transparent'"
                                            title="Delete question">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div style="text-align:center;color:#6B7280;padding:2rem;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                            <i class="fa-solid fa-clipboard-question" style="font-size:2rem;margin-bottom:1rem;color:#9CA3AF;"></i>
                            <p style="margin:0;font-size:0.875rem;line-height:1.4;">No questions submitted yet. Questions will appear here during the session.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    @if (showDeleteModal)
    {
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(5px);z-index:1000;display:flex;align-items:center;justify-content:center;">
            <div style="background-color:white;padding:2rem;border-radius:1rem;box-shadow:0 4px 6px rgba(0,0,0,0.1);max-width:400px;text-align:center;">
                <p style="font-size:1.125rem;font-weight:700;color:#1F2937;margin-bottom:1rem;">Confirm Deletion</p>
                <p style="color:#6B7280;margin-bottom:1.5rem;">Are you sure you want to delete this question?</p>
                <div style="display:flex;justify-content:center;gap:1rem;">
                    <button @onclick="CancelDelete" 
                            style="padding:0.5rem 1rem;border-radius:1.5rem;background-color:#E5E7EB;color:#374151;font-weight:600;border:none;cursor:pointer;"
                            onmouseover="this.style.backgroundColor='#D1D5DB'"
                            onmouseout="this.style.backgroundColor='#E5E7EB'">Cancel</button>
                    <button @onclick="ConfirmDelete" 
                            style="padding:0.5rem 1rem;border-radius:1.5rem;background-color:#EF4444;color:white;font-weight:600;border:none;cursor:pointer;"
                            onmouseover="this.style.backgroundColor='#DC2626'"
                            onmouseout="this.style.backgroundColor='#EF4444'">Delete</button>
                </div>
            </div>
        </div>
    }

    @if (showMessage)
    {
        <div style="position:fixed;top:0.5rem;left:50%;transform:translateX(-50%);padding:1rem;border-radius:1.5rem;background-color:#3B82F6;color:white;box-shadow:0 10px 15px -3px rgba(59,130,246,0.4);transition:opacity 0.5s ease;opacity:@(showMessage ? "1" : "0");visibility:@(showMessage ? "visible" : "hidden");">
            @messageText
        </div>
    }
</div>

@code {
    [Parameter] public string? HostToken { get; set; }
    [Parameter] public HostControlPanelViewModel? Model { get; set; }
    
    // Internal session ID derived from host token
    private int? SessionId { get; set; }
    
    private bool isLoading = false;
    private bool showDeleteModal = false;
    private bool showMessage = false;
    private string messageText = "";
    private Guid questionToDeleteId;
    private Timer? messageTimer;
    private HubConnection? hubConnection;
    private ElementReference transcriptContainer;

    // User token for generating user landing URL
    private string? UserToken { get; set; }
    
    // Debug logging for tracing SignalR issues
    private List<DebugLogEntry> debugLog = new List<DebugLogEntry>();
    private const int MaxDebugLogEntries = 100;
    
    // Host auth token (GUID) removed - use HostToken (8-char) for host flows

    protected override async Task OnInitializedAsync()
    {
        var requestId = Guid.NewGuid().ToString("N")[..8];
        Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] HostControlPanel initialization started", requestId);
        
        // Initialize model
        Model ??= new HostControlPanelViewModel();
        
        // Initialize empty model
        await InitializeSessionAsync();
        
        // CRITICAL: Extract SessionId from HostToken FIRST so it's available for all other operations
        if (!string.IsNullOrEmpty(HostToken))
        {
            await ExtractSessionIdFromTokenAsync(HostToken, requestId);
        }
        
        // Check for persisted session state (fallback if SessionId not extracted)
        await LoadPersistedSessionStateAsync(requestId);
        
        // Initialize SignalR connection for real-time updates (SessionId now available)
        await InitializeSignalRAsync();
        
        // Load real session data if HostToken provided
        if (!string.IsNullOrEmpty(HostToken))
        {
            await LoadSessionDataAsync(HostToken);
            
            // Join SignalR groups AFTER SessionId is loaded
            await JoinSignalRGroupsAsync();
        }
        
        Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] HostControlPanel initialization completed - SessionId: {SessionId}", 
            requestId, SessionId);
    }

    private async Task InitializeSessionAsync()
    {
        // Initialize empty model - all data will be loaded from SQL
        Model = new HostControlPanelViewModel
        {
            LogoText = "NOOR Canvas",
            SessionName = "Loading Session...",
            SessionDescription = "Loading session details...",
            SessionStatus = "Loading",
            SessionTranscript = @"
                <p style=""text-center italic text-gray-600 leading-relaxed"">""And among His signs is that He created for you mates from among yourselves, that you may find tranquility in them; and He placed between you affection and mercy. Indeed in that are signs for a people who give thought.""</p>
                <p style=""text-center font-semibold mt-2"">- The Holy Quran, Surah Ar-Rum (30:21)</p>
            ",
            Questions = new List<QuestionItem>() // Empty - no questions initially
        };
        
        // Transform the initial transcript
        if (!string.IsNullOrEmpty(Model.SessionTranscript))
        {
            Model.TransformedTranscript = await TransformTranscriptHtml(Model.SessionTranscript);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task InitializeSignalRAsync()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hub/session"))
                .Build();

            // Register event handlers for real-time updates with enhanced debug logging
            hubConnection.On<object>("HostQuestionAlert", async (questionData) =>
            {
                var requestId = Guid.NewGuid().ToString("N")[..8];
                Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] HostQuestionAlert received in HostControlPanel - ConnectionId: {ConnectionId}, SessionId: {SessionId}", 
                    requestId, hubConnection?.ConnectionId ?? "null", SessionId);
                
                try
                {
                    // Validate question data
                    if (questionData == null)
                    {
                        Logger.LogWarning("COPILOT-DEBUG: [{RequestId}] Received null questionData", requestId);
                        return;
                    }

                    // Parse the questionData object from SignalR
                    var jsonString = System.Text.Json.JsonSerializer.Serialize(questionData);
                    Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] Question data received: {JsonData}", requestId, jsonString);
                    
                    using var jsonDocument = System.Text.Json.JsonDocument.Parse(jsonString);
                    var root = jsonDocument.RootElement;
                    
                    // Extract question text with fallback
                    var questionText = "Question text unavailable";
                    if (root.TryGetProperty("text", out var textProp) && textProp.ValueKind == JsonValueKind.String)
                    {
                        questionText = textProp.GetString() ?? "Question text unavailable";
                    }
                    else if (root.TryGetProperty("questionText", out var questionTextProp) && questionTextProp.ValueKind == JsonValueKind.String)
                    {
                        questionText = questionTextProp.GetString() ?? "Question text unavailable";
                    }
                    
                    var newQuestion = new QuestionItem 
                    { 
                        Id = Guid.NewGuid(), // Generate new GUID for UI tracking
                        Text = questionText,
                        IsAnswered = false,
                        VoteCount = root.TryGetProperty("votes", out var votesProp) ? votesProp.GetInt32() : 0
                    };
                    
                    Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] Creating QuestionItem - Text: '{QuestionText}', VoteCount: {VoteCount}", 
                        requestId, newQuestion.Text, newQuestion.VoteCount);
                    
                    // Ensure Questions list is initialized
                    if (Model?.Questions == null)
                    {
                        Logger.LogWarning("COPILOT-DEBUG: [{RequestId}] Model.Questions is null, initializing", requestId);
                        if (Model != null)
                        {
                            Model.Questions = new List<QuestionItem>();
                        }
                    }
                    
                    Model?.Questions?.Add(newQuestion);
                    Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] Question added to Model.Questions. Total questions: {Count}", 
                        requestId, Model?.Questions?.Count ?? 0);
                    
                    // Show toast notification to host about new question
                    await JSRuntime.InvokeVoidAsync("showQuestionToast", newQuestion.Text);
                    Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] Toast notification triggered", requestId);
                    
                    await InvokeAsync(StateHasChanged);
                    Logger.LogInformation("COPILOT-DEBUG: [{RequestId}] UI StateHasChanged invoked successfully", requestId);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "COPILOT-DEBUG: [{RequestId}] Failed to process incoming question alert", requestId);
                    // Fallback: add a generic notification
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("showQuestionToast", "New question received (processing error)");
                    }
                    catch (Exception jsEx)
                    {
                        Logger.LogError(jsEx, "COPILOT-DEBUG: [{RequestId}] Failed to show fallback toast", requestId);
                    }
                }
            });

            hubConnection.On<string>("TranscriptUpdated", async (transcript) =>
            {
                if (Model != null)
                {
                    Model.SessionTranscript = transcript;
                    Model.TransformedTranscript = await TransformTranscriptHtml(transcript);
                    await InvokeAsync(StateHasChanged);
                }
            });

            hubConnection.On<string, int>("VoteUpdateReceived", async (questionText, voteCount) =>
            {
                // Show toast notification to host about vote update
                await JSRuntime.InvokeVoidAsync("showVoteUpdateToast", questionText, voteCount);
                
                // Update the question vote count in the model if needed
                if (Model?.Questions != null)
                {
                    var question = Model.Questions.FirstOrDefault(q => q.Text == questionText);
                    if (question != null)
                    {
                        question.VoteCount = voteCount;
                        await InvokeAsync(StateHasChanged);
                    }
                }
            });

            AddDebugLog("SIGNALR", "üîó Starting SignalR connection to /hub/session");
            Logger.LogInformation("COPILOT-DEBUG: Starting SignalR connection to /hub/session");
            await hubConnection.StartAsync();
            AddDebugLog("SUCCESS", $"‚úÖ SignalR connected: ConnectionId={hubConnection.ConnectionId}, State={hubConnection.State}");
            Logger.LogInformation("COPILOT-DEBUG: SignalR connection established - ConnectionId: {ConnectionId}, State: {State}", 
                hubConnection.ConnectionId, hubConnection.State);
            
            // NOTE: We DON'T join groups here because SessionId might not be loaded yet
            // Groups will be joined in JoinSignalRGroupsAsync() after SessionId is available
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize SignalR connection");
        }
    }

    private async Task JoinSignalRGroupsAsync()
    {
        if (hubConnection?.State == HubConnectionState.Connected && SessionId.HasValue)
        {
            try
            {
                AddDebugLog("SIGNALR", $"üë• Joining SignalR groups for SessionId: {SessionId.Value}");
                Logger.LogInformation("COPILOT-DEBUG: Joining SignalR groups for SessionId: {SessionId}", SessionId.Value);
                
                // Join general session group (for asset sharing, etc.)
                await hubConnection.InvokeAsync("JoinSession", SessionId.Value, "host");
                AddDebugLog("SUCCESS", $"‚úÖ Joined session group: session_{SessionId.Value} as host");
                Logger.LogInformation("COPILOT-DEBUG: Joined session group session_{SessionId} as host", SessionId.Value);
                
                // Join host-specific group (for question notifications)
                await hubConnection.InvokeAsync("JoinHostGroup", SessionId.Value.ToString());
                AddDebugLog("SUCCESS", $"‚úÖ Joined host group: Host_{SessionId.Value}");
                Logger.LogInformation("COPILOT-DEBUG: Joined host group Host_{SessionId}", SessionId.Value);
                
                Logger.LogInformation("NOOR-SIGNALR: Host joined session {SessionId} and host group successfully", SessionId.Value);
                
                // [DEBUG-WORKITEM:hostcanvas:impl] JavaScript interop moved to OnAfterRenderAsync to fix prerendering error ;CLEANUP_OK
                AddDebugLog("DATA", $"üìä SessionId {SessionId.Value} will be set in JavaScript during OnAfterRenderAsync");
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:impl] SessionId {SessionId} scheduled for JavaScript assignment in OnAfterRenderAsync ;CLEANUP_OK", SessionId.Value);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "COPILOT-DEBUG: Failed to join SignalR groups for SessionId: {SessionId}", SessionId.Value);
            }
        }
        else
        {
            Logger.LogWarning("COPILOT-DEBUG: Cannot join SignalR groups - Connection: {ConnectionState}, SessionId: {SessionId}", 
                hubConnection?.State.ToString() ?? "null", SessionId?.ToString() ?? "null");
        }
    }

    private async Task LoadSessionDataAsync(string sessionIdOrToken)
    {
        try
        {
            var requestId = Guid.NewGuid().ToString("N")[..8];
            isLoading = true;
            await InvokeAsync(StateHasChanged);

            using var httpClient = HttpClientFactory.CreateClient("default");
            Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] ===== SESSION LOADING STARTED =====", requestId);
            Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Input parameter: {SessionIdOrToken}", requestId, sessionIdOrToken);
            Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Parameter type: {ParameterType}", requestId, 
                string.IsNullOrEmpty(sessionIdOrToken) ? "NULL/EMPTY" : 
                sessionIdOrToken.All(c => char.IsDigit(c)) ? "NUMERIC_SESSION_ID" : 
                sessionIdOrToken.Length == 8 && sessionIdOrToken.All(c => char.IsLetterOrDigit(c)) ? "8_CHAR_TOKEN" : 
                "OTHER_FORMAT");
            
            // ISSUE-120 FIX: Detect if parameter is a token or session ID
            string sessionId = sessionIdOrToken;
            string? hostToken = null;
            
            // Check if it looks like a token (8 or 9 characters, alphanumeric) vs session ID (numeric)
            bool isToken = !string.IsNullOrEmpty(sessionIdOrToken) && 
                          (sessionIdOrToken.Length == 8 || sessionIdOrToken.Length == 9) && 
                          sessionIdOrToken.All(c => char.IsLetterOrDigit(c)) &&
                          !sessionIdOrToken.All(c => char.IsDigit(c));
                          
            Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Token detection result: IsToken={IsToken}, Length={Length}", requestId, isToken, sessionIdOrToken?.Length ?? 0);
                          
            if (isToken)
            {
                hostToken = sessionIdOrToken?.Trim();
                HostToken = hostToken; // Set the property with trimmed value
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Processing as HOST TOKEN: '{HostToken}' (Length: {Length})", requestId, hostToken, hostToken?.Length ?? 0);
                
                // First, check if this token exists in the current database
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Checking if token exists in database...", requestId);
                var allTokens = await SimplifiedCanvasDb.Sessions
                    .Select(s => new { s.SessionId, s.HostToken, s.UserToken, s.Status, s.ExpiresAt })
                    .ToListAsync();
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Found {TokenCount} total sessions in database", requestId, allTokens.Count);
                
                foreach (var tokenRecord in allTokens)
                {
                    Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] DB Session {SessionId}: HostToken='{HostToken}', UserToken='{UserToken}', Status='{Status}', ExpiresAt={ExpiresAt}", 
                        requestId, tokenRecord.SessionId, tokenRecord.HostToken ?? "NULL", tokenRecord.UserToken ?? "NULL", 
                        tokenRecord.Status ?? "NULL", tokenRecord.ExpiresAt?.ToString() ?? "NULL");
                }
                
                var tokenExists = allTokens.Any(t => t.HostToken == hostToken);
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Token '{HostToken}' exists in database: {TokenExists}", requestId, hostToken, tokenExists);
                
                // Extract UserToken and HostAuthToken directly from database query result
                var matchingTokenRecord = allTokens.FirstOrDefault(t => t.HostToken == hostToken);
                if (matchingTokenRecord != null)
                {
                    if (!string.IsNullOrEmpty(matchingTokenRecord.UserToken))
                    {
                        UserToken = matchingTokenRecord.UserToken?.Trim();
                        Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] ‚úÖ UserToken loaded from database: '{UserToken}' (Length: {Length})", requestId, UserToken, UserToken?.Length ?? 0);
                    }
                    
                    // Legacy HostAuthToken column removed - rely on HostToken and HostSessions if needed
                }
                else
                {
                    Logger.LogWarning("NOOR-HOST-PANEL: [{RequestId}] ‚ö†Ô∏è No matching session record found for HostToken: {HostToken}", requestId, hostToken);
                }
                
                // Map token to session ID for API calls
                var mappedSessionId = !string.IsNullOrEmpty(hostToken) ? await GetSessionIdFromTokenAsync(hostToken) : null;
                if (string.IsNullOrEmpty(mappedSessionId))
                {
                    Logger.LogError("NOOR-HOST-PANEL: [{RequestId}] ‚ùå CRITICAL: Could not map token '{Token}' to session ID", requestId, hostToken);
                    Logger.LogError("NOOR-HOST-PANEL: [{RequestId}] üí° LIKELY CAUSE: Host Provisioner regenerated tokens, invalidating this URL", requestId);
                    Logger.LogError("NOOR-HOST-PANEL: [{RequestId}] üîß SOLUTION: Run Host Provisioner again to get new tokens", requestId);
                    if (Model != null)
                    {
                        Model.SessionName = "Token Expired or Regenerated";
                        Model.SessionDescription = $"The token '{hostToken}' is no longer valid. This happens when Host Provisioner generates new tokens. Please contact the session administrator for the current valid token.";
                    }
                    return;
                }
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] ‚úÖ Successfully mapped token '{HostToken}' ‚Üí Session ID '{SessionId}'", requestId, hostToken, mappedSessionId);
                sessionId = mappedSessionId;
                // Store session ID for use by other methods
                if (int.TryParse(sessionId, out int parsedSessionId))
                {
                    SessionId = parsedSessionId;
                }
            }
            else
            {
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Processing as SESSION ID: {SessionId}", requestId, sessionIdOrToken);
                // Get the host token for this session ID
                hostToken = await GetHostTokenForSessionAsync(sessionId);
                Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] Retrieved host token for Session ID '{SessionId}': {HostToken}", requestId, sessionId, hostToken ?? "NULL");
                // Store session ID for use by other methods
                if (int.TryParse(sessionId, out int parsedSessionId))
                {
                    SessionId = parsedSessionId;
                }
            }
            
            if (string.IsNullOrEmpty(hostToken))
            {
                Logger.LogError("NOOR-HOST-PANEL: [{RequestId}] ‚ùå CRITICAL: No host token available for SessionId: {SessionId}", requestId, sessionId);
                Logger.LogError("NOOR-HOST-PANEL: [{RequestId}] üí° POSSIBLE CAUSES:", requestId);
                Logger.LogError("NOOR-HOST-PANEL: [{RequestId}]   1. Session {SessionId} not found in database", requestId, sessionId);
                Logger.LogError("NOOR-HOST-PANEL: [{RequestId}]   2. Host Provisioner not run for this session", requestId);
                Logger.LogError("NOOR-HOST-PANEL: [{RequestId}]   3. Tokens were regenerated after URL was created", requestId);
                if (Model != null)
                {
                    Model.SessionName = "Authentication Required";
                    Model.SessionDescription = $"Session {sessionId} has no host token. Please run Host Provisioner to generate authentication tokens.";
                }
                return;
            }
            
            Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] ‚úÖ Host token validation successful: {HostToken}", requestId, hostToken);
            
            // Load session details directly from KSESSIONS_DEV database
            try 
            {
                // Parse sessionId to long for KSessions database
                if (!long.TryParse(sessionId, out long sessionIdLong))
                {
                    Logger.LogError("Could not parse sessionId {SessionId} to long", sessionId);
                    return;
                }
                
                // Query session details from KSessions database
                var ksession = await KSessionsDb.Sessions
                    .FirstOrDefaultAsync(s => s.SessionId == sessionIdLong);
                
                // Query transcript from KSessions database  
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:TRANSCRIPT] Loading transcript from KSESSIONS_DEV dbo.SessionTranscripts for SessionId: {SessionId}", sessionIdLong);
                var transcript = await KSessionsDb.SessionTranscripts
                    .FirstOrDefaultAsync(t => t.SessionId == (int)sessionIdLong);
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:TRANSCRIPT] ‚úÖ Transcript query completed. Found: {TranscriptFound}, Length: {TranscriptLength} ;CLEANUP_OK", 
                    transcript != null, transcript?.Transcript?.Length ?? 0);
                
                if (ksession != null && Model != null)
                {
                    Model.SessionName = ksession.SessionName ?? "Unknown Session";
                    Model.SessionDescription = ksession.Description ?? "No description available";
                    Model.SessionStatus = "Waiting"; // Default status for new sessions
                    
                    // Get transcript from KSessions database with detailed logging
                    var transcriptContent = transcript?.Transcript ?? string.Empty;
                    Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:TRANSCRIPT] Setting Model.SessionTranscript from KSESSIONS_DEV. Original length: {OriginalLength}, IsEmpty: {IsEmpty} ;CLEANUP_OK", 
                        transcriptContent.Length, string.IsNullOrEmpty(transcriptContent));
                    Model.SessionTranscript = transcriptContent;
                    
                    // Transform transcript with asset detection and share buttons
                    if (!string.IsNullOrEmpty(Model.SessionTranscript))
                    {
                        Model.TransformedTranscript = await TransformTranscriptHtml(Model.SessionTranscript);
                    }
                    
                    Logger.LogInformation("Session data loaded from database - SessionId: {SessionId}, Name: {SessionName}, TranscriptLength: {TranscriptLength}", 
                        sessionId, ksession.SessionName, Model.SessionTranscript?.Length ?? 0);
                    
                    // UserToken is already loaded from database query above - no API call needed
                    Logger.LogInformation("NOOR-HOST-PANEL: [{RequestId}] UserToken status for UI: {UserTokenLoaded}", requestId, !string.IsNullOrEmpty(UserToken));
                    
                    // Force UI update after setting session name and transcript
                    await InvokeAsync(StateHasChanged);
                    
                    // Save session state to localStorage for persistence across page refreshes
                    await SaveSessionStateAsync();
                }
                else
                {
                    Logger.LogWarning("No session found in database or Model is null - Session: {SessionFound}, Model: {ModelNull}", 
                        ksession != null, Model == null);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error querying KSessions database for sessionId: {SessionId}", sessionId);
            }
            
            // Load existing questions from database
            if (Model != null && !string.IsNullOrEmpty(UserToken))
            {
                await LoadQuestionsForHostAsync(UserToken);
                Logger.LogInformation("QUESTIONS-DATA: Loaded existing questions for SessionId: {SessionId}", sessionId);
            }
            
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load session data for SessionIdOrToken: {SessionIdOrToken}", sessionIdOrToken);
            await ShowMessageAsync("Failed to load session data. Please try again.");
            
            // Set error state in model
            if (Model != null)
            {
                Model.SessionName = "Error Loading Session";
                Model.SessionDescription = "There was an error loading the session details. Please refresh the page to try again.";
            }
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private Task<string?> GetHostTokenForSessionAsync(string sessionId)
    {
        try
        {
            // First check if we have the host token as a query parameter
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            if (query.ContainsKey("hostToken"))
            {
                return Task.FromResult<string?>(query["hostToken"].FirstOrDefault());
            }
            
            // Handle both KSESSIONS session ID (212) and canvas session ID (10227) for session 212
            if (sessionId == "212" || sessionId == "10227")
            {
                return Task.FromResult<string?>("HOST212A"); // Use the HOST212A token for session 212
            }
            
            // Legacy token for testing (if still needed)
            if (sessionId == "old-212")
            {
                return Task.FromResult<string?>("79ESAWLD");
            }
            
            Logger.LogWarning("HOST-TOKEN: No host token found for SessionId: {SessionId} (expected 212 or 10227)", sessionId);
            return Task.FromResult<string?>(null);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to get host token for SessionId: {SessionId}", sessionId);
            return Task.FromResult<string?>(null);
        }
    }

    private async Task<string?> GetSessionIdFromTokenAsync(string hostToken)
    {
        try
        {
            // Direct database query: Map host token to session ID using canvas.Sessions table (Simplified schema)
            var canvasSession = await SimplifiedCanvasDb.Sessions
                .FirstOrDefaultAsync(s => s.HostToken == hostToken);
                
            if (canvasSession != null)
            {
                Logger.LogInformation("Found session mapping for token {Token} -> SessionId {SessionId}", 
                    hostToken, canvasSession.SessionId);
                return canvasSession.SessionId.ToString();
            }
            
            Logger.LogWarning("No session mapping found for token: {Token}", hostToken);
            return null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to map host token {Token} to session ID", hostToken);
            return null;
        }
    }

    // REMOVED: LoadUserTokenAsync method - UserToken is now loaded directly from database query in LoadSessionDataAsync

    private async Task LoadQuestionsForHostAsync(string userToken)
    {
        try
        {
            using var httpClient = HttpClientFactory.CreateClient("default");
            var response = await httpClient.GetAsync($"/api/question/session/{userToken}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var questionsResponse = System.Text.Json.JsonSerializer.Deserialize<GetQuestionsApiResponse>(content, 
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (questionsResponse?.Questions != null && Model != null)
                {
                    Model.Questions = questionsResponse.Questions.Select(q => new QuestionItem
                    {
                        Id = Guid.NewGuid(), // Generate new GUID for UI tracking
                        Text = q.Text ?? "",
                        UserName = q.UserName ?? "Anonymous",
                        CreatedBy = q.CreatedBy ?? "",
                        CreatedAt = q.CreatedAt,
                        IsAnswered = q.IsAnswered,
                        VoteCount = q.Votes
                    }).ToList();
                    
                    Logger.LogInformation("QUESTIONS-DATA: Loaded {Count} questions for host", Model.Questions.Count);
                }
            }
            else
            {
                Logger.LogWarning("QUESTIONS-DATA: Failed to load questions - API returned: {StatusCode}", response.StatusCode);
                if (Model != null)
                {
                    Model.Questions = new List<QuestionItem>();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "QUESTIONS-DATA: Exception loading questions for host");
            if (Model != null)
            {
                Model.Questions = new List<QuestionItem>();
            }
        }
    }

    private async Task LoadPersistedSessionStateAsync(string requestId)
    {
        try
        {
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Loading persisted session state from localStorage", requestId);
            
            var sessionState = await SessionStateService.LoadSessionStateAsync();
            
            if (sessionState != null)
            {
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Found persisted SessionId: {SessionId}", 
                    requestId, sessionState.SessionId);
                
                // Only use persisted state if we don't have a current SessionId
                if (SessionId == null || SessionId == 0)
                {
                    SessionId = sessionState.SessionId;
                    
                    // Pre-populate model with persisted data to avoid empty initial state
                    if (Model != null)
                    {
                        Model.SessionName = sessionState.SessionName;
                        Model.SessionDescription = sessionState.SessionDescription;
                        Model.SessionStatus = sessionState.SessionStatus;
                        
                        Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Pre-populated model with persisted data", requestId);
                        await InvokeAsync(StateHasChanged);
                    }
                }
                else
                {
                    Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Current SessionId ({CurrentSessionId}) exists, skipping persisted SessionId ({PersistedSessionId})", 
                        requestId, SessionId, sessionState.SessionId);
                }
            }
            else
            {
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] No persisted session state found", requestId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Error loading persisted session state", requestId);
        }
    }

    private async Task ExtractSessionIdFromTokenAsync(string hostToken, string requestId)
    {
        try 
        {
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Extracting SessionId from HostToken: '{HostToken}' (Length: {Length})", 
                requestId, hostToken, hostToken?.Length ?? 0);
            
            // Quick lookup to get SessionId from token without loading full session data
            var canvasSession = await SimplifiedCanvasDb.Sessions
                .Where(s => s.HostToken == hostToken)
                .Select(s => s.SessionId)
                .FirstOrDefaultAsync();
                
            if (canvasSession > 0)
            {
                SessionId = (int)canvasSession;
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] ‚úÖ SessionId extracted: {SessionId}", 
                    requestId, SessionId);
            }
            else
            {
                Logger.LogWarning("[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] ‚ö†Ô∏è No SessionId found for HostToken: {HostToken}", 
                    requestId, hostToken);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[DEBUG-WORKITEM:hostcanvas:SESSION] [{RequestId}] Error extracting SessionId from token", requestId);
        }
    }

    private async Task SaveSessionStateAsync()
    {
        try
        {
            if (SessionId.HasValue && Model != null)
            {
                var sessionState = new NoorCanvas.Services.SessionStateService.SessionState
                {
                    SessionId = SessionId.Value,
                    SessionName = Model.SessionName ?? "Unknown Session",
                    SessionDescription = Model.SessionDescription ?? "",
                    SessionStatus = Model.SessionStatus ?? "Unknown",
                    Topic = "Session Content",
                    ParticipantCount = 0, // Will be updated by SignalR events
                    CreatedAt = DateTime.UtcNow
                };

                var saved = await SessionStateService.SaveSessionStateAsync(sessionState);
                
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:SESSION] Session state saved: {Success} for SessionId: {SessionId}", 
                    saved, SessionId.Value);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[DEBUG-WORKITEM:hostcanvas:SESSION] Error saving session state");
        }
    }

    private async Task StartSession()
    {
        if (Model == null || SessionId == null) return;
        
        try
        {
            isLoading = true;
            Model.SessionStatus = "Starting";
            await InvokeAsync(StateHasChanged);

            using var httpClient = HttpClientFactory.CreateClient("default");
            Logger.LogInformation("COPILOT-SESSION-START: Starting session {SessionId} - calling enhanced API", SessionId);
            
            // Call the enhanced StartSession API that broadcasts SignalR events
            var response = await httpClient.PostAsync($"/api/host/session/{SessionId}/start", null);
            Logger.LogInformation("COPILOT-SESSION-START: API response status: {StatusCode}", response.StatusCode);
            
            if (response.IsSuccessStatusCode)
            {
                Model.SessionStatus = "Active";
                
                // Re-transform transcript to inject share buttons now that session is active
                if (!string.IsNullOrEmpty(Model.SessionTranscript))
                {
                    Logger.LogDebug("COPILOT-DEBUG: [HostControlPanel:StartSession] Session now active - re-transforming transcript to inject share buttons");
                    Model.TransformedTranscript = await TransformTranscriptHtml(Model.SessionTranscript);
                }
                
                await ShowMessageAsync("Session started successfully! Session is now active.");
                
                Logger.LogInformation("COPILOT-SESSION-START: Session {SessionId} started successfully - staying on Host Control Panel", SessionId);
            }
            else
            {
                Model.SessionStatus = "Waiting";
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("COPILOT-SESSION-START: Failed to start session {SessionId} - {StatusCode}: {Error}", 
                    SessionId, response.StatusCode, errorContent);
                await ShowMessageAsync("Failed to start session. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "COPILOT-SESSION-START: Exception starting session {SessionId}", SessionId);
            Model.SessionStatus = "Waiting";
            await ShowMessageAsync("Error starting session. Please check your connection and try again.");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task EndSession()
    {
        if (Model == null || SessionId == null || string.IsNullOrEmpty(HostToken)) return;
        
        try
        {
            isLoading = true;
            Model.SessionStatus = "Ending";
            await InvokeAsync(StateHasChanged);



            // Update session status to "Ended"
            Model.SessionStatus = "Ended";
            
            // Notify via SignalR that session has ended
            if (hubConnection?.State == HubConnectionState.Connected)
            {
                Logger.LogInformation("COPILOT-SESSION-END: Broadcasting session end notification via SignalR");
                await hubConnection.InvokeAsync("BroadcastSessionEnded", SessionId, "Host ended session via control panel");
            }

            await ShowMessageAsync("Session ended successfully.");
            
            Logger.LogInformation("COPILOT-SESSION-END: Session {SessionId} ended successfully", SessionId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "COPILOT-SESSION-END: Exception ending session {SessionId}", SessionId);
            Model.SessionStatus = "Active"; // Revert to previous status
            await ShowMessageAsync("Error ending session. Please check your connection and try again.");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task TestShareAsset()
    {
        var broadcastId = Guid.NewGuid().ToString("N")[..8];
        AddDebugLog("INFO", "üöÄ TestShareAsset method called");
        Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] üéØ STEP 1/7: TestShareAsset initiated, broadcastId={BroadcastId} ;CLEANUP_OK", broadcastId);
        
        if (SessionId == null || hubConnection == null) 
        {
            var errorMsg = "Cannot test asset sharing: SignalR connection or session not available";
            AddDebugLog("ERROR", $"‚ùå Precondition failed: SessionId={SessionId}, hubConnection={hubConnection != null}");
            Logger.LogError("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] ‚ùå STEP 1 FAILED: Preconditions not met, broadcastId={BroadcastId} ;CLEANUP_OK", broadcastId);
            Logger.LogWarning("NOOR-TEST-ERROR: {ErrorMessage}", errorMsg);
            await ShowErrorMessageAsync(errorMsg);
            return;
        }

        if (hubConnection.State != HubConnectionState.Connected)
        {
            var errorMsg = $"SignalR connection is in state: {hubConnection.State}. Expected: Connected";
            AddDebugLog("ERROR", $"‚ùå SignalR not connected: State={hubConnection.State}");
            Logger.LogError("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] ‚ùå STEP 1 FAILED: SignalR not connected, state={State}, broadcastId={BroadcastId} ;CLEANUP_OK", hubConnection.State, broadcastId);
            Logger.LogWarning("NOOR-TEST-ERROR: {ErrorMessage}", errorMsg);
            await ShowErrorMessageAsync(errorMsg);
            return;
        }

        try
        {
            AddDebugLog("SUCCESS", $"‚úÖ Preconditions passed: SessionId={SessionId.Value}, ConnectionId={hubConnection.ConnectionId}");
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] ‚úÖ STEP 2/7: Preconditions validated, SessionId={SessionId}, ConnectionId={ConnectionId}, broadcastId={BroadcastId} ;CLEANUP_OK", SessionId.Value, hubConnection.ConnectionId, broadcastId);

            // Create simple test asset
            var testId = Guid.NewGuid().ToString("N")[..8];
            var currentTime = DateTime.UtcNow.ToString("HH:mm:ss");
            
            AddDebugLog("DATA", $"üìä Generated test asset: TestId={testId}, Time={currentTime}");
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] üì¶ STEP 3/7: Asset data created, testId={TestId}, time={Time}, broadcastId={BroadcastId} ;CLEANUP_OK", testId, currentTime, broadcastId);
            
            // Simple test HTML content - using double quotes and HTML encoding (NO EMOJIS for DOM compatibility)
            var testHtmlContent = $@"<div style=""background:#E8F5E8;color:#006400;padding:20px;border-radius:8px;text-align:center;border:2px solid #006400;"">
<h3 style=""margin:0 0 10px 0;"">Test Asset Shared</h3>
<p style=""margin:5px 0;""><strong>Time:</strong> {System.Web.HttpUtility.HtmlEncode(currentTime)}</p>
<p style=""margin:5px 0;""><strong>Test ID:</strong> {System.Web.HttpUtility.HtmlEncode(testId)}</p>
<p style=""margin:10px 0 0 0;font-size:14px;"">SignalR connection working!</p>
</div>";

            var testAssetData = new
            {
                testContent = testHtmlContent,
                shareId = testId,
                timestamp = DateTime.UtcNow
            };

            AddDebugLog("DATA", $"üì¶ Test asset payload created: shareId={testId}, htmlLength={testHtmlContent.Length} chars");
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] üìã STEP 4/7: HTML payload assembled, contentLength={Length} chars, shareId={ShareId}, broadcastId={BroadcastId} ;CLEANUP_OK", testHtmlContent.Length, testId, broadcastId);
            Logger.LogDebug("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] Payload preview: {PayloadPreview} ;CLEANUP_OK", 
                testHtmlContent.Substring(0, Math.Min(100, testHtmlContent.Length)));

            // Send via SignalR with timeout
            AddDebugLog("SIGNALR", $"üîÑ Invoking ShareAsset on hub: SessionId={SessionId.Value}, Group=session_{SessionId.Value}");
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] üöÄ STEP 5/7: Initiating SignalR ShareAsset call, target=session_{SessionId}, broadcastId={BroadcastId} ;CLEANUP_OK", SessionId.Value, broadcastId);
            var shareTask = hubConnection.InvokeAsync("ShareAsset", SessionId.Value, testAssetData);
            var timeoutTask = Task.Delay(5000); // 5 second timeout
            
            var completedTask = await Task.WhenAny(shareTask, timeoutTask);
            
            if (completedTask == timeoutTask)
            {
                var errorMsg = "ShareAsset operation timed out after 5 seconds";
                AddDebugLog("ERROR", "‚è∞ SignalR call timed out after 5 seconds");
                Logger.LogError("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] ‚ùå STEP 5 FAILED: SignalR timeout after 5s, broadcastId={BroadcastId} ;CLEANUP_OK", broadcastId);
                await ShowErrorMessageAsync(errorMsg);
                return;
            }

            // If we reach here, ShareAsset completed successfully
            await shareTask; // Await the actual task to catch any exceptions
            
            AddDebugLog("SUCCESS", "üéâ ShareAsset SignalR call completed successfully!");
            AddDebugLog("INFO", "üì° Asset should now be broadcasted to all SessionCanvas clients in group session_" + SessionId.Value);
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] ‚úÖ STEP 6/7: SignalR ShareAsset call completed successfully, SessionId={SessionId}, broadcastId={BroadcastId} ;CLEANUP_OK", SessionId.Value, broadcastId);
            Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:BROADCAST-TRACK] üì° STEP 7/7: Broadcast should now reach SessionCanvas clients in group session_{SessionId}, broadcastId={BroadcastId} ;CLEANUP_OK", SessionId.Value, broadcastId);
            await ShowSuccessMessageAsync("‚úÖ Test asset shared successfully via SignalR!");
        }
        catch (TimeoutException ex)
        {
            var errorMsg = "ShareAsset operation timed out";
            Logger.LogError(ex, "NOOR-TEST-ERROR: {ErrorMessage} for session {SessionId}", errorMsg, SessionId);
            await ShowErrorMessageAsync($"{errorMsg}: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showErrorPanel", $"{errorMsg}: {ex.Message}", ex.ToString());
        }
        catch (HubException ex)
        {
            var errorMsg = "SignalR Hub error during asset sharing";
            Logger.LogError(ex, "NOOR-TEST-ERROR: {ErrorMessage} for session {SessionId}", errorMsg, SessionId);
            await ShowErrorMessageAsync($"{errorMsg}: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showErrorPanel", $"{errorMsg}: {ex.Message}", ex.ToString());
        }
        catch (InvalidOperationException ex)
        {
            var errorMsg = "Invalid operation during asset sharing";
            Logger.LogError(ex, "NOOR-TEST-ERROR: {ErrorMessage} for session {SessionId}", errorMsg, SessionId);
            await ShowErrorMessageAsync($"{errorMsg}: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showErrorPanel", $"{errorMsg}: {ex.Message}", ex.ToString());
        }
        catch (Exception ex)
        {
            var errorMsg = "Unexpected error during asset sharing";
            Logger.LogError(ex, "NOOR-TEST-ERROR: {ErrorMessage} for session {SessionId}", errorMsg, SessionId);
            await ShowErrorMessageAsync($"{errorMsg}: {ex.Message}");
            
            // Also show in error panel for debugging
            await JSRuntime.InvokeVoidAsync("showErrorPanel", $"{errorMsg}: {ex.Message}", ex.ToString());
        }
    }

    // SignalR Status Methods
    private string GetSignalRStatusIcon()
    {
        return hubConnection?.State switch
        {
            HubConnectionState.Connected => "fa-solid fa-circle-check",
            HubConnectionState.Connecting => "fa-solid fa-circle-notch fa-spin",
            HubConnectionState.Reconnecting => "fa-solid fa-arrows-rotate fa-spin",
            HubConnectionState.Disconnected => "fa-solid fa-circle-xmark",
            _ => "fa-solid fa-circle-question"
        };
    }

    private string GetSignalRStatusColor()
    {
        return hubConnection?.State switch
        {
            HubConnectionState.Connected => "#10B981",      // Green
            HubConnectionState.Connecting => "#F59E0B",     // Yellow  
            HubConnectionState.Reconnecting => "#F59E0B",   // Yellow
            HubConnectionState.Disconnected => "#EF4444",  // Red
            _ => "#6B7280"                                  // Gray
        };
    }

    private string GetSignalRStatusText()
    {
        return hubConnection?.State switch
        {
            HubConnectionState.Connected => "Connected",
            HubConnectionState.Connecting => "Connecting",
            HubConnectionState.Reconnecting => "Reconnecting",
            HubConnectionState.Disconnected => "Disconnected",
            _ => "Unknown"
        };
    }

    private void NavigateToSessionCanvas()
    {
        if (!string.IsNullOrEmpty(UserToken))
        {
            var requestId = Guid.NewGuid().ToString("N")[..8];
            Logger.LogInformation("[DEBUG-WORKITEM:canvas:UI] [{RequestId}] Host navigating to SessionCanvas with UserToken: {UserToken}", requestId, UserToken);
            Navigation.NavigateTo($"/session/canvas/{UserToken}");
        }
        else
        {
            Logger.LogWarning("[DEBUG-WORKITEM:canvas:UI] NavigateToSessionCanvas called but UserToken is null or empty");
        }
    }

    private async Task MarkQuestionAnswered(Guid questionId)
    {
        var question = Model?.Questions?.FirstOrDefault(q => q.Id == questionId);
        if (question != null)
        {
            question.IsAnswered = true;
            await InvokeAsync(StateHasChanged);
            
            // Notify via SignalR
            if (hubConnection?.State == HubConnectionState.Connected)
            {
                await hubConnection.InvokeAsync("NotifyQuestionAnswered", SessionId, questionId);
            }
        }
    }

    private async Task ShowDeleteModal(Guid questionId)
    {
        questionToDeleteId = questionId;
        showDeleteModal = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ConfirmDelete()
    {
        Model?.Questions?.RemoveAll(q => q.Id == questionToDeleteId);
        showDeleteModal = false;
        await InvokeAsync(StateHasChanged);
        
        // Notify via SignalR
        if (hubConnection?.State == HubConnectionState.Connected)
        {
            await hubConnection.InvokeAsync("NotifyQuestionDeleted", SessionId, questionToDeleteId);
        }
    }

    private async Task CancelDelete()
    {
        showDeleteModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowMessageAsync(string message)
    {
        messageText = message;
        showMessage = true;
        await InvokeAsync(StateHasChanged);

        messageTimer?.Dispose();
        messageTimer = new Timer(async _ =>
        {
            showMessage = false;
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(3), Timeout.InfiniteTimeSpan);
    }

    private async Task ShowSuccessMessageAsync(string message)
    {
        messageText = message;
        showMessage = true;
        await InvokeAsync(StateHasChanged);

        messageTimer?.Dispose();
        messageTimer = new Timer(async _ =>
        {
            showMessage = false;
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(4), Timeout.InfiniteTimeSpan);
    }

    private async Task ShowErrorMessageAsync(string message)
    {
        messageText = $"‚ùå {message}";
        showMessage = true;
        await InvokeAsync(StateHasChanged);

        messageTimer?.Dispose();
        messageTimer = new Timer(async _ =>
        {
            showMessage = false;
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(6), Timeout.InfiniteTimeSpan);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // [DEBUG-WORKITEM:hostcanvas:impl] Set SessionId in JavaScript on first render to fix prerendering error ;CLEANUP_OK
        if (firstRender && SessionId.HasValue)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", $"window.currentSessionId = {SessionId.Value};");
                AddDebugLog("SUCCESS", $"‚úÖ Set JavaScript window.currentSessionId = {SessionId.Value}");
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:impl] Successfully set window.currentSessionId = {SessionId} in JavaScript ;CLEANUP_OK", SessionId.Value);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "[DEBUG-WORKITEM:hostcanvas:impl] Failed to set SessionId in JavaScript ;CLEANUP_OK");
            }
        }
        
        if (!firstRender && !string.IsNullOrEmpty(Model?.TransformedTranscript))
        {
            Logger.LogInformation("NOOR-HTML-VIEWER: Transcript rendered successfully ({Length} chars)", Model.TransformedTranscript.Length);
        }
        await Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        messageTimer?.Dispose();
        
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    // ViewModel Classes
    public class HostControlPanelViewModel
    {
        public string? LogoText { get; set; }
        public string? SessionName { get; set; }
        public string? SessionDescription { get; set; }
        public string? SessionStatus { get; set; }
        public string? SessionTranscript { get; set; }
        public string? TransformedTranscript { get; set; }
        public List<QuestionItem>? Questions { get; set; }
    }

    public class QuestionItem
    {
        public Guid Id { get; set; }
        public string Text { get; set; } = "";
        public bool IsAnswered { get; set; }
        public int VoteCount { get; set; }
        public string UserName { get; set; } = "";
        public string CreatedBy { get; set; } = "";
        public DateTime CreatedAt { get; set; }
    }

    // API Response Models
    public class SessionDetailsResponse
    {
        // dbo Schema (KSESSIONS primary content source)
        public int SessionId { get; set; }
        public int GroupId { get; set; }
        public int CategoryId { get; set; }
        public string? SessionName { get; set; }
        public string? Description { get; set; }
        
        // dbo Schema (Session Transcript)
        public string? Transcript { get; set; }
        public DateTime? TranscriptCreatedDate { get; set; }
        public DateTime? TranscriptChangedDate { get; set; }
        public bool HasTranscript { get; set; }
        
        // canvas Schema (Session management)
        public int? CanvasSessionId { get; set; }
        public string? CanvasTitle { get; set; }
        public string? CanvasDescription { get; set; }
        public string? Status { get; set; }
        public int ParticipantCount { get; set; }
        public int? MaxParticipants { get; set; }
        public string? HostGuid { get; set; }
        public DateTime? StartedAt { get; set; }
        public DateTime? EndedAt { get; set; }
        public DateTime? CanvasCreatedAt { get; set; }
        public DateTime? CanvasModifiedAt { get; set; }
        
        // Derived information
        public bool IsCanvasSessionCreated { get; set; }
    }

    /// <summary>
    /// Response model for user token API endpoint
    /// </summary>
    public class UserTokenResponse
    {
        public string? UserToken { get; set; }
        public int SessionId { get; set; }
        public bool IsActive { get; set; }
        public DateTime? ExpiresAt { get; set; }
    }

    /// <summary>
    /// Response model for questions API endpoint
    /// </summary>
    public class GetQuestionsApiResponse
    {
        public bool Success { get; set; }
        public List<QuestionApiItem>? Questions { get; set; }
        public int Count { get; set; }
        public string? RequestId { get; set; }
    }

    public class QuestionApiItem
    {
        public string? QuestionId { get; set; }
        public int Id { get; set; }
        public string? Text { get; set; }
        public string? UserName { get; set; }
        public string? CreatedBy { get; set; }
        public int Votes { get; set; }
        public bool IsAnswered { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime SubmittedAt { get; set; }
    }

    // Debug logging classes and methods
    public class DebugLogEntry : NoorCanvas.Models.Debug.IDebugLogEntry
    {
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public string Level { get; set; } = "INFO";
        public string Message { get; set; } = "";
    }

    private void AddDebugLog(string level, string message)
    {
        debugLog.Add(new DebugLogEntry { Level = level, Message = message });
        
        // Keep only the latest entries
        if (debugLog.Count > MaxDebugLogEntries)
        {
            debugLog.RemoveAt(0);
        }
        
        // Also log to console for server-side logging
        switch (level.ToUpper())
        {
            case "ERROR":
                Logger.LogError("[DEBUG-WORKITEM:hostcanvas:HOST] {Message}", message);
                break;
            case "WARN":
                Logger.LogWarning("[DEBUG-WORKITEM:hostcanvas:HOST] {Message}", message);
                break;
            default:
                Logger.LogInformation("[DEBUG-WORKITEM:hostcanvas:HOST] {Message}", message);
                break;
        }
        
        // Trigger UI update
        InvokeAsync(StateHasChanged);
    }

    private async Task ClearDebugLog()
    {
        debugLog.Clear();
        AddDebugLog("INFO", "Debug log cleared by user");
        await Task.CompletedTask;
    }
    
    // Event handlers for the reusable debug panel component
    private async Task HandleClearDebugLog()
    {
        await ClearDebugLog();
    }
    
    private async Task HandleAddDebugLog(string message)
    {
        // This is called by the component when it adds its own log entries
        await InvokeAsync(StateHasChanged);
    }

    private async Task CopyDebugLogToClipboard()
    {
        try
        {
            var logText = string.Join("\n", debugLog.Select(entry => $"[{entry.Timestamp:HH:mm:ss}] {entry.Level}: {entry.Message}"));
            var fullLog = $"=== HOST CONTROL PANEL DEBUG LOG ===\nGenerated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}\nSession: {SessionId}\nConnection: {hubConnection?.ConnectionId}\n\n{logText}";
            
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", fullLog);
            AddDebugLog("SUCCESS", "‚úÖ Debug log copied to clipboard!");
        }
        catch (Exception ex)
        {
            AddDebugLog("ERROR", $"‚ùå Failed to copy log: {ex.Message}");
        }
    }

    private string GetLogEntryColor(string level)
    {
        return level.ToUpper() switch
        {
            "ERROR" => "#EF4444",
            "WARN" => "#F59E0B", 
            "SUCCESS" => "#10B981",
            "SIGNALR" => "#8B5CF6",
            "DATA" => "#06B6D4",
            _ => "#E5E7EB"
        };
    }

    /// <summary>
    /// Transforms the transcript HTML by removing delete buttons and adding SHARE buttons for each asset
    /// Share buttons are only injected when session status is "Active"
    /// </summary>
    private async Task<string> TransformTranscriptHtml(string originalHtml)
    {
        if (string.IsNullOrEmpty(originalHtml))
        {
            return originalHtml ?? string.Empty;
        }

        try
        {
            Logger.LogDebug("COPILOT-DEBUG: [HostControlPanel:TransformTranscriptHtml] Starting HTML transformation for SessionId {SessionId}, SessionStatus: {SessionStatus}", 
                SessionId, Model?.SessionStatus);
            
            // Remove buttons that have 'delete' in their id or class attributes
            var htmlWithoutDeletes = RemoveDeleteButtons(originalHtml);
            
            // Sanitize incoming HTML to remove dangerous elements/attributes before we touch it
            var sanitizedInput = SanitizeHtml(htmlWithoutDeletes);

            // Only inject share buttons if session is active; inject into sanitized HTML so our injection won't be stripped
            string finalHtml;
            if (Model?.SessionStatus == "Active")
            {
                Logger.LogDebug("COPILOT-DEBUG: [HostControlPanel:TransformTranscriptHtml] Session is Active - injecting share buttons for SessionId {SessionId}", SessionId);
                finalHtml = await InjectAssetShareButtonsFromDatabase(sanitizedInput);
            }
            else
            {
                Logger.LogDebug("COPILOT-DEBUG: [HostControlPanel:TransformTranscriptHtml] Session status '{SessionStatus}' - skipping share button injection for SessionId {SessionId}", 
                    Model?.SessionStatus, SessionId);
                finalHtml = sanitizedInput;
            }
            
            Logger.LogDebug("[DEBUG-WORKITEM:hostcanvas:TRANSFORM] Transformation completed. Original: {OriginalLength}, Final: {FinalLength}, ShareButtons: {ShareButtonsInjected}", 
                originalHtml.Length, finalHtml.Length, Model?.SessionStatus == "Active");

            // SAFETY: Validate HTML structure before returning
            try
            {
                // Log a sample of the transformed HTML for debugging
                var htmlSample = finalHtml.Length > 500 ? finalHtml.Substring(0, 500) + "..." : finalHtml;
                Logger.LogDebug("[DEBUG-WORKITEM:hostcanvas:TRANSFORM] HTML sample: {HtmlSample}", htmlSample);
                
                // Basic validation - check for unclosed tags that might cause issues
                if (finalHtml.Contains("<button") && !finalHtml.Contains("</button>"))
                {
                    Logger.LogError("[DEBUG-WORKITEM:hostcanvas:ERROR] Detected unclosed button tags in transformed HTML");
                }
                
                if (finalHtml.Contains("<div") && (finalHtml.Split("<div").Length - 1) != (finalHtml.Split("</div>").Length - 1))
                {
                    Logger.LogWarning("[DEBUG-WORKITEM:hostcanvas:WARNING] Potential unclosed div tags detected");
                }
            }
            catch (Exception validationEx)
            {
                Logger.LogError(validationEx, "[DEBUG-WORKITEM:hostcanvas:ERROR] HTML validation failed: {Error}", validationEx.Message);
            }

            // Avoid double-wrapping: if the transformed HTML already contains a top-level ks-transcript wrapper, return as-is
            var trimmed = finalHtml.TrimStart();
            if (trimmed.StartsWith("<div class=\"ks-transcript\"") || trimmed.StartsWith("<div class='ks-transcript'"))
            {
                return finalHtml;
            }

            // Wrap final HTML in a root scoping div so transcript CSS can be safely scoped
            var wrapped = $"<div class=\"ks-transcript\">{finalHtml}</div>";
            Logger.LogDebug("[DEBUG-WORKITEM:hostcanvas:TRANSFORM] Wrapped HTML length: {WrappedLength}", wrapped.Length);
            return wrapped;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "COPILOT-DEBUG: [HostControlPanel:TransformTranscriptHtml] Exception: {Message}", ex.Message);
            return originalHtml ?? string.Empty; // Return original HTML if transformation fails
        }
    }

    /// <summary>
    /// NEW SIMPLIFIED APPROACH: Inject share buttons using AssetLookup database table
    /// Replaces complex DetectAndTrackAssetsAsync + InjectAssetShareButtonsAsync approach
    /// </summary>
    private async Task<string> InjectAssetShareButtonsFromDatabase(string html)
    {
        try
        {
            Logger.LogInformation("SIMPLIFIED-ASSET-INJECTION: Loading asset definitions from database");
            
            // Load all active asset definitions from AssetLookup table
            var assetDefinitions = await SimplifiedCanvasDb.AssetLookup
                .Where(a => a.IsActive)
                .ToListAsync();
                
            Logger.LogInformation("SIMPLIFIED-ASSET-INJECTION: Found {Count} active asset definitions", assetDefinitions.Count);
            
            if (assetDefinitions.Count == 0)
            {
                Logger.LogWarning("SIMPLIFIED-ASSET-INJECTION: No active asset definitions found, skipping injection");
                return html;
            }

            var modifiedHtml = html;
            var totalMatches = 0;

            // Process each asset type from the database
            foreach (var assetDef in assetDefinitions)
            {
                if (string.IsNullOrEmpty(assetDef.CssSelector))
                {
                    Logger.LogDebug("SIMPLIFIED-ASSET-INJECTION: Skipping {AssetType} - no CSS selector defined", assetDef.AssetType);
                    continue;
                }

                // Convert CSS selector to regex pattern for matching
                var regexPattern = ConvertCssSelectorToRegex(assetDef.CssSelector);
                
                var matches = System.Text.RegularExpressions.Regex.Matches(modifiedHtml, regexPattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                
                if (matches.Count > 0)
                {
                    Logger.LogInformation("SIMPLIFIED-ASSET-INJECTION: Found {Count} instances of {AssetType}", matches.Count, assetDef.AssetType);
                    
                    // Inject share buttons for each match (in reverse order to preserve positions)
                    for (int i = matches.Count - 1; i >= 0; i--)
                    {
                        var match = matches[i];
                        var shareId = GenerateShareId();
                        var shareButton = CreateShareButtonHtml(assetDef.AssetType, assetDef.DisplayName ?? assetDef.AssetType, shareId, i + 1);
                        
                        // Insert share button before the matched element
                        modifiedHtml = modifiedHtml.Insert(match.Index, shareButton);
                        totalMatches++;
                    }
                }
                else
                {
                    Logger.LogDebug("SIMPLIFIED-ASSET-INJECTION: No matches found for {AssetType} with selector '{CssSelector}'", 
                        assetDef.AssetType, assetDef.CssSelector);
                }
            }
            
            Logger.LogInformation("SIMPLIFIED-ASSET-INJECTION: Successfully injected {TotalMatches} share buttons", totalMatches);
            return modifiedHtml;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SIMPLIFIED-ASSET-INJECTION: Failed to inject share buttons, returning original HTML");
            return html;
        }
    }

    /// <summary>
    /// Convert CSS selector to regex pattern for HTML matching
    /// </summary>
    private string ConvertCssSelectorToRegex(string cssSelector)
    {
        if (cssSelector.StartsWith("table[") && cssSelector.Contains("style="))
        {
            // Handle table[style="width: 100%;"] selector
            return @"<table[^>]*style=""[^""]*width:\s*100%[^""]*""[^>]*>";
        }
        else if (cssSelector.StartsWith("."))
        {
            // Handle class selectors like .ayah-card
            var className = cssSelector.Substring(1); // Remove the dot
            return $@"<[^>]*class=""[^""]*{System.Text.RegularExpressions.Regex.Escape(className)}[^""]*""[^>]*>";
        }
        else
        {
            // Default pattern - treat as element name
            return $@"<{System.Text.RegularExpressions.Regex.Escape(cssSelector)}[^>]*>";
        }
    }

    /// <summary>
    /// Create HTML for a share button (FIXED: Proper HTML encoding for Blazor MarkupString)
    /// </summary>
    private string CreateShareButtonHtml(string assetType, string displayName, string shareId, int instanceNumber)
    {
        // ISSUE FIX: HTML-encode all user-provided values to prevent parsing errors
        var encodedAssetType = System.Web.HttpUtility.HtmlEncode(assetType);
        var encodedDisplayName = System.Web.HttpUtility.HtmlEncode(displayName);
        var encodedShareId = System.Web.HttpUtility.HtmlEncode(shareId);
        
        return $@"<div class=""ks-share-wrapper"">" +
               $@"<button class=""ks-share-button"" data-share-button=""asset"" data-share-id=""{encodedShareId}"" data-asset-type=""{encodedAssetType}"" data-instance-number=""{instanceNumber}"" type=""button"">üì§ SHARE {encodedDisplayName.ToUpper()} #{instanceNumber}</button></div>";
    }

    /// <summary>
    /// Basic sanitization using AngleSharp: removes dangerous elements (script, style, iframe, object, embed)
    /// and strips event handler attributes (on*). Also nullifies javascript: URIs in href/src attributes.
    /// This is intentionally conservative: it keeps class/id/data-* attributes so scoped CSS and our
    /// data-driven share buttons continue to work while reducing XSS surface area.
    /// </summary>
    private string SanitizeHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return string.Empty;

        try
        {
            var parser = new HtmlParser();
            var document = parser.ParseDocument(html);

            // Remove hazardous elements entirely
            var removeSelectors = new[] { "script", "style", "iframe", "object", "embed", "link" };
            foreach (var sel in removeSelectors)
            {
                var nodes = document.QuerySelectorAll(sel).ToArray();
                foreach (var n in nodes) n.Remove();
            }

            // Sanitize attributes on all elements
            foreach (var element in document.All)
            {
                // Collect attributes to remove to avoid modifying collection during enumeration
                var toRemove = new List<string>();
                foreach (var attr in element.Attributes)
                {
                    var name = attr.Name ?? string.Empty;
                    // Remove event handlers (onclick, onerror, etc.)
                    if (name.StartsWith("on", StringComparison.OrdinalIgnoreCase))
                    {
                        toRemove.Add(name);
                        continue;
                    }

                    // Remove style attribute to avoid inline CSS attacks (we rely on classes instead)
                    if (string.Equals(name, "style", StringComparison.OrdinalIgnoreCase))
                    {
                        toRemove.Add(name);
                        continue;
                    }

                    // Ensure href/src do not use javascript: pseudo-protocol
                    if (string.Equals(name, "href", StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(name, "src", StringComparison.OrdinalIgnoreCase))
                    {
                        var val = attr.Value ?? string.Empty;
                        if (val.TrimStart().StartsWith("javascript:", StringComparison.OrdinalIgnoreCase))
                        {
                            toRemove.Add(name);
                        }
                    }
                }

                foreach (var a in toRemove) element.RemoveAttribute(a);
            }

            // Return sanitized inner HTML (preserve child nodes of body)
            var body = document.Body;
            if (body != null)
            {
                return string.Concat(body.ChildNodes.Select(n => n is IElement el ? el.OuterHtml : n.TextContent));
            }

            // Fallback to the document element's outer HTML
            return document.DocumentElement?.OuterHtml ?? string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "SanitizeHtml: failing open - returning original HTML as fallback");
            return html; // Fallback: return original if sanitizer fails (better than throwing)
        }
    }

    /// <summary>
    /// Generate a unique share ID for asset sharing
    /// </summary>
    private string GenerateShareId()
    {
        return Guid.NewGuid().ToString("N")[..8].ToUpper();
    }

    /// <summary>
    /// Removes any button elements that have 'delete' in their id or class attributes
    /// </summary>
    private string RemoveDeleteButtons(string html)
    {
        // Use regex to find and remove buttons with 'delete' in id or class
        var deleteButtonPattern = @"<button[^>]*(?:id[^=]*=[^""\s]*""[^""]*delete[^""]*""|class[^=]*=[^""\s]*""[^""]*delete[^""]*"")[^>]*>.*?</button>";
        return System.Text.RegularExpressions.Regex.Replace(html, deleteButtonPattern, "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
    }

    /// <summary>
    /// Adds data-asset-id attributes and SHARE buttons using SessionAssets lookup table
    /// NEW: Uses server-side asset catalog instead of client-side regex parsing
    /// </summary>
    private async Task<string> InjectIndividualShareButtonsAsync(string html)
    {
        try
        {
            Logger.LogInformation("ASSET-INJECTION-V2: Starting SessionAssets-based asset enhancement");
            Logger.LogInformation("ASSET-INJECTION-V2: Input HTML length: {Length}", html.Length);

            if (SessionId == null)
            {
                Logger.LogWarning("ASSET-INJECTION-V2: No SessionId available, skipping asset enhancement");
                return html;
            }

            // NEW: Load pre-detected assets from SessionAssets table
            var sessionAssets = await LoadSessionAssetsAsync(SessionId.Value);
            if (sessionAssets == null || sessionAssets.Count == 0)
            {
                Logger.LogInformation("ASSET-INJECTION-V2: No assets found in lookup table for session {SessionId}", SessionId);
                return html;
            }

            Logger.LogInformation("ASSET-INJECTION-V2: Loaded {Count} assets from lookup table for session {SessionId}",
                sessionAssets.Count, SessionId);

            // Phase 1: Inject data-asset-id attributes into asset containers
            var htmlWithAssetIds = InjectAssetIdentifiers(html, sessionAssets);

            // Phase 2: Add share buttons above identified containers  
            var htmlWithButtons = InjectShareButtons(htmlWithAssetIds, sessionAssets);

            Logger.LogInformation("ASSET-INJECTION-V2: Enhancement complete - HTML length: {Original} ‚Üí {Final}",
                html.Length, htmlWithButtons.Length);

            return htmlWithButtons;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ASSET-INJECTION-V2-ERROR: Failed to enhance assets, falling back to original HTML");
            return html; // Graceful degradation
        }
    }

    /// <summary>
    /// Load session assets from the SessionAssets API
    /// </summary>
    private async Task<List<SessionAssetDto>?> LoadSessionAssetsAsync(long sessionId)
    {
        try
        {
            using var httpClient = HttpClientFactory.CreateClient("default");
            var response = await httpClient.GetAsync($"/api/host/sessions/{sessionId}/assets");

            if (!response.IsSuccessStatusCode)
            {
                Logger.LogWarning("ASSET-INJECTION-V2: Failed to load assets from API, status: {StatusCode}", response.StatusCode);
                return new List<SessionAssetDto>();
            }

            var responseContent = await response.Content.ReadAsStringAsync();
            var assetsResponse = System.Text.Json.JsonSerializer.Deserialize<SessionAssetsResponse>(responseContent, new System.Text.Json.JsonSerializerOptions
            {
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
            });

            return assetsResponse?.Assets ?? new List<SessionAssetDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ASSET-INJECTION-V2: Exception loading assets from API");
            return new List<SessionAssetDto>();
        }
    }

    /// <summary>
    /// Inject data-asset-id attributes into asset containers for JavaScript targeting
    /// </summary>
    private string InjectAssetIdentifiers(string html, List<SessionAssetDto> assets)
    {
        try
        {
            Logger.LogInformation("ASSET-INJECTION-V2: Injecting data-asset-id attributes for {Count} assets", assets.Count);

            foreach (var asset in assets)
            {
                // Use the asset type patterns to find containers
                if (AssetTypePatterns.TryGetValue(asset.AssetType, out var pattern))
                {
                    var matches = System.Text.RegularExpressions.Regex.Matches(html, pattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase);

                    // For now, inject into the first match (can be enhanced later for more precise matching)
                    if (matches.Count > 0)
                    {
                        var match = matches[0];
                        var enhancedTag = InjectDataAssetId(match.Value, asset.AssetId);
                        html = html.Replace(match.Value, enhancedTag);

                        Logger.LogDebug("ASSET-INJECTION-V2: Injected data-asset-id='{AssetId}' for {AssetType}",
                            asset.AssetId, asset.AssetType);
                    }
                }
            }

            return html;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ASSET-INJECTION-V2: Failed to inject asset identifiers");
            return html;
        }
    }

    /// <summary>
    /// Inject SHARE buttons above containers with data-asset-id attributes
    /// </summary>
    private string InjectShareButtons(string html, List<SessionAssetDto> assets)
    {
        try
        {
            Logger.LogInformation("ASSET-INJECTION-V2: Injecting SHARE buttons for {Count} assets", assets.Count);

            // Process in reverse position order to maintain HTML positions during injection
            foreach (var asset in assets.OrderByDescending(a => a.Position ?? int.MaxValue))
            {
                var containerSelector = $"[data-asset-id='{asset.AssetId}']";
                var shareButton = GenerateShareButton(asset.AssetId, asset.AssetType);

                // Find container and inject button before it
                html = InjectButtonBeforeContainer(html, asset.AssetId, shareButton);

                Logger.LogDebug("ASSET-INJECTION-V2: Injected SHARE button for asset {AssetId} ({AssetType})",
                    asset.AssetId, asset.AssetType);
            }

            return html;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ASSET-INJECTION-V2: Failed to inject share buttons");
            return html;
        }
    }

    /// <summary>
    /// Inject data-asset-id attribute into an HTML opening tag
    /// </summary>
    private string InjectDataAssetId(string openingTag, long assetId)
    {
        var tagEndIndex = openingTag.IndexOf('>');
        if (tagEndIndex == -1) return openingTag;

        var attributeToInsert = $" data-asset-id=\"{assetId}\"";
        return openingTag.Insert(tagEndIndex, attributeToInsert);
    }

    /// <summary>
    /// Inject share button before a container with specified asset ID
    /// </summary>
    private string InjectButtonBeforeContainer(string html, long assetId, string shareButtonHtml)
    {
        try
        {
            var containerPattern = $@"<[^>]*data-asset-id=""{assetId}""[^>]*>";
            var match = System.Text.RegularExpressions.Regex.Match(html, containerPattern);

            if (match.Success)
            {
                html = html.Insert(match.Index, shareButtonHtml);
            }

            return html;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to inject button for asset {AssetId}", assetId);
            return html;
        }
    }

    /// <summary>
    /// Generate share button HTML for an asset (FIXED: Proper quote escaping for Blazor MarkupString)
    /// </summary>
    private string GenerateShareButton(long assetId, string assetType)
    {
        // ISSUE FIX: Use HTML-encoded quotes and avoid complex inline event handlers that cause parsing errors
        var escapedAssetType = System.Web.HttpUtility.HtmlEncode(assetType);
        
        return $@"<button data-share-button=""asset"" data-asset-id=""{assetId}"" data-asset-type=""{escapedAssetType}"" class=""ks-share-btn"" type=""button"">SHARE</button>";
    }

    // REMOVED: DetectAndTrackAssetsAsync - replaced by simplified database-driven approach

    // REMOVED: InjectAssetShareButtonsAsync - replaced by simplified database-driven approach

    // REMOVED: InjectShareButtonForAsset - replaced by simplified database-driven approach

    // REMOVED: DetectedAsset class - no longer needed with simplified database-driven approach

    // REMOVED: SaveAssetsToDatabase - no longer needed with simplified database-driven approach

    /// <summary>
    /// Asset type patterns for detection (moved from inline to reusable)
    /// </summary>
    private static readonly Dictionary<string, string> AssetTypePatterns = new()
    {
        { "etymology-derivative-card", @"<div[^>]*class=""[^""]*etymology-derivative-card[^""]*""[^>]*>" },
        { "ahadees-container", @"<div[^>]*class=""[^""]*(?:inserted-hadees|ks-ahadees-container|ahadees-content)[^""]*""[^>]*>" },
        { "ayah-card", @"<div[^>]*class=""[^""]*ayah-card[^""]*""[^>]*>" },
        { "image-asset", @"<img[^>]*(?:src=""[^""]*""[^>]*|[^>]*)" },
        { "table-asset", @"<table[^>]*class=""[^""]*(?:islamic-table|content-table|comparison-table)[^""]*""[^>]*>" }
    };

    // Legacy method - keep for fallback
    private string InjectIndividualShareButtons(string html)
    {
        // Call async version and wait
        return InjectIndividualShareButtonsAsync(html).GetAwaiter().GetResult();
    }

    // DTO classes for API responses
    public class SessionAssetDto
    {
        public long AssetId { get; set; }
        public string AssetType { get; set; } = string.Empty;
        public string AssetSelector { get; set; } = string.Empty;
        public int? Position { get; set; }
        public bool IsShared { get; set; }
        public DateTime? SharedAt { get; set; }
    }

    public class SessionAssetsResponse
    {
        public long SessionId { get; set; }
        public int TotalAssets { get; set; }
        public int SharedAssets { get; set; }
        public Dictionary<string, int> AssetsByType { get; set; } = new();
        public List<SessionAssetDto> Assets { get; set; } = new();
        public string? RequestId { get; set; }
    }

    @* [DEBUG-WORKITEM:hostcanvas:continue] Transcript cache removed - using SafeHtmlRenderingService instead ;CLEANUP_OK *@

    @* [DEBUG-WORKITEM:hostcanvas:continue] Obsolete transcript rendering methods removed - using SafeHtmlRenderingService instead ;CLEANUP_OK *@



    private void RenderLargeContentSummary(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, string html)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "style", "background:#E0F2FE;border:1px solid #0284C7;border-radius:0.5rem;padding:1.5rem;");
        
        builder.OpenElement(2, "h4");
        builder.AddAttribute(3, "style", "color:#0284C7;margin:0 0 1rem 0;display:flex;align-items:center;gap:0.5rem;");
        builder.OpenElement(4, "i");
        builder.AddAttribute(5, "class", "fa-solid fa-file-text");
        builder.CloseElement();
        builder.AddContent(6, "Large Transcript Content");
        builder.CloseElement();
        
        builder.OpenElement(7, "p");
        builder.AddContent(8, $"This transcript contains {html.Length:N0} characters of content.");
        builder.CloseElement();
        
        builder.OpenElement(9, "p");
        builder.AddContent(10, "To prevent browser performance issues, the full content is not displayed. Use the debug tools below to inspect specific sections if needed.");
        builder.CloseElement();
        
        // Show a safe preview of the first 1000 characters
        var safePreview = html.Substring(0, Math.Min(1000, html.Length));
        var textContent = System.Text.RegularExpressions.Regex.Replace(safePreview, "<[^>]*>", " ");
        textContent = System.Text.RegularExpressions.Regex.Replace(textContent, @"\s+", " ").Trim();
        
        builder.OpenElement(11, "details");
        builder.OpenElement(12, "summary");
        builder.AddAttribute(13, "style", "cursor:pointer;color:#0284C7;font-weight:600;");
        builder.AddContent(14, "Show preview (text only)");
        builder.CloseElement();
        builder.OpenElement(15, "pre");
        builder.AddAttribute(16, "style", "background:#F8FAFC;padding:1rem;border-radius:0.25rem;margin-top:0.5rem;white-space:pre-wrap;font-size:0.875rem;");
        builder.AddContent(17, textContent.Substring(0, Math.Min(500, textContent.Length)) + "...");
        builder.CloseElement();
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private void RenderWithSafeFallback(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, string html)
    {
        try
        {
            // Attempt to clean and render the HTML
            var cleanedHtml = CleanHtmlForSafeRendering(html);
            builder.AddMarkupContent(0, cleanedHtml);
            
            Logger.LogInformation("[DEBUG-WORKITEM:signalcomm:continue] Successfully rendered large content ({Length} chars)", html.Length);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "[DEBUG-WORKITEM:signalcomm:continue] Safe rendering failed, using text fallback");
            RenderAsPlainText(builder, html);
        }
    }

    private void RenderSanitizedContent(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, string html)
    {
        var sanitizedHtml = SanitizeHtmlForRendering(html);
        builder.AddMarkupContent(0, sanitizedHtml);
        Logger.LogInformation("[DEBUG-WORKITEM:signalcomm:continue] Rendered sanitized content");
    }

    @* [DEBUG-WORKITEM:hostcanvas:continue] Enhanced Processor methods removed - using SafeHtmlRenderingService instead ;CLEANUP_OK *@

    private void RenderErrorFallback(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, Exception ex, int contentLength)
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "style", "background:#FEF2F2;border:1px solid #EF4444;border-radius:0.5rem;padding:1.5rem;");
        
        builder.OpenElement(2, "h4");
        builder.AddAttribute(3, "style", "color:#EF4444;margin:0 0 1rem 0;display:flex;align-items:center;gap:0.5rem;");
        builder.OpenElement(4, "i");
        builder.AddAttribute(5, "class", "fa-solid fa-exclamation-triangle");
        builder.CloseElement();
        builder.AddContent(6, "Transcript Rendering Error");
        builder.CloseElement();
        
        builder.OpenElement(7, "p");
        builder.AddContent(8, $"Unable to display transcript content ({contentLength:N0} characters).");
        builder.CloseElement();
        
        builder.OpenElement(9, "p");
        builder.AddAttribute(10, "style", "font-family:monospace;font-size:0.875rem;color:#DC2626;");
        builder.AddContent(11, $"Error: {ex.Message}");
        builder.CloseElement();
        
        builder.OpenElement(12, "p");
        builder.AddAttribute(13, "style", "font-size:0.875rem;color:#6B7280;");
        builder.AddContent(14, "This prevents the appendChild JavaScript error while maintaining functionality. The content is still available through the API endpoints.");
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private void RenderAsPlainText(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, string html)
    {
        // Extract text content only, removing all HTML tags
        var textContent = System.Text.RegularExpressions.Regex.Replace(html, "<[^>]*>", "\n");
        textContent = System.Text.RegularExpressions.Regex.Replace(textContent, @"\n\s*\n", "\n\n");
        textContent = System.Web.HttpUtility.HtmlDecode(textContent).Trim();
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "style", "background:#F9FAFB;border:1px solid #D1D5DB;border-radius:0.5rem;padding:1.5rem;");
        
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "style", "display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;color:#6B7280;");
        builder.OpenElement(4, "i");
        builder.AddAttribute(5, "class", "fa-solid fa-file-text");
        builder.CloseElement();
        builder.AddContent(6, "Transcript (Text Only)");
        builder.CloseElement();
        
        builder.OpenElement(7, "pre");
        builder.AddAttribute(8, "style", "white-space:pre-wrap;font-family:system-ui;line-height:1.6;margin:0;");
        builder.AddContent(9, textContent);
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private bool ContainsPotentiallyProblematicContent(string html)
    {
        if (string.IsNullOrEmpty(html)) return false;
        
        // Check for patterns that commonly cause appendChild errors
        var problematicPatterns = new[]
        {
            @"<[^>]*[""'][^""']*[\u0000-\u001F]", // Control characters in attributes
            @"<script[^>]*>.*?</script>", // Script tags
            @"javascript:", // JavaScript URLs
            @"on\w+\s*=", // Event handlers
            @"<iframe", // Iframes
            @"<object", // Object elements
            @"<embed", // Embed elements
            @"<form", // Forms (can cause issues)
            @"<%.*?%>", // ASP/JSP tags
            @"<\?.*?\?>", // PHP tags
        };
        
        foreach (var pattern in problematicPatterns)
        {
            if (System.Text.RegularExpressions.Regex.IsMatch(html, pattern, System.Text.RegularExpressions.RegexOptions.IgnoreCase))
            {
                return true;
            }
        }
        
        return false;
    }

    private string CleanHtmlForSafeRendering(string html)
    {
        if (string.IsNullOrEmpty(html)) return string.Empty;
        
        // Remove potentially problematic elements and attributes
        var cleaned = html;
        
        // Remove script tags completely
        cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, @"<script[^>]*>.*?</script>", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase | System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // Remove event handlers
        cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, @"\s+on\w+\s*=\s*[""'][^""']*[""']", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove javascript: URLs
        cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, @"javascript:[^""'\s>]*", "", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        
        // Remove any control characters that might cause parsing issues
        cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, @"[\u0000-\u001F\u007F-\u009F]", "");
        
        return cleaned;
    }

    private string SanitizeHtmlForRendering(string html)
    {
        // More aggressive sanitization for problematic content
        var sanitized = CleanHtmlForSafeRendering(html);
        
        // Ensure all tags are properly closed
        sanitized = EnsureTagsClosed(sanitized);
        
        return sanitized;
    }

    private string EnsureTagsClosed(string html)
    {
        // Simple approach: wrap in a container div to ensure valid structure
        if (!html.Trim().StartsWith("<div") || !html.Trim().EndsWith("</div>"))
        {
            return $"<div class=\"transcript-content\">{html}</div>";
        }
        return html;
    }
}

<script>


    // Individual Asset Sharing Function (called by auto-injected SHARE buttons)
    window.shareIndividualAsset = async function(assetId, assetType) {
        console.log('NOOR-ASSET-SHARE: Sharing individual asset:', assetId, 'Type:', assetType);
        
        try {
            // Get session details
            const sessionId = '@(SessionId ?? 0)';
            const hostToken = '@(HostToken ?? "")';
            
            if (!sessionId || !hostToken) {
                console.error('NOOR-ASSET-SHARE: Missing session ID or host token');
                alert('Session information not available. Please refresh the page.');
                return;
            }

            // Find the asset element
            const assetElement = document.querySelector(`[data-asset-id="${assetId}"]`);
            if (!assetElement) {
                console.error('NOOR-ASSET-SHARE: Asset element not found:', assetId);
                return;
            }

            // Find the SHARE button
            const shareButton = document.querySelector(`button[data-asset-id="${assetId}"]`);
            if (!shareButton) {
                console.error('NOOR-ASSET-SHARE: Share button not found for asset:', assetId);
                return;
            }

            // Visual feedback - button state
            const originalText = shareButton.textContent;
            const originalBg = shareButton.style.backgroundColor;
            shareButton.textContent = 'SHARING...';
            shareButton.style.backgroundColor = '#f59e0b';
            shareButton.disabled = true;

            // Call share API
            const shareResponse = await fetch('/api/host/share-asset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: parseInt(sessionId),
                    content: assetElement.outerHTML,
                    assetType: assetType,
                    assetId: assetId,
                    metadata: {
                        textContent: assetElement.textContent?.substring(0, 100) || '',
                        className: assetElement.className || '',
                        sharedAt: new Date().toISOString()
                    }
                })
            });

            if (shareResponse.ok) {
                const result = await shareResponse.json();
                console.log('NOOR-ASSET-SHARE: Asset shared successfully:', result);
                
                // Success feedback
                shareButton.textContent = '‚úì SHARED';
                shareButton.style.backgroundColor = '#059669';
                
                setTimeout(() => {
                    shareButton.textContent = originalText;
                    shareButton.style.backgroundColor = originalBg;
                    shareButton.disabled = false;
                }, 3000);
                
            } else {
                throw new Error(`Share API returned ${shareResponse.status}`);
            }

        } catch (error) {
            console.error('NOOR-ASSET-SHARE: Error sharing asset:', assetId, error);
            
            // Show detailed error message to user
            let errorMessage = 'Unknown error occurred';
            if (error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            
            // Show toast notification with error details
            showErrorToast(`Failed to share asset: ${errorMessage}`);
            
            // Find button and show error feedback
            const shareButton = document.querySelector(`button[data-asset-id="${assetId}"]`);
            if (shareButton) {
                shareButton.textContent = '‚úó ERROR';
                shareButton.style.backgroundColor = '#dc2626';
                shareButton.title = `Error: ${errorMessage}`;
                
                setTimeout(() => {
                    shareButton.textContent = 'SHARE';
                    shareButton.style.backgroundColor = '#dc2626';
                    shareButton.disabled = false;
                    shareButton.title = 'Share this asset';
                }, 3000);
            }
        }
    };

    // SignalR Asset Sharing Function (called by injected share buttons) - updated for individual assets
    window.shareAssetViaSignalR = async function(shareId, assetType, instanceCount, uniqueAssetId) {
        try {
            console.log('NOOR-ASSET-SIGNALR: Sharing individual asset via SignalR', { 
                shareId, assetType, instanceCount, uniqueAssetId 
            });
            
            if (window.signalRConnection && window.signalRConnection.state === 'Connected') {
                // Send individual asset share via SignalR hub with unique identifier
                const assetData = {
                    shareId: shareId,
                    assetType: assetType,
                    uniqueAssetId: uniqueAssetId,
                    instanceCount: 1 // Always 1 for individual assets
                };
                
                await window.signalRConnection.invoke('ShareAsset', window.currentSessionId, assetData);
                console.log('NOOR-ASSET-SIGNALR: Individual asset shared successfully via SignalR hub');
                
                // Show success feedback
                const button = document.querySelector(`[data-share-id="${shareId}"]`);
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ SHARED VIA SIGNALR!';
                    button.style.backgroundColor = '#16a34a';
                    button.disabled = true;
                    
                    // Restore button after 3 seconds
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.backgroundColor = '#dc2626';
                        button.disabled = false;
                    }, 3000);
                }
            } else {
                console.error('NOOR-ASSET-SIGNALR: SignalR connection not available or not connected');
                alert('SignalR connection is not available. Please refresh the page and try again.');
            }
        } catch (error) {
            console.error('NOOR-ASSET-SIGNALR: Error sharing individual asset via SignalR:', error);
            alert('Failed to share individual asset via SignalR: ' + error.message);
        }
    };

    console.log('NOOR-ASSET-SHARE: Individual asset sharing system ready with SignalR support');

    // Toast Notification Functions for Q&A Alerts
    window.showQuestionToast = function(questionText) {
        // Create toast element
        const toast = document.createElement('div');
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fa-solid fa-question-circle" style="color: #3B82F6; font-size: 1.2rem;"></i>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">New Question Received!</div>
                    <div style="font-size: 0.875rem; opacity: 0.9; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${questionText}
                    </div>
                </div>
            </div>
        `;
        toast.style.cssText = `
            position: fixed; 
            top: 1rem; 
            right: 1rem; 
            background-color: #3B82F6; 
            color: white; 
            padding: 1rem 1.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4); 
            z-index: 9999; 
            opacity: 0; 
            transform: translateX(100%); 
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            max-width: 400px;
        `;
        
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Hide toast after 4 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 4000);
    };

    window.showVoteUpdateToast = function(questionText, voteCount) {
        // Create toast element
        const toast = document.createElement('div');
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fa-solid fa-thumbs-up" style="color: #10B981; font-size: 1.2rem;"></i>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Question Voted! (${voteCount} votes)</div>
                    <div style="font-size: 0.875rem; opacity: 0.9; max-width: 280px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${questionText}
                    </div>
                </div>
            </div>
        `;
        toast.style.cssText = `
            position: fixed; 
            top: 1rem; 
            right: 1rem; 
            background-color: #10B981; 
            color: white; 
            padding: 1rem 1.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4); 
            z-index: 9999; 
            opacity: 0; 
            transform: translateX(100%); 
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            max-width: 400px;
        `;
        
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    };

    window.showErrorToast = function(errorMessage) {
        // Create error toast element
        const toast = document.createElement('div');
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Asset Sharing Error</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">
                        ${errorMessage}
                    </div>
                </div>
            </div>
        `;
        toast.style.cssText = `
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 10000;
            font-family: 'Inter', sans-serif;
            min-width: 350px;
            max-width: 500px;
        `;
        
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Hide toast after 5 seconds (longer for errors)
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 5000);
    };

    // Copy User Landing Link Function
    window.copyUserLink = function() {
        const input = document.getElementById('userLinkInput');
        if (input) {
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices

            // Try using modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(input.value).then(() => {
                    console.log('NOOR-HOST-PANEL: User link copied to clipboard');
                    showCopyFeedback();
                }).catch(err => {
                    console.error('NOOR-HOST-PANEL: Failed to copy with clipboard API:', err);
                    // Fallback to execCommand
                    document.execCommand('copy');
                    showCopyFeedback();
                });
            } else {
                // Fallback for older browsers
                document.execCommand('copy');
                showCopyFeedback();
            }
        }
    };

    function showCopyFeedback() {
        // Get the copy button by finding it in the DOM
        const copyButton = document.querySelector('button[onclick="copyUserLink()"]');
        if (copyButton) {
            const originalText = copyButton.innerHTML;
            const originalBgColor = copyButton.style.backgroundColor;
            
            copyButton.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            copyButton.style.backgroundColor = '#059669';
            
            setTimeout(() => {
                copyButton.innerHTML = originalText;
                copyButton.style.backgroundColor = originalBgColor;
            }, 2000);
        }
    }

    // Error Display Panel Functions
    let currentError = null;

    function showErrorPanel(error, details = null) {
        console.log('[DEBUG-WORKITEM:hostcanvas:ui] Showing error panel:', error);
        
        currentError = {
            message: error.toString(),
            details: details || error.stack || 'No additional details available',
            timestamp: new Date().toISOString()
        };

        const panel = document.getElementById('noor-error-panel');
        const messageEl = document.getElementById('error-message');
        const timestampEl = document.getElementById('error-timestamp');
        const stackEl = document.getElementById('error-stack');

        if (panel && messageEl && timestampEl && stackEl) {
            messageEl.textContent = currentError.message;
            timestampEl.textContent = new Date(currentError.timestamp).toLocaleString();
            stackEl.textContent = currentError.details;
            panel.style.display = 'block';
            
            // Scroll to top to make error visible
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function dismissError() {
        const panel = document.getElementById('noor-error-panel');
        if (panel) {
            panel.style.display = 'none';
        }
        currentError = null;
    }

    function toggleErrorDetails() {
        const details = document.getElementById('error-details');
        if (details) {
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
    }

    async function copyErrorToClipboard() {
        if (!currentError) return;
        
        const errorReport = `NOOR Canvas Error Report
Generated: ${currentError.timestamp}
Host Control Panel - Asset Sharing Error

Error Message:
${currentError.message}

Technical Details:
${currentError.details}

Page URL: ${window.location.href}
User Agent: ${navigator.userAgent}
Timestamp: ${new Date().toISOString()}

Please share this report with the development team for debugging.`;

        try {
            await navigator.clipboard.writeText(errorReport);
            
            const button = document.getElementById('copy-error-btn');
            if (button) {
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-check"></i> <span>Copied!</span>';
                button.style.backgroundColor = '#059669';
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.backgroundColor = '#DC2626';
                }, 2000);
            }
        } catch (err) {
            console.error('Failed to copy error report:', err);
            // Fallback: show in a modal/alert
            alert('Copy failed. Please manually copy:\n\n' + errorReport);
        }
    }

    // Global error handler to catch unhandled errors
    window.addEventListener('error', function(event) {
        console.error('[DEBUG-WORKITEM:hostcanvas:error] Global error caught:', event.error);
        showErrorPanel(event.error || event.message, event.error?.stack);
    });

    // Promise rejection handler
    window.addEventListener('unhandledrejection', function(event) {
        console.error('[DEBUG-WORKITEM:hostcanvas:error] Unhandled promise rejection:', event.reason);
        showErrorPanel(event.reason, event.reason?.stack);
    });

    // Override console.error to capture application errors
    const originalConsoleError = console.error;
    console.error = function(...args) {
        originalConsoleError.apply(console, args);
        
        // Show error panel for specific error patterns
        const errorMessage = args.join(' ');
        if (errorMessage.includes('NOOR-') || errorMessage.includes('ShareAsset') || errorMessage.includes('SignalR')) {
            showErrorPanel(errorMessage, 'Console error captured by error display system');
        }
    };

    console.log('[DEBUG-WORKITEM:hostcanvas:ui] Error display system initialized');
</script>

