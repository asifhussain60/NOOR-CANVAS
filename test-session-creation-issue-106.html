<!DOCTYPE html>
<html>
<head>
    <title>Issue-106 Debug: Test Session Creation API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
    </style>
</head>
<body>
    <h1>Issue-106 Debug Test: Session Creation API</h1>
    <p><strong>Host Token:</strong> JHINFLXN</p>
    <p><strong>Purpose:</strong> Reproduce Issue-106 by testing the session creation API directly</p>
    
    <h2>Step 1: Get Albums (Verify Host Token)</h2>
    <button onclick="testGetAlbums()">Test Get Albums API</button>
    <div id="albums-result" class="result"></div>
    
    <h2>Step 2: Get Categories (Select Album)</h2>
    <button onclick="testGetCategories()">Test Get Categories API</button>
    <div id="categories-result" class="result"></div>
    
    <h2>Step 3: Get Sessions (Select Category)</h2>
    <button onclick="testGetSessions()">Test Get Sessions API</button>
    <div id="sessions-result" class="result"></div>
    
    <h2>Step 4: Create Session (The Issue-106 Problem)</h2>
    <button onclick="testCreateSession()">Test Create Session API - Issue-106 Trigger</button>
    <div id="create-session-result" class="result"></div>
    
    <div id="debug-log" style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
        <h3>Debug Log</h3>
        <div id="log-content"></div>
    </div>

    <script>
        const API_BASE = 'https://localhost:9091';
        const HOST_TOKEN = 'JHINFLXN';
        
        let selectedAlbum = null;
        let selectedCategory = null;
        let selectedSession = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            logContent.innerHTML += `[${timestamp}] ${message}<br>`;
        }
        
        async function testGetAlbums() {
            try {
                log('Testing Get Albums API...');
                const response = await fetch(`${API_BASE}/api/host/albums?guid=${HOST_TOKEN}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const result = document.getElementById('albums-result');
                
                if (response.ok) {
                    const albums = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `<strong>SUCCESS:</strong> Found ${albums.length} albums<br>`;
                    if (albums.length > 0) {
                        selectedAlbum = albums[0].Id;
                        result.innerHTML += `Selected Album: ${albums[0].Name} (ID: ${selectedAlbum})`;
                        log(`Albums loaded successfully: ${albums.length} albums found`);
                        log(`Auto-selected album: ${albums[0].Name} (ID: ${selectedAlbum})`);
                    }
                } else {
                    result.className = 'result error';
                    result.innerHTML = `<strong>ERROR:</strong> HTTP ${response.status} - ${await response.text()}`;
                    log(`Albums API failed: HTTP ${response.status}`);
                }
            } catch (error) {
                log(`Albums API error: ${error.message}`);
                document.getElementById('albums-result').className = 'result error';
                document.getElementById('albums-result').innerHTML = `<strong>ERROR:</strong> ${error.message}`;
            }
        }
        
        async function testGetCategories() {
            if (!selectedAlbum) {
                alert('Please test Get Albums first to select an album');
                return;
            }
            
            try {
                log(`Testing Get Categories API for album ${selectedAlbum}...`);
                const response = await fetch(`${API_BASE}/api/host/categories/${selectedAlbum}?guid=${HOST_TOKEN}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const result = document.getElementById('categories-result');
                
                if (response.ok) {
                    const categories = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `<strong>SUCCESS:</strong> Found ${categories.length} categories<br>`;
                    if (categories.length > 0) {
                        selectedCategory = categories[0].CategoryID;
                        result.innerHTML += `Selected Category: ${categories[0].CategoryName} (ID: ${selectedCategory})`;
                        log(`Categories loaded successfully: ${categories.length} categories found`);
                        log(`Auto-selected category: ${categories[0].CategoryName} (ID: ${selectedCategory})`);
                    }
                } else {
                    result.className = 'result error';
                    result.innerHTML = `<strong>ERROR:</strong> HTTP ${response.status} - ${await response.text()}`;
                    log(`Categories API failed: HTTP ${response.status}`);
                }
            } catch (error) {
                log(`Categories API error: ${error.message}`);
                document.getElementById('categories-result').className = 'result error';
                document.getElementById('categories-result').innerHTML = `<strong>ERROR:</strong> ${error.message}`;
            }
        }
        
        async function testGetSessions() {
            if (!selectedCategory) {
                alert('Please test Get Categories first to select a category');
                return;
            }
            
            try {
                log(`Testing Get Sessions API for category ${selectedCategory}...`);
                const response = await fetch(`${API_BASE}/api/host/sessions/${selectedCategory}?guid=${HOST_TOKEN}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const result = document.getElementById('sessions-result');
                
                if (response.ok) {
                    const sessions = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `<strong>SUCCESS:</strong> Found ${sessions.length} sessions<br>`;
                    if (sessions.length > 0) {
                        selectedSession = sessions[0].SessionID;
                        result.innerHTML += `Selected Session: ${sessions[0].SessionName} (ID: ${selectedSession})`;
                        log(`Sessions loaded successfully: ${sessions.length} sessions found`);
                        log(`Auto-selected session: ${sessions[0].SessionName} (ID: ${selectedSession})`);
                    }
                } else {
                    result.className = 'result error';
                    result.innerHTML = `<strong>ERROR:</strong> HTTP ${response.status} - ${await response.text()}`;
                    log(`Sessions API failed: HTTP ${response.status}`);
                }
            } catch (error) {
                log(`Sessions API error: ${error.message}`);
                document.getElementById('sessions-result').className = 'result error';
                document.getElementById('sessions-result').innerHTML = `<strong>ERROR:</strong> ${error.message}`;
            }
        }
        
        async function testCreateSession() {
            if (!selectedAlbum || !selectedCategory || !selectedSession) {
                alert('Please complete steps 1-3 first to select album, category, and session');
                return;
            }
            
            try {
                log('*** TESTING CREATE SESSION API - THIS SHOULD TRIGGER ISSUE-106 ***');
                
                const sessionData = {
                    sessionName: `Issue-106 Test Session`,
                    album: selectedAlbum.toString(),
                    category: selectedCategory.toString(), 
                    sessionDescription: "Testing Issue-106 reproduction via API call"
                };
                
                const payload = {
                    hostGuid: HOST_TOKEN,
                    sessionData: sessionData
                };
                
                log(`Payload: ${JSON.stringify(payload, null, 2)}`);
                
                const response = await fetch(`${API_BASE}/api/host/create-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = document.getElementById('create-session-result');
                
                if (response.ok) {
                    const sessionResult = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `<strong>SUCCESS:</strong> Session created!<br>Session URL: ${sessionResult.sessionUrl}<br>User Token: ${sessionResult.userToken}`;
                    log('*** SESSION CREATION SUCCESSFUL - Issue-106 NOT REPRODUCED ***');
                    log(`Session URL: ${sessionResult.sessionUrl}`);
                    log(`User Token: ${sessionResult.userToken}`);
                } else {
                    const errorText = await response.text();
                    result.className = 'result error';
                    result.innerHTML = `<strong>ERROR:</strong> HTTP ${response.status}<br>${errorText}`;
                    log('*** SESSION CREATION FAILED - ISSUE-106 REPRODUCED ***');
                    log(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                log('*** SESSION CREATION EXCEPTION - ISSUE-106 REPRODUCED ***');
                log(`Exception: ${error.message}`);
                document.getElementById('create-session-result').className = 'result error';
                document.getElementById('create-session-result').innerHTML = `<strong>EXCEPTION:</strong> ${error.message}`;
            }
        }
        
        // Auto-start the test sequence
        window.onload = function() {
            log('Issue-106 Debug Test Page Loaded');
            log('Use buttons above to step through the API calls that lead to Issue-106');
            log('Watch the server terminal for ISSUE-106-DEBUG logs when you click "Test Create Session API"');
        };
    </script>
</body>
</html>