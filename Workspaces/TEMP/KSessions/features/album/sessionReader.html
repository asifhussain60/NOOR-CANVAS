<!-- Beautiful Islam Reader - Mobile-First Interface -->
<!-- Phase 1: Mobile-First Reader Layout -->
<div class="modern-reader-container" data-ng-controller="sessionReaderCtrl">
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" data-ng-if="vm.isLoading">
        <div class="loading-content">
            <i class="fa fa-spinner fa-spin fa-3x"></i>
            <p>Loading Beautiful Islam Reader...</p>
        </div>
    </div>

    <!-- Breadcrumb Navigation (Session Style) - Full Width -->
    <div data-ng-if="!vm.isLoading">
        <div data-zu-blank-row data-repeat="1"></div>
        <div data-zu-breadcrumb-bar="" 
             data-ng-click="vm.navigateToAlbumList()"
             data-label="Return To Albums"
             data-border-position="top">
        </div>
    </div>

    <div class="container-fluid">
        <div class="beautiful-reader-container reader-theme-light">

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" 
         data-ng-class="{'overlay-active': vm.sidebarOpen}" 
         data-ng-click="vm.closeSidebar()">
    </div>

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" 
            data-ng-click="vm.toggleSidebar()" 
            data-ng-if="vm.isMobile"
            title="Toggle Menu">
        <i class="fa fa-bars"></i>
    </button>

    <!-- Main Content Area -->
    
    <!-- Table of Contents Sidebar -->
    <div class="reader-sidebar" 
         data-ng-class="{'sidebar-open': vm.sidebarOpen, 'sidebar-collapsed': vm.sidebarCollapsed}"
         data-ng-if="!vm.isLoading">

        <!-- Phase 2: Search Enhancement -->
        <div class="sidebar-header">
            <div class="search-container">
                <div class="search-input-group">
                    <i class="fa fa-search search-icon"></i>
                    <input type="text" 
                           class="search-input" 
                           placeholder="Search sessions..." 
                           data-ng-model="vm.searchText"
                           data-ng-keyup="vm.onSearchKeyup()"
                           data-ng-change="vm.onSearchKeyup()"
                           autocomplete="off"
                           maxlength="100">
                    <button class="search-clear-btn" 
                            data-ng-if="vm.searchText" 
                            data-ng-click="vm.clearSearch()"
                            title="Clear search">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Phase 2: Reading Progress Summary -->
            <div class="progress-summary" data-ng-if="vm.totalSessions > 0">
                <div class="progress-title">Reading Progress</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: {{vm.getOverallProgress().percentage}}%"></div>
                </div>
                <div class="progress-text">
                    {{vm.getCompletedSessionsCount()}} of {{vm.totalSessions}} sessions completed
                </div>
            </div>
            
            <!-- Phase 3: Enhanced Category Controls -->
            <div class="sidebar-controls" data-ng-if="vm.hasCategories()">
                <div class="controls-header">
                    <span class="controls-title">{{vm.showBookmarksView ? 'Bookmarks' : 'Categories'}}</span>
                    <div class="control-buttons">
                        <!-- Phase 4: Bookmark View Toggle Button -->
                        <button class="control-btn bookmark-btn icon-only" 
                                data-ng-click="vm.toggleBookmarksView()" 
                                title="{{vm.showBookmarksView ? 'Show Categories' : 'Show Bookmarks'}}"
                                aria-label="{{vm.showBookmarksView ? 'Show Categories' : 'Show Bookmarks'}}">
                            <i class="fa" data-ng-class="vm.showBookmarksView ? 'fa-list' : 'fa-bookmark'"></i>
                        </button>
                        
                        <!-- Expand/Collapse buttons (hidden in bookmark view) -->
                        <button class="control-btn expand-btn icon-only" 
                                data-ng-click="vm.expandAll()" 
                                data-ng-disabled="vm.categoryControls.allExpanded"
                                data-ng-if="!vm.showBookmarksView"
                                title="Expand All Categories"
                                aria-label="Expand All Categories">
                            <i class="fa fa-plus-square-o"></i>
                        </button>
                        <button class="control-btn collapse-btn icon-only" 
                                data-ng-click="vm.collapseAll()" 
                                data-ng-disabled="!vm.categoryControls.allExpanded && vm.categoryControls.expandedCount === 0"
                                data-ng-if="!vm.showBookmarksView"
                                title="Collapse All Categories"
                                aria-label="Collapse All Categories">
                            <i class="fa fa-minus-square-o"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Phase 4: Clear All Bookmarks Button (shown only in bookmark view) -->
                <div class="bookmark-actions" data-ng-if="vm.showBookmarksView && vm.getBookmarkedSessions().length > 0">
                    <button class="btn btn-sm btn-warning" 
                            data-ng-click="vm.unbookmarkAllSessions()"
                            title="Remove all bookmarks">
                        <i class="fa fa-trash"></i> Clear All Bookmarks
                    </button>
                </div>
            </div>
        </div>

        <!-- Chapters List -->
            <div class="chapters-list">
                
                <!-- Bookmarked Sessions (shown only in bookmark view) -->
                <div class="chapter-group" data-ng-if="vm.showBookmarksView && vm.getBookmarkedSessions().length > 0">
                    <div class="chapter-header enhanced-header" 
                         data-ng-click="vm.toggleChapter('bookmarks')"
                         data-ng-class="{'expanded': vm.expandedChapters['bookmarks']}">
                        <div class="header-icon">
                            <i class="fa" data-ng-class="vm.expandedChapters['bookmarks'] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                        </div>
                        <div class="chapter-info">
                            <div class="chapter-title">
                                Your Bookmarked Sessions
                                <span class="session-count">({{vm.getBookmarkedSessions().length}} sessions)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sessions-list" 
                         data-ng-if="vm.expandedChapters['bookmarks']"
                         data-ng-animate="'slide'">
                        <div class="session-item" 
                             data-ng-repeat="session in vm.getBookmarkedSessions()" 
                             data-ng-click="vm.selectSession(session)"
                             data-ng-class="{'session-active': vm.selectedSessionId === session.id, 'session-completed': session.isCompleted}">
                            <i class="fa fa-file-text"></i>
                            <div class="session-info">
                                <div class="session-name">{{session.displayTitle}}</div>
                                <!-- Category name label (shown only in bookmark view) -->
                                <div class="session-category-tag" data-ng-if="vm.showBookmarksView && session.categoryName">
                                    {{session.categoryName}}
                                </div>
                            </div>
                            <i class="fa fa-check session-completed-icon" data-ng-if="session.isCompleted"></i>
                            <div class="session-progress-indicator" data-ng-if="session.isCompleted">
                                <i class="fa fa-check-circle"></i>
                            </div>
                            
                            <!-- Phase 4: Unbookmark button (shown only in bookmark view) -->
                            <button class="session-unbookmark-btn" 
                                    data-ng-if="vm.showBookmarksView"
                                    data-ng-click="vm.unbookmarkSession(session); $event.stopPropagation();"
                                    title="Remove this session from bookmarks">
                                <i class="fa fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Uncategorized Sessions (if any) -->
                <div class="chapter-group" data-ng-if="vm.filteredUncategorizedSessions.length > 0">
                    <div class="chapter-header enhanced-header" 
                         data-ng-click="vm.toggleChapter('uncategorized')"
                         data-ng-class="{'expanded': vm.expandedChapters['uncategorized']}">
                        <div class="header-icon">
                            <i class="fa" data-ng-class="vm.expandedChapters['uncategorized'] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                        </div>
                        <div class="chapter-info">
                            <div class="chapter-title">
                                General Sessions
                                <span class="session-count">({{vm.filteredUncategorizedSessions.length}} sessions)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sessions-list" 
                         data-ng-if="vm.expandedChapters['uncategorized']"
                         data-ng-animate="'slide'">
                        <div class="session-item" 
                             data-ng-repeat="session in vm.filteredUncategorizedSessions" 
                             data-ng-click="vm.selectSession(session)"
                             data-ng-class="{'session-active': vm.selectedSessionId === session.id, 'session-completed': session.isCompleted}">
                            <i class="fa fa-file-text"></i>
                            <div class="session-info">
                                <div class="session-name">{{session.displayTitle}}</div>
                                <!-- Category name label (shown only in bookmark view) -->
                                <div class="session-category-tag" data-ng-if="vm.showBookmarksView && session.categoryName">
                                    {{session.categoryName}}
                                </div>
                            </div>
                            <i class="fa fa-bookmark session-bookmark-icon" data-ng-if="session.isBookmarked && !vm.showBookmarksView" title="Bookmarked"></i>
                            <i class="fa fa-check session-completed-icon" data-ng-if="session.isCompleted"></i>
                            <div class="session-progress-indicator" data-ng-if="session.isCompleted">
                                <i class="fa fa-check-circle"></i>
                            </div>
                            
                            <!-- Phase 4: Unbookmark button (shown only in bookmark view) -->
                            <button class="session-unbookmark-btn" 
                                    data-ng-if="vm.showBookmarksView"
                                    data-ng-click="vm.unbookmarkSession(session); $event.stopPropagation();"
                                    title="Remove this session from bookmarks">
                                <i class="fa fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Categorized Sessions (hidden in bookmark view) -->
                <div class="chapter-group" 
                     data-ng-repeat="category in vm.filteredCategoriesWithSessions" 
                     data-ng-if="!vm.showBookmarksView && category.filteredSessions.length > 0">
                    
                    <div class="chapter-header enhanced-header" 
                         data-ng-click="vm.toggleChapter(category.id)"
                         data-ng-class="{'expanded': vm.expandedChapters[category.id]}">
                        <div class="header-icon">
                            <i class="fa" data-ng-class="vm.expandedChapters[category.id] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                        </div>
                        <div class="chapter-info">
                            <div class="chapter-title">
                                {{category.name}}
                                <span class="session-count">({{category.filteredSessions.length}} sessions)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sessions-list" 
                         data-ng-if="vm.expandedChapters[category.id]"
                         data-ng-animate="'slide'">
                        <div class="session-item" 
                             data-ng-repeat="session in category.filteredSessions" 
                             data-ng-click="vm.selectSession(session)"
                             data-ng-class="{'session-active': vm.selectedSessionId === session.id, 'session-completed': session.isCompleted}">
                            <i class="fa fa-file-text"></i>
                            <div class="session-info">
                                <div class="session-name">{{session.displayTitle}}</div>
                                <!-- Category name label (shown only in bookmark view) -->
                                <div class="session-category-tag" data-ng-if="vm.showBookmarksView && session.categoryName">
                                    {{session.categoryName}}
                                </div>
                            </div>
                            <i class="fa fa-bookmark session-bookmark-icon" data-ng-if="session.isBookmarked && !vm.showBookmarksView" title="Bookmarked"></i>
                            <i class="fa fa-check session-completed-icon" data-ng-if="session.isCompleted"></i>
                            <div class="session-progress-indicator" data-ng-if="session.isCompleted">
                                <i class="fa fa-check-circle"></i>
                            </div>
                            
                            <!-- Phase 4: Unbookmark button (shown only in bookmark view) -->
                            <button class="session-unbookmark-btn" 
                                    data-ng-if="vm.showBookmarksView"
                                    data-ng-click="vm.unbookmarkSession(session); $event.stopPropagation();"
                                    title="Remove this session from bookmarks">
                                <i class="fa fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- No Search Results State -->
                <div class="chapter-group" data-ng-if="vm.searchText && vm.filteredCategoriesWithSessions.length === 0 && vm.filteredUncategorizedSessions.length === 0">
                    <div class="session-item no-results">
                        <i class="fa fa-search" style="color: #6c757d;"></i>
                        <div class="session-name" style="color: #6c757d; font-style: italic;">
                            No sessions found for "{{vm.searchText}}"
                        </div>
                    </div>
                </div>

                <!-- Phase 4: Empty Bookmarks State -->
                <div class="chapter-group" data-ng-if="vm.showBookmarksView && vm.getBookmarkedSessions().length === 0">
                    <div class="session-item no-results">
                        <i class="fa fa-bookmark-o" style="color: #6c757d;"></i>
                        <div class="session-name" style="color: #6c757d; font-style: italic;">
                            No bookmarked sessions yet. Click the bookmark icon next to any session to add it here.
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="chapter-group" data-ng-if="!vm.showBookmarksView && !vm.searchText && vm.sessions.length === 0 && !vm.isLoading">
                    <div class="session-item">
                        <i class="fa fa-info-circle" style="color: #6c757d;"></i>
                        <div class="session-name" style="color: #6c757d; font-style: italic;">
                            No sessions available for this album.
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Reading Content Pane -->
    <div class="reader-content-pane" data-ng-if="!vm.isLoading">
        
        <!-- Welcome Message (when no session selected) -->
        <div class="session-content" data-ng-if="!vm.selectedSession">
                <div class="session-header">
                    <h1 class="session-title">Welcome to {{vm.album.name || 'Beautiful Islam Reader'}}</h1>
                    <div class="session-meta">
                        <div class="reading-time" data-ng-if="vm.totalSessions > 0">
                            {{vm.totalSessions}} session{{vm.totalSessions !== 1 ? 's' : ''}} available
                        </div>
                    </div>
                </div>
                
                <div class="content-body">
                    <p data-ng-if="vm.totalSessions > 0">
                        Select a session from the table of contents to begin reading.
                    </p>
                    <p data-ng-if="vm.totalSessions === 0">
                        This album does not contain any sessions yet.
                    </p>
                    <p data-ng-if="vm.album.description">
                        <strong>About this collection:</strong> {{vm.album.description}}
                    </p>
                </div>
            </div>

            <!-- Session Content (when session is selected) -->
            <div class="session-content" data-ng-if="vm.selectedSession">
                
                <!-- Session Loading State -->
                <div class="session-header" data-ng-if="vm.isLoadingSession">
                    <h1 class="session-title">Loading Session...</h1>
                    <div class="content-body">
                        <p><i class="fa fa-spinner fa-spin"></i> Loading session content...</p>
                    </div>
                </div>

                <!-- Session Header -->
                <div class="session-header" data-ng-if="!vm.isLoadingSession">
                    <div class="session-header-wrapper">
                        <h1 class="session-title">{{vm.selectedSession.displayTitle}}</h1>
                        <div class="session-meta">
                            <div class="reading-time" data-ng-if="vm.selectedSession.estimatedMinutes > 0">
                                {{vm.selectedSession.estimatedMinutes}} min read
                            </div>
                            <!-- Phase 2: Session Progress Controls -->
                            <div class="session-progress-controls">
                                <button class="btn btn-outline-secondary btn-lg icon-only-btn" 
                                        data-ng-if="!vm.selectedSession.isCompleted"
                                        data-ng-click="vm.markSessionComplete(vm.selectedSession.id)"
                                        title="Mark this session as completed">
                                    <i class="fa fa-check fa-lg"></i>
                                </button>
                                <button class="btn btn-success btn-lg icon-only-btn" 
                                        data-ng-if="vm.selectedSession.isCompleted"
                                        data-ng-click="vm.markSessionIncomplete(vm.selectedSession.id)"
                                        title="Mark this session as incomplete">
                                    <i class="fa fa-undo fa-lg"></i>
                                </button>
                                
                                <!-- Phase 2: Session Bookmarking Controls -->
                                <button class="btn btn-outline-warning btn-lg icon-only-btn" 
                                        data-ng-if="!vm.isBookmarked"
                                        data-ng-click="vm.toggleBookmark(vm.selectedSession)"
                                        title="Bookmark this session">
                                    <i class="fa fa-bookmark-o fa-lg"></i>
                                </button>
                                <button class="btn btn-warning btn-lg icon-only-btn" 
                                        data-ng-if="vm.isBookmarked"
                                        data-ng-click="vm.toggleBookmark(vm.selectedSession)"
                                        title="Remove bookmark">
                                    <i class="fa fa-bookmark fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Content Body -->
                <div class="content-body" 
                     data-ng-if="!vm.isLoadingSession && vm.selectedSession.content"
                     data-ng-bind-html="vm.getHighlightedContent()">
                </div>

                <!-- Empty Content State -->
                <div class="content-body" data-ng-if="!vm.isLoadingSession && !vm.selectedSession.content">
                    <p style="color: #6c757d; font-style: italic;">
                        <i class="fa fa-info-circle"></i>
                        No content available for this session.
                    </p>
                </div>

                <!-- Session Navigation -->
                <div class="session-navigation" data-ng-if="!vm.isLoadingSession && vm.totalSessions > 1">
                    <button class="btn" 
                            data-ng-click="vm.navigateToPrevious()" 
                            data-ng-disabled="!vm.hasPrevious"
                            title="Previous Session">
                        <i class="fa fa-chevron-left"></i>
                        Previous
                    </button>
                    
                    <div style="text-align: center; color: #6c757d; font-size: 14px;">
                        {{vm.currentSessionIndex + 1}} of {{vm.totalSessions}}
                    </div>
                    
                    <button class="btn" 
                            data-ng-click="vm.navigateToNext()" 
                            data-ng-disabled="!vm.hasNext"
                            title="Next Session">
                        Next
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>
</div>
