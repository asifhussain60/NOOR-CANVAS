<div class="matter admin-utilities-container admin-utility-standard-font" data-ng-controller="adminSqlBackupsCtl">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="widget wviolet">
                    <div class="widget-head">
                        <div class="pull-left">
                            <i class="fa fa-database"></i> SQL Database Backup Manager
                        </div>
                        <div class="widget-icons pull-right">
                            <a href="#" class="wminimize"><i class="fa fa-chevron-up"></i></a>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div class="widget-content">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info">
                                    <i class="fa fa-info-circle"></i>
                                    <strong>Database Backup Hub:</strong> Manage comprehensive database backups with real-time progress monitoring based on KSESSIONS BACKUP.bat workflow.
                                </div>
                            </div>
                        </div>

                        <!-- Comprehensive Backup Panel -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="panel panel-warning" style="border-left: 5px solid #f39c12;">
                                    <div class="panel-heading" style="background-color: #e67e22; color: white;">
                                        <h4><i class="fa fa-cogs"></i> Comprehensive Backup System</h4>
                                        <small data-ng-if="vm.isDevelopmentEnvironment">Based on KSESSIONS BACKUP.bat with real-time progress monitoring</small>
                                        <small data-ng-if="!vm.isDevelopmentEnvironment">Production database backup system - Limited functionality</small>
                                    </div>
                                    <div class="panel-body" style="background-color: #fefcf8;">
                                        <!-- Production Environment Warning -->
                                        <div class="alert alert-warning" data-ng-if="!vm.isDevelopmentEnvironment" style="margin-bottom: 15px;">
                                            <i class="fa fa-exclamation-triangle"></i>
                                            <strong>Production Environment Notice:</strong> 
                                            This system is running in production mode. Database backup operations are limited for security reasons.
                                            For production database backups, please use SQL Server Management Studio or contact the database administrator.
                                        </div>
                                        
                                        <div class="row">
                                            <!-- Backup Options -->
                                            <div class="col-md-6">
                                                <h5><i class="fa fa-settings"></i> Backup Options</h5>
                                                <div class="form-group">
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" data-ng-model="vm.comprehensiveBackup.includeDatabase">
                                                            <strong>Include Database</strong> - Backup KSESSIONS & KQUR databases
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" data-ng-model="vm.comprehensiveBackup.createDevEnvironment">
                                                            <strong>Create DEV Environment</strong> - Generate development databases
                                                        </label>
                                                    </div>
                                                </div>

                                                <button class="btn btn-warning btn-lg" 
                                                        data-ng-click="vm.createComprehensiveBackup()" 
                                                        data-ng-disabled="vm.backupProgress.isActive || vm.restoreProgress.isActive"
                                                        style="margin-top: 10px;">
                                                    <i class="fa fa-rocket" data-ng-if="!vm.backupProgress.isActive && !vm.restoreProgress.isActive"></i>
                                                    <i class="fa fa-spinner fa-spin" data-ng-if="vm.backupProgress.isActive || vm.restoreProgress.isActive"></i>
                                                    <span data-ng-if="!vm.backupProgress.isActive && !vm.restoreProgress.isActive">Start Comprehensive Backup</span>
                                                    <span data-ng-if="vm.backupProgress.isActive">Backup in Progress...</span>
                                                    <span data-ng-if="vm.restoreProgress.isActive">Database Restore in Progress...</span>
                                                </button>

                                                <button class="btn btn-danger btn-sm" 
                                                        data-ng-click="vm.cancelBackup()" 
                                                        data-ng-if="vm.backupProgress.isActive"
                                                        style="margin-left: 10px;">
                                                    <i class="fa fa-stop"></i> Cancel
                                                </button>
                                                
                                                <button class="btn btn-danger btn-xs" 
                                                        data-ng-click="vm.emergencyStop()" 
                                                        data-ng-if="vm.backupProgress.isActive"
                                                        style="margin-left: 5px; background-color: #dc3545; border-color: #dc3545;"
                                                        title="Force stop all backup operations immediately">
                                                    <i class="fa fa-ban"></i> Emergency Stop
                                                </button>
                                            </div>

                                            <!-- Progress Monitor -->
                                            <div class="col-md-6">
                                                <h5><i class="fa fa-tachometer"></i> Backup Progress Monitor</h5>
                                                
                                                <!-- Show completion status when not active and result exists -->
                                                <div data-ng-if="!vm.backupProgress.isActive && vm.lastBackupResult && !vm.lastBackupResult.hidden" 
                                                     class="alert" 
                                                     data-ng-class="{'alert-success': vm.lastBackupResult.success, 'alert-danger': !vm.lastBackupResult.success}"
                                                     style="border-left: 4px solid; padding: 15px;">
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <div style="display: flex; align-items: center;">
                                                                <i class="fa fa-lg" 
                                                                   data-ng-class="{'fa-check-circle text-success': vm.lastBackupResult.success, 'fa-times-circle text-danger': !vm.lastBackupResult.success}"
                                                                   style="margin-right: 12px;"></i>
                                                                <div>
                                                                    <strong>{{vm.lastBackupResult.success ? 'Backup Completed Successfully' : 'Backup Failed'}}</strong>
                                                                    <br>
                                                                    <small class="text-muted">
                                                                        {{vm.lastBackupResult.timestamp | date:'MMM dd, yyyy - h:mm a'}}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2 text-right">
                                                            <button class="btn btn-xs btn-default" 
                                                                    data-ng-click="vm.lastBackupResult.hidden = true"
                                                                    title="Hide this message">
                                                                <i class="fa fa-times"></i> Hide
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Show ready message when not active and no result -->
                                                <div data-ng-if="!vm.backupProgress.isActive && !vm.lastBackupResult" class="alert alert-info">
                                                    <i class="fa fa-info-circle"></i> Ready to start comprehensive backup
                                                </div>

                                                <!-- Progress Display during active backup -->
                                                <div data-ng-if="vm.backupProgress.isActive" class="panel panel-info">
                                                    <div class="panel-body">
                                                        <!-- Current Stage Header -->
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <h6><strong>{{vm.backupProgress.stage}}</strong></h6>
                                                                <p>{{vm.backupProgress.message}}</p>
                                                            </div>
                                                            <div class="col-md-4 text-right" data-ng-if="vm.backupProgress.estimatedTimeRemaining">
                                                                <small class="text-muted">
                                                                    <i class="fa fa-clock-o"></i> {{vm.backupProgress.estimatedTimeRemaining}}
                                                                </small>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Overall Progress Bar -->
                                                        <div class="progress" style="margin-bottom: 15px;">
                                                            <div class="progress-bar progress-bar-striped active" 
                                                                 data-ng-class="{
                                                                     'progress-bar-success': vm.backupProgress.percentComplete >= 100,
                                                                     'progress-bar-warning': vm.backupProgress.percentComplete >= 80 && vm.backupProgress.percentComplete < 100,
                                                                     'progress-bar-info': vm.backupProgress.percentComplete < 80
                                                                 }"
                                                                 style="width: {{vm.backupProgress.percentComplete}}%">
                                                                {{vm.backupProgress.percentComplete}}%
                                                            </div>
                                                        </div>

                                                        <!-- Progress Checklist -->
                                                        <div class="list-group" style="margin-bottom: 0;">
                                                            <div data-ng-repeat="item in vm.backupProgress.checklist" 
                                                                 data-ng-if="!item.hidden"
                                                                 class="list-group-item" 
                                                                 data-ng-class="{
                                                                     'list-group-item-info': item.status === 'active',
                                                                     'list-group-item-success': item.status === 'completed',
                                                                     'list-group-item-danger': item.status === 'error',
                                                                     'list-group-item-warning': item.status === 'cancelled'
                                                                 }"
                                                                 style="padding: 8px 12px;">
                                                                <div class="row">
                                                                    <div class="col-md-1">
                                                                        <!-- Status Icons -->
                                                                        <span data-ng-if="item.status === 'pending'" class="text-muted">
                                                                            <i class="fa fa-circle-o fa-2x"></i>
                                                                        </span>
                                                                        <span data-ng-if="item.status === 'active'" class="text-info">
                                                                            <i class="fa fa-spinner fa-spin fa-2x"></i>
                                                                        </span>
                                                                        <span data-ng-if="item.status === 'completed'" class="text-success">
                                                                            <i class="fa fa-check-circle fa-2x"></i>
                                                                        </span>
                                                                        <span data-ng-if="item.status === 'error'" class="text-danger">
                                                                            <i class="fa fa-times-circle fa-2x"></i>
                                                                        </span>
                                                                        <span data-ng-if="item.status === 'cancelled'" class="text-warning">
                                                                            <i class="fa fa-minus-circle fa-2x"></i>
                                                                        </span>
                                                                    </div>
                                                                    <div class="col-md-11">
                                                                        <div class="row">
                                                                            <div class="col-md-8">
                                                                                <strong>{{item.icon}} {{item.name}}</strong>
                                                                                <br>
                                                                                <small class="text-muted">{{item.message}}</small>
                                                                            </div>
                                                                            <div class="col-md-4 text-right">
                                                                                <span data-ng-if="item.status === 'pending'" class="label label-default">
                                                                                    Waiting
                                                                                </span>
                                                                                <span data-ng-if="item.status === 'active'" class="label label-info">
                                                                                    <i class="fa fa-cog fa-spin"></i> In Progress
                                                                                </span>
                                                                                <span data-ng-if="item.status === 'completed'" class="label label-success">
                                                                                    <i class="fa fa-check fa-lg"></i> Done
                                                                                </span>
                                                                                <span data-ng-if="item.status === 'error'" class="label label-danger">
                                                                                    <i class="fa fa-exclamation"></i> Error
                                                                                </span>
                                                                                <span data-ng-if="item.status === 'cancelled'" class="label label-warning">
                                                                                    <i class="fa fa-ban"></i> Cancelled
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Restore Progress Panel -->
                                    <div class="panel panel-info" data-ng-if="vm.restoreProgress.isActive || vm.restoreProgress.isComplete">
                                        <div class="panel-heading">
                                            <h4><i class="fa fa-cloud-download"></i> Database Restore Progress</h4>
                                        </div>
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <div class="form-group">
                                                        <label><strong>Target Database:</strong></label>
                                                        <span class="label label-warning">{{vm.restoreProgress.targetDatabase || 'Not Set'}}</span>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label><strong>Source File:</strong></label>
                                                        <span data-ng-if="vm.restoreProgress.sourceFile">{{vm.restoreProgress.sourceFile}}</span>
                                                        <span data-ng-if="!vm.restoreProgress.sourceFile">-</span>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label><strong>Progress:</strong></label>
                                                        <div class="progress" style="margin-bottom: 10px;">
                                                            <div class="progress-bar progress-bar-success progress-bar-striped active" 
                                                                 role="progressbar" 
                                                                 aria-valuenow="{{vm.restoreProgress.percentComplete}}" 
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100" 
                                                                 style="width: {{vm.restoreProgress.percentComplete}}%">
                                                                {{vm.restoreProgress.percentComplete}}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label><strong>Current Step:</strong></label>
                                                        <span>{{vm.restoreProgress.currentMessage}}</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label><strong>Status:</strong></label>
                                                        <br />
                                                        <span class="label label-info" data-ng-if="vm.restoreProgress.isActive">
                                                            <i class="fa fa-spinner fa-spin"></i> In Progress
                                                        </span>
                                                        <span class="label label-success" data-ng-if="vm.restoreProgress.isComplete && !vm.restoreProgress.hasError">
                                                            <i class="fa fa-check fa-lg"></i> Completed
                                                        </span>
                                                        <span class="label label-danger" data-ng-if="vm.restoreProgress.hasError">
                                                            <i class="fa fa-exclamation-triangle"></i> Error
                                                        </span>
                                                    </div>
                                                    
                                                    <div class="form-group" data-ng-if="vm.restoreProgress.startTime">
                                                        <label><strong>Started:</strong></label>
                                                        <br />
                                                        <small>{{vm.restoreProgress.startTime | date:'medium'}}</small>
                                                    </div>
                                                    
                                                    <div class="form-group" data-ng-if="vm.restoreProgress.endTime">
                                                        <label><strong>Completed:</strong></label>
                                                        <br />
                                                        <small>{{vm.restoreProgress.endTime | date:'medium'}}</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Error Details -->
                                            <div class="row" data-ng-if="vm.restoreProgress.hasError">
                                                <div class="col-md-12">
                                                    <div class="alert alert-danger">
                                                        <h5><i class="fa fa-exclamation-triangle"></i> Restore Error Details</h5>
                                                        <p>{{vm.restoreProgress.errorMessage}}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Schema & Data Export -->
                        <div class="row" style="margin-top: 20px;">
                            <div class="col-md-12">
                                <div class="panel panel-success" style="border-left: 5px solid #5cb85c;">
                                    <div class="panel-heading" style="background-color: #5cb85c; color: white;">
                                        <h4><i class="fa fa-code"></i> Database Schema & Data Export</h4>
                                        <small>Generate SQL scripts for database schema and data</small>
                                    </div>
                                    <div class="panel-body" style="background-color: #f9fff9;">
                                        <div class="row">
                                            <!-- Database Selection -->
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="exportDatabase" style="font-weight: 600; color: #2c3e50;">
                                                        <i class="fa fa-database"></i> Select Database:
                                                    </label>
                                                    <select id="exportDatabase" 
                                                            class="form-control" 
                                                            data-ng-model="vm.databaseExport.selectedDatabase"
                                                            data-ng-change="vm.updateGeneratedFilename()"
                                                            style="font-size: 16px;">
                                                        <option value="">-- Select Database --</option>
                                                        <option data-ng-repeat="db in vm.databaseExport.availableDatabases" value="{{db}}">
                                                            {{db}} {{db === 'KSESSIONS' ? '(Main Application - Production)' : '(Quran Content - Production)'}}
                                                        </option>
                                                    </select>
                                                </div>
                                                
                                                <div class="form-group">
                                                    <label style="font-weight: 600; color: #2c3e50;">
                                                        <i class="fa fa-gear"></i> Export Options:
                                                    </label>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" 
                                                                   data-ng-model="vm.databaseExport.includeSchema"
                                                                   data-ng-change="vm.updateGeneratedFilename()">
                                                            <strong>Schema</strong> - Database structure (tables, views, procedures)
                                                        </label>
                                                    </div>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" 
                                                                   data-ng-model="vm.databaseExport.includeData"
                                                                   data-ng-change="vm.updateGeneratedFilename()">
                                                            <strong>Data</strong> - Table data and content
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- File Location and Name -->
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label for="scriptFileName" style="font-weight: 600; color: #2c3e50;">
                                                        <i class="fa fa-file-code-o"></i> Script File Name:
                                                    </label>
                                                    <input type="text" 
                                                           id="scriptFileName"
                                                           class="form-control" 
                                                           data-ng-model="vm.databaseExport.filename"
                                                           placeholder="Enter filename (e.g., KSESSIONS_Custom_Export.sql)"
                                                           style="font-family: 'Courier New', monospace; font-size: 14px;">
                                                    <small class="help-block text-muted">
                                                        <i class="fa fa-info-circle"></i> 
                                                        The filename will automatically get .sql extension if not provided
                                                    </small>
                                                </div>
                                                
                                                <div class="form-group">
                                                    <label style="font-weight: 600; color: #2c3e50;">
                                                        <i class="fa fa-info-circle"></i> Export Location:
                                                    </label>
                                                    <div class="well well-sm" style="background-color: #ecf0f1; margin-bottom: 0;">
                                                        <small style="font-family: 'Courier New', monospace; word-break: break-all;">
                                                            D:\PROJECTS\KSESSIONS\Workspaces\DATA\
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <div class="form-group">
                                                    <label style="font-weight: 600; color: #2c3e50;">
                                                        <i class="fa fa-info-circle"></i> Full Export Path:
                                                    </label>
                                                    <div class="well well-sm" style="background-color: #ecf0f1; margin-bottom: 0;">
                                                        <small style="font-family: 'Courier New', monospace; word-break: break-all;">
                                                            {{vm.getSimpleExportPath() || 'Please select database and enter filename'}}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="col-md-3">
                                                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 15px;">
                                                    <i class="fa fa-play"></i> Actions:
                                                </label>
                                                
                                                <button class="btn btn-success btn-lg btn-block" 
                                                        data-ng-click="vm.generateDatabaseExport()" 
                                                        data-ng-disabled="!vm.databaseExport.selectedDatabase || (!vm.databaseExport.includeSchema && !vm.databaseExport.includeData) || vm.databaseExport.isExporting"
                                                        style="margin-bottom: 10px;">
                                                    <i class="fa fa-cog" data-ng-if="!vm.databaseExport.isExporting"></i>
                                                    <i class="fa fa-spinner fa-spin" data-ng-if="vm.databaseExport.isExporting"></i>
                                                    <span data-ng-if="!vm.databaseExport.isExporting">Generate Export</span>
                                                    <span data-ng-if="vm.databaseExport.isExporting">Exporting...</span>
                                                </button>
                                                
                                                <!-- Progress Indicator -->
                                                <div data-ng-if="vm.databaseExport.isExporting" class="progress" style="margin-top: 10px;">
                                                    <div data-ng-class="vm.getExportProgressBarClass()" 
                                                         data-ng-style="{'width': (vm.databaseExport.progressPercent || 0) + '%'}">
                                                        {{vm.databaseExport.progressPercent || 0}}%
                                                    </div>
                                                </div>
                                                
                                                <!-- Stage Indicator -->
                                                <div data-ng-if="vm.databaseExport.isExporting && vm.databaseExport.currentStage" 
                                                     class="well well-sm" style="margin-top: 5px; margin-bottom: 0; padding: 5px 10px; background: #f8f9fa;">
                                                    <small>
                                                        <i class="fa fa-cog fa-spin" style="color: #337ab7; margin-right: 5px;"></i>
                                                        <strong>Current Stage:</strong> 
                                                        <span style="color: #337ab7;">{{vm.databaseExport.currentStage}}</span>
                                                    </small>
                                                </div>
                                                
                                                <!-- Status Display -->
                                                <div data-ng-if="vm.databaseExport.exportStatus" class="alert alert-info" style="margin-top: 10px; padding: 8px;">
                                                    <small><i class="fa fa-info-circle"></i> {{vm.databaseExport.exportStatus}}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Backups for Restore -->
                        <div class="row" style="margin-top: 20px;">
                            <div class="col-md-12">
                                <div class="panel panel-primary" style="border-color: #428bca; overflow: visible;">
                                    <div class="panel-heading" style="background-color: #428bca; border-color: #428bca; color: white;">
                                        <h4><i class="fa fa-history"></i> Recent Backups Available for Restore</h4>
                                    </div>
                                    <div class="panel-body" style="padding: 15px; overflow: visible;">
                                        
                                        <!-- Error Display -->
                                        <div data-ng-if="vm.backupError && vm.backupError.hasError" class="alert alert-warning" style="margin-bottom: 20px;">
                                            <div class="row">
                                                <div class="col-md-10">
                                                    <h5><i class="fa fa-exclamation-triangle"></i> Backup Directory Access Issue</h5>
                                                    <p><strong>{{vm.backupError.message}}</strong></p>
                                                    <details style="margin-top: 10px;">
                                                        <summary style="cursor: pointer; color: #337ab7;">
                                                            <small><i class="fa fa-info-circle"></i> Technical Details (Click to expand)</small>
                                                        </summary>
                                                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-left: 3px solid #6c757d;">
                                                            <small style="font-family: monospace; word-break: break-all;">{{vm.backupError.details}}</small>
                                                        </div>
                                                    </details>
                                                </div>
                                                <div class="col-md-2 text-right">
                                                    <button class="btn btn-xs btn-default" 
                                                            data-ng-click="vm.backupError.hasError = false"
                                                            title="Hide this error message">
                                                        <i class="fa fa-times"></i> Hide
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="overflow: visible; position: relative;">
                                            <table class="table table-striped table-hover" style="margin-bottom: 0; overflow: visible;">
                                                <thead>
                                                    <tr style="background-color: #f5f5f5;">
                                                        <th style="width: 25%;">
                                                            <i class="fa fa-file"></i> Backup File
                                                        </th>
                                                        <th style="width: 15%;">
                                                            <i class="fa fa-calendar"></i> Date
                                                        </th>
                                                        <th style="width: 10%;">
                                                            <i class="fa fa-clock-o"></i> Time
                                                        </th>
                                                        <th style="width: 15%;">
                                                            <i class="fa fa-hdd-o"></i> Size
                                                        </th>
                                                        <th style="width: 20%;">
                                                            <i class="fa fa-arrow-right"></i> Auto Target
                                                        </th>
                                                        <th style="width: 15%;">
                                                            <i class="fa fa-cogs"></i> Actions
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody style="overflow: visible;">
                                                    <tr data-ng-repeat="backup in vm.recentBackups" style="overflow: visible;">
                                                        <td>
                                                            <strong>{{backup.fileName}}</strong>
                                                            <br>
                                                            <small class="text-muted">{{backup.fullPath}}</small>
                                                        </td>
                                                        <td>{{backup.date || (backup.created | date:'MM/dd/yyyy')}}</td>
                                                        <td>{{vm.convertTo12HourTime(backup.time) || (backup.created | date:'h:mm a')}}</td>
                                                        <td>
                                                            <span class="label label-info">{{backup.size}}</span>
                                                        </td>
                                                        <td>
                                                            <span class="label label-success">
                                                                <i class="fa fa-database"></i> {{vm.getTargetDatabase(backup)}}
                                                            </span>
                                                        </td>
                                                        <td style="position: relative; overflow: visible;">
                                            <div class="btn-group" data-ng-if="!vm.restoreProgress.isActive" style="position: static;">
                                                <button class="btn btn-sm btn-danger dropdown-toggle" 
                                                        type="button" 
                                                        data-bs-toggle="dropdown" 
                                                        aria-haspopup="true" 
                                                        aria-expanded="false"
                                                        data-ng-disabled="vm.backupProgress.isActive"
                                                        title="Choose restore target for {{backup.fileName}}">
                                                    <i class="fa fa-database"></i> Restore
                                                    <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-right" style="min-width: 250px; max-height: 400px; overflow-y: auto; z-index: 1060;">
                                                    <li class="dropdown-header">
                                                        <i class="fa fa-file"></i> <strong>{{backup.fileName}}</strong>
                                                    </li>
                                                    <li class="divider"></li>
                                                    <li class="dropdown-header">
                                                        <small>
                                                            <i class="fa fa-magic text-success"></i> <strong>Recommended Target</strong>
                                                        </small>
                                                    </li>
                                                    <li>
                                                        <a href="#" data-ng-click="vm.restoreDatabase(backup); $event.preventDefault();" style="padding: 8px 15px;">
                                                            <i class="fa fa-arrow-right text-success"></i>
                                                            <strong>{{vm.getTargetDatabase(backup)}}</strong>
                                                            <br>
                                                            <small class="text-muted">Auto-detected restore target</small>
                                                        </a>
                                                    </li>
                                                    <li class="divider"></li>
                                                    <li class="dropdown-header">
                                                        <small>
                                                            <i class="fa fa-list text-info"></i> <strong>All Available Databases</strong>
                                                        </small>
                                                    </li>
                                                    <li data-ng-repeat="database in vm.availableDatabases">
                                                        <a href="#" data-ng-click="vm.restoreDatabase(backup, database.name); $event.preventDefault();" style="padding: 8px 15px;">
                                                            <i class="fa fa-database text-primary"></i>
                                                            <strong>{{database.name}}</strong>
                                                            <br>
                                                            <small class="text-muted">{{database.description}}</small>
                                                        </a>
                                                    </li>
                                                    <li data-ng-if="vm.isLoadingDatabases">
                                                        <a href="#" class="disabled" style="padding: 8px 15px;">
                                                            <i class="fa fa-spinner fa-spin"></i> Loading databases...
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>                                                            <div data-ng-if="vm.restoreProgress.isActive">
                                                                <button class="btn btn-sm btn-danger" disabled>
                                                                    <i class="fa fa-spinner fa-spin"></i> Restoring...
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr data-ng-if="vm.recentBackups.length === 0">
                                                        <td colspan="6" class="text-center text-muted" style="padding: 30px;">
                                                            <i class="fa fa-info-circle fa-2x"></i>
                                                            <br>
                                                            <strong>No backup files available</strong>
                                                            <br>
                                                            <small>Create a backup first before attempting to restore</small>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>




                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fix for jQuery dropdown issue with mCustomScrollbar conflict
$(document).ready(function() {
    // Ensure Bootstrap dropdown works correctly
    $(document).on('click', '.dropdown-toggle', function(e) {
        e.stopPropagation();
        var $dropdown = $(this).parent();
        var isOpen = $dropdown.hasClass('open');
        
        // Close all other dropdowns
        $('.dropdown').removeClass('open');
        
        // Toggle current dropdown
        if (!isOpen) {
            $dropdown.addClass('open');
        }
    });
    
    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.dropdown').length) {
            $('.dropdown').removeClass('open');
        }
    });
    
    // Close dropdown when clicking on menu item
    $(document).on('click', '.dropdown-menu a', function(e) {
        $(this).closest('.dropdown').removeClass('open');
    });
    
    // CRITICAL: Clear all intervals on page unload to prevent runaway processes
    $(window).on('beforeunload', function() {
        // Clear any backup polling intervals that might be running
        var scope = angular.element('[data-ng-controller="adminSqlBackupsCtl"]').scope();
        if (scope && scope.vm) {
            if (scope.vm.backupProgress && scope.vm.backupProgress.pollingInterval) {
                clearInterval(scope.vm.backupProgress.pollingInterval);
                console.log("DEBUG: Cleared backup polling interval on page unload");
            }
            if (scope.vm.statusCheckInterval) {
                clearInterval(scope.vm.statusCheckInterval);
                console.log("DEBUG: Cleared status check interval on page unload");
            }
            // Set cancellation flags
            if (scope.vm.backupProgress) {
                scope.vm.backupProgress.isCancelled = true;
                scope.vm.backupProgress.isActive = false;
            }
        }
    });
    
    // EMERGENCY: Global function to force clear ALL intervals (call from browser console if needed)
    window.emergencyStopAllBackupIntervals = function() {
        console.log("EMERGENCY: Clearing all possible intervals...");
        
        // Clear all numbered intervals (brute force approach)
        var maxIntervalId = 10000; // Check up to 10000 interval IDs
        for (var i = 1; i <= maxIntervalId; i++) {
            clearInterval(i);
        }
        
        // Also clear specific intervals if controller is available
        var scope = angular.element('[data-ng-controller="adminSqlBackupsCtl"]').scope();
        if (scope && scope.vm) {
            if (scope.vm.backupProgress && scope.vm.backupProgress.pollingInterval) {
                clearInterval(scope.vm.backupProgress.pollingInterval);
                scope.vm.backupProgress.pollingInterval = null;
            }
            if (scope.vm.statusCheckInterval) {
                clearInterval(scope.vm.statusCheckInterval);
                scope.vm.statusCheckInterval = null;
            }
            // Force set cancellation flags
            if (scope.vm.backupProgress) {
                scope.vm.backupProgress.isCancelled = true;
                scope.vm.backupProgress.isActive = false;
            }
            scope.vm.currentBackupId = null;
            console.log("EMERGENCY: Controller state reset");
        }
        
        console.log("EMERGENCY: All intervals cleared - backup should stop");
        alert("EMERGENCY STOP: All intervals have been cleared. The runaway backup process should now stop.");
    };
});
</script>

<style>
/* Standard 18px font-size for all utility UI elements */
.admin-utility-standard-font,
.admin-utility-standard-font * {
    font-size: 18px !important;
}

/* Maintain proportional sizing for specific elements */
.admin-utility-standard-font h1 { font-size: 36px !important; }
.admin-utility-standard-font h2 { font-size: 32px !important; }
.admin-utility-standard-font h3 { font-size: 28px !important; }
.admin-utility-standard-font h4 { font-size: 24px !important; }
.admin-utility-standard-font h5 { font-size: 20px !important; }
.admin-utility-standard-font h6 { font-size: 18px !important; }
.admin-utility-standard-font small { font-size: 16px !important; }
.admin-utility-standard-font .fa { font-size: 18px !important; }
.admin-utility-standard-font .fa-lg { font-size: 22px !important; }
.admin-utility-standard-font .fa-2x { font-size: 36px !important; }
</style>
