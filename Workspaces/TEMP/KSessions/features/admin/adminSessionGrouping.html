<div class="matter" data-ng-controller="adminSessionGroupingCtl">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="admin-widget wred">
                    <div class="admin-widget-head">
                        <i class="fa fa-compress"></i>
                        <span class="padding-left10">Session Grouping Tool</span>
                    </div>
                    
                    <div class="admin-widget-content">
                        <div class="padd">
                            
                            <!-- Status Messages -->
                            <div class="row" data-ng-show="vm.isLoading || vm.error || vm.successMessage">
                                <div class="col-md-12">
                                    <!-- Loading Indicator -->
                                    <div class="alert alert-info" data-ng-show="vm.isLoading">
                                        <i class="fa fa-spinner fa-spin"></i> Loading...
                                    </div>

                                    <!-- Error Display -->
                                    <div class="alert alert-danger" data-ng-show="vm.error">
                                        <i class="fa fa-exclamation-triangle"></i>
                                        <strong>Error:</strong> {{vm.error}}
                                        <button type="button" class="close" data-ng-click="vm.error = null">
                                            <span>&times;</span>
                                        </button>
                                    </div>

                                    <!-- Success Messages -->
                                    <div class="alert alert-success" data-ng-show="vm.successMessage">
                                        <i class="fa fa-check-circle"></i>
                                        {{vm.successMessage}}
                                        <button type="button" class="close" data-ng-click="vm.successMessage = null">
                                            <span>&times;</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Session Selection using zuSessionSelection directive -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        <i class="fa fa-cogs"></i> Session Selection for Grouping
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="form-horizontal">
                                        
                                        <!-- Using the zuSessionSelection directive like adminSession.html -->
                                        <div zu-session-selection=""
                                             data-album-id-field="vm.selectedAlbumId"
                                             data-category-id-field="vm.selectedCategoryId"
                                             data-session-id-field="vm.selectedSessionId"
                                             data-on-album-select="vm.onAlbumChanged"
                                             data-on-category-select="vm.onCategoryChanged"
                                             data-on-session-select="vm.onSessionSelect"
                                             data-filter-by-category="true"
                                             data-show-manage-buttons="false">
                                        </div>
                                        
                                        <!-- Auto-load instructions -->
                                        <div class="form-group">
                                            <div class="col-md-offset-3 col-md-6">
                                                <div class="alert alert-info" data-ng-show="vm.selectedAlbumId && vm.selectedCategoryId && !vm.sampleDataLoaded && !vm.isLoading">
                                                    <i class="fa fa-info-circle"></i> Sessions will load automatically when both album and category are selected.
                                                </div>
                                                <div class="alert alert-success" data-ng-show="vm.sampleDataLoaded">
                                                    <i class="fa fa-check-circle"></i> {{vm.availableSessions.length}} sessions loaded and ready for grouping.
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>

                            <!-- Sample Data Display -->
                            <div class="panel panel-warning" data-ng-if="vm.sampleDataLoaded">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        <i class="fa fa-database"></i> Sample Sessions Data
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th><i class="fa fa-check"></i></th>
                                                    <th>Session Name</th>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr data-ng-repeat="session in vm.availableSessions">
                                                    <td>
                                                        <input type="checkbox" 
                                                               data-ng-model="session.selected"
                                                               data-ng-change="vm.toggleSessionSelection(session)">
                                                    </td>
                                                    <td><strong>{{session.name}}</strong></td>
                                                    <td>{{session.date | date:'MMM dd, yyyy'}}</td>
                                                    <td>{{session.description}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="alert alert-info" data-ng-if="vm.selectedSessionsCount > 0">
                                        <strong>{{vm.selectedSessionsCount}}</strong> sessions selected for grouping.
                                        <div class="btn-group pull-right">
                                            <button type="button" class="btn btn-sm btn-default" data-ng-click="vm.selectAllSessions()">
                                                <i class="fa fa-check-square"></i> Select All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-default" data-ng-click="vm.clearAllSelections()">
                                                <i class="fa fa-square-o"></i> Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Group Creation Form -->
                            <div class="panel panel-success" data-ng-show="vm.selectedSessionsCount > 1">
                                <div class="panel-heading">
                                    <h4><i class="fa fa-plus-circle"></i> Create Session Group</h4>
                                </div>
                                <div class="panel-body">
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <label class="control-label col-md-3">Group Name <span class="text-danger">*</span></label>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control" 
                                                       data-ng-model="vm.groupName"
                                                       placeholder="Enter group name..."
                                                       data-ng-disabled="vm.isLoading" />
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="control-label col-md-3">Description</label>
                                            <div class="col-md-6">
                                                <textarea class="form-control" rows="3"
                                                          data-ng-model="vm.groupDescription"
                                                          placeholder="Optional description for this session group..."
                                                          data-ng-disabled="vm.isLoading"></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <div class="col-md-offset-3 col-md-6">
                                                <button type="button" class="btn btn-info" 
                                                        data-ng-click="vm.previewGrouping()"
                                                        data-ng-disabled="vm.isLoading || !vm.groupName">
                                                    <i class="fa fa-eye"></i> Preview Group
                                                </button>
                                                <button type="button" class="btn btn-success" 
                                                        data-ng-click="vm.executeGrouping()"
                                                        data-ng-disabled="vm.isLoading || !vm.groupName">
                                                    <i class="fa fa-save"></i> Create Group
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Silent Background Test Script -->
<script src="../../../test-session-grouping.js"></script>

<!-- Error Fixes Validation Script -->
<script src="../../../test-error-fixes.js"></script>

<!-- jQuery/mCustomScrollbar Conflict Fix for Session Grouping -->
<script>
$(document).ready(function() {
    // Ensure jQuery load method is properly protected
    if (typeof $.fn.load.original === 'undefined') {
        var originalLoad = $.fn.load;
        $.fn.load = function(url, params, callback) {
            // If url is not a string or is undefined, skip the load operation
            if (typeof url !== 'string' || !url) {
                console.warn('jQuery load called with invalid URL, skipping mCustomScrollbar conflict:', url);
                return this;
            }
            
            // If url doesn't contain indexOf method, it's not a proper URL string
            if (!url.indexOf) {
                console.warn('jQuery load called with non-string URL, skipping mCustomScrollbar conflict:', typeof url, url);
                return this;
            }
            
            // Call original load method with validated parameters
            return originalLoad.call(this, url, params, callback);
        };
        $.fn.load.original = originalLoad;
        console.log('Session Grouping jQuery/mCustomScrollbar conflict fix applied');
    }
});
</script>
